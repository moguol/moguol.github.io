<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" RedisCluster | Hexo " />
	<meta name="twitter:title" content=" RedisCluster | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" RedisCluster | Hexo ">
	<meta property="og:description" content=" RedisCluster | Hexo " />
	<meta name="twitter:description" content=" RedisCluster | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2018/12/05/redis-cluster/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2018-12-05">2018-12-05</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/OPS/">OPS</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2018/12/05/redis-cluster/" itemprop="url"><span itemprop="name">RedisCluster</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
                    <!-- Table of Contents -->
                    
                    <div id="toc" class="toc-article">
                        <strong class="toc-title">目录</strong>
                        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础概念"><span class="toc-number">1.</span> <span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Slot"><span class="toc-number">1.1.</span> <span class="toc-text">Slot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Gossip协议"><span class="toc-number">1.2.</span> <span class="toc-text">Gossip协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Failover机制"><span class="toc-number">1.3.</span> <span class="toc-text">Failover机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#系统参数优化"><span class="toc-number">2.1.</span> <span class="toc-text">系统参数优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#依赖"><span class="toc-number">2.2.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ruby"><span class="toc-number">2.3.</span> <span class="toc-text">ruby</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rubygems"><span class="toc-number">2.4.</span> <span class="toc-text">rubygems</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-gem"><span class="toc-number">2.5.</span> <span class="toc-text">redis.gem</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tcl"><span class="toc-number">2.6.</span> <span class="toc-text">tcl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-4-0-11"><span class="toc-number">2.7.</span> <span class="toc-text">redis-4.0.11</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-number">3.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群"><span class="toc-number">4.</span> <span class="toc-text">集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动redis实例"><span class="toc-number">4.1.</span> <span class="toc-text">启动redis实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建redis-cluster"><span class="toc-number">4.2.</span> <span class="toc-text">创建redis cluster</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用管理命令"><span class="toc-number">5.</span> <span class="toc-text">常用管理命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cluster-cmd"><span class="toc-number">5.1.</span> <span class="toc-text">cluster cmd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-trib-rb-cmd"><span class="toc-number">5.2.</span> <span class="toc-text">redis-trib.rb cmd</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-工具"><span class="toc-number">6.</span> <span class="toc-text">Redis 工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RedisCluster-测试"><span class="toc-number">7.</span> <span class="toc-text">RedisCluster 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#标准化规范"><span class="toc-number">8.</span> <span class="toc-text">标准化规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#附录"><span class="toc-number">9.</span> <span class="toc-text">附录</span></a></li></ol>
                    </div>
                    

					<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a><strong>基础概念</strong></h3><h4 id="Slot"><a href="#Slot" class="headerlink" title="Slot"></a><strong>Slot</strong></h4><p>RedisCluster将key分成<strong>16384</strong>个slot。key和slot的映射关系如下: (CRC16是一种冗余码校验和，可将字符串转换成16位的数字)</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slot = CRC16(key) mod <span class="number">16384</span></span><br></pre></td></tr></table></figure>
<p>因为有slot的存在，所以multi-key操作(scan/mget/keys…)无法支持。为此RedisCluster提供<strong><code>hash tags</code></strong>，用于确保多个key能被分配到同一个slot中，并可支持multi-key操作。但<code>hash tags</code>容易引起数据倾斜，需谨慎。直接在key前加入<strong><code>{hash_tag}</code></strong>即可，如：<code>{foo}student</code></p>
<h4 id="Gossip协议"><a href="#Gossip协议" class="headerlink" title="Gossip协议"></a><strong>Gossip协议</strong></h4><p>RedisCluster通过gossip协议，实现集群间状态同步更新、选举自助failover等重要的集群功能。</p>
<p>gossip协议包含多种消息：(RedisCluster使用<code>redis_port+10000</code>端口作为node间通信端口)</p>
<ul>
<li><code>meet</code>: 某个节点发送meet给新加入的节点，让新节点加入集群中，然后新节点就会开始与其他节点进行通信</li>
<li><code>ping</code>: 每个节点都会频繁给其他节点发送ping，其中包含自己的状态还有自己维护的集群元数据，互相通过ping交换元数据</li>
<li><code>pong</code>: 应答ping和meet，包含自己的状态和其他信息，也可以用于信息广播和更新</li>
<li><code>fail</code>: 某个节点判断另一个节点fail之后，就发送fail给其他节点，通知其他节点，指定的节点宕机了s</li>
</ul>
<h4 id="Failover机制"><a href="#Failover机制" class="headerlink" title="Failover机制"></a><strong>Failover机制</strong></h4><p>failover是RedisCluster提供的容错机制，failover支持两种方式：</p>
<ul>
<li>故障failover: 自动恢复集群可用性</li>
<li>人为failover: 手动操作恢复集群可用性</li>
</ul>
<p>fail探测：</p>
<ul>
<li>node在<code>node timeout</code>时间内没有响应PING请求，则被标记为 <code>PFAIL</code></li>
<li><code>PFAIL</code>标记随着gossip传播</li>
<li>过半node都标记<code>PFAIL</code>，则更改node状态为<code>FAIL</code>并广播消息</li>
</ul>
<p>故障failover过程：</p>
<ul>
<li>slave探测到master为<code>FAIL</code></li>
<li>slave将记录的<code>currentEpoch + 1</code>，并广播<code>Failover Request</code>消息</li>
<li>所有node接收到广播消息，只有master能响应，判断合法性，合法则发送<code>FAILOVER_AUTH_ACK</code></li>
<li>slave收集<code>FAILOVER_AUTH_ACK</code>消息，过半同意则升级为master</li>
<li>成功升级为master后通过PONG消息通知所有node</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><h4 id="系统参数优化"><a href="#系统参数优化" class="headerlink" title="系统参数优化"></a><strong>系统参数优化</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm.overcommit_memory=<span class="number">1</span></span><br><span class="line"><span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br></pre></td></tr></table></figure>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a><strong>依赖</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install zlib zlib-devel openssl openssl-devel gcc gcc-c++</span><br></pre></td></tr></table></figure>
<h4 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a><strong>ruby</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget -O ruby-<span class="number">2.4</span>.<span class="number">4</span>.tar.gz <span class="string">'https://cache.ruby-lang.org/pub/ruby/2.4/ruby-2.4.4.tar.gz'</span> --no-check-certificate</span><br><span class="line">tar -zxf ruby-<span class="number">2.4</span>.<span class="number">4</span>.tar.gz &amp;&amp; <span class="built_in">cd</span> ruby-<span class="number">2.4</span>.<span class="number">4</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/ruby</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=/usr/local/redis-cluster/bin:/usr/local/tcl/bin:/usr/local/rubygems/bin:/usr/local/ruby/bin:$PATH'</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ruby -v</span><br><span class="line">ruby <span class="number">2.4</span>.<span class="number">4</span>p296 (<span class="number">2018</span>-<span class="number">03</span>-<span class="number">28</span> revision <span class="number">63013</span>) [x86_64-linux]</span><br></pre></td></tr></table></figure>
<h4 id="rubygems"><a href="#rubygems" class="headerlink" title="rubygems"></a><strong>rubygems</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -O rubygems-<span class="number">2.7</span>.<span class="number">6</span>.tgz <span class="string">'https://rubygems.org/rubygems/rubygems-2.7.6.tgz'</span> --no-check-certificate</span><br><span class="line">tar -zxf rubygems-<span class="number">2.7</span>.<span class="number">6</span>.tgz</span><br><span class="line">mv rubygems-<span class="number">2.7</span>.<span class="number">6</span> /usr/<span class="built_in">local</span>/rubygems</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/rubygems &amp;&amp; ruby setup.rb</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem -v</span><br><span class="line"><span class="number">2.7</span>.<span class="number">6</span></span><br></pre></td></tr></table></figure>
<h4 id="redis-gem"><a href="#redis-gem" class="headerlink" title="redis.gem"></a><strong>redis.gem</strong></h4><p><strong>redis-4.x.x.gem 有bug！不能进行扩容/缩容<code>reshard|rebalance</code>, 报错<code>Syntax error ,try CLIENT (LIST|KILL|GETNAME|SETNAME|PAUSE|REPLY)</code></strong></p>
<p><strong>安装redis-3.x.x.gem版本可调用<code>reshard|rebalance</code>但不支持密码，不适用于有密码验证的集群</strong></p>
<ul>
<li><p>4.x.x 版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O redis-<span class="number">4.0</span>.<span class="number">2</span>.gem <span class="string">'https://rubygems.org/downloads/redis-4.0.2.gem'</span> --no-check-certificate</span><br><span class="line">gem install <span class="operator">-l</span> redis-<span class="number">4.0</span>.<span class="number">2</span>.gem</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gem list redis</span><br><span class="line"></span><br><span class="line">*** LOCAL GEMS ***</span><br><span class="line"></span><br><span class="line">redis (<span class="number">4.0</span>.<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.x.x 版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gem uninstall redis --version 4.0.2</span></span><br><span class="line">wget -O redis-<span class="number">3.3</span>.<span class="number">3</span>.gem <span class="string">'https://rubygems.org/downloads/redis-3.3.3.gem'</span> --no-check-certificate</span><br><span class="line">gem install <span class="operator">-l</span> redis-<span class="number">3.3</span>.<span class="number">3</span>.gem</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="tcl"><a href="#tcl" class="headerlink" title="tcl"></a><strong>tcl</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget -O tcl868-src.zip <span class="string">'https://jaist.dl.sourceforge.net/project/tcl/Tcl/8.6.8/tcl868-src.zip'</span> --no-check-certificate</span><br><span class="line">unzip tcl868-src.zip &amp;&amp; <span class="built_in">cd</span> tcl8.<span class="number">6.8</span>/unix</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/tcl</span><br><span class="line">make &amp;&amp; make install &amp;&amp; make install-private-headers</span><br><span class="line">ln <span class="operator">-s</span> /usr/<span class="built_in">local</span>/tcl/bin/tclsh8.<span class="number">6</span> /usr/<span class="built_in">local</span>/tcl/bin/tclsh</span><br></pre></td></tr></table></figure>
<h4 id="redis-4-0-11"><a href="#redis-4-0-11" class="headerlink" title="redis-4.0.11"></a><strong>redis-4.0.11</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget -O redis-<span class="number">4.0</span>.<span class="number">11</span>.tar.gz <span class="string">'http://download.redis.io/releases/redis-4.0.11.tar.gz'</span></span><br><span class="line">tar -zxf redis-<span class="number">4.0</span>.<span class="number">11</span>.tar.gz &amp;&amp; <span class="built_in">cd</span> redis-<span class="number">4.0</span>.<span class="number">11</span></span><br><span class="line">make &amp;&amp; make PREFIX=/usr/<span class="built_in">local</span>/redis-cluster install</span><br><span class="line">cp src/redis-trib.rb /usr/<span class="built_in">local</span>/redis-cluster/bin</span><br><span class="line">chown -R redis:redis /usr/<span class="built_in">local</span>/redis-cluster</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a><strong>配置</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - redis -c <span class="string">"mkdir -p /usr/local/redis-cluster/conf /data/logs/redis/ /data/redis/&#123;8000,8001,8002&#125;"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/local/redis-cluster/redis.conf</span></span><br><span class="line"><span class="built_in">bind</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">protected-mode no</span><br><span class="line">port <span class="number">6379</span></span><br><span class="line">tcp-backlog <span class="number">511</span></span><br><span class="line">timeout <span class="number">300</span></span><br><span class="line">tcp-keepalive <span class="number">300</span></span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile nodes.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile nodes.log</span><br><span class="line">databases <span class="number">16</span></span><br><span class="line">always-show-logo yes</span><br><span class="line">save <span class="string">""</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir ./</span><br><span class="line">masterauth <span class="string">"&lt;password&gt;"</span></span><br><span class="line">requirepass <span class="string">"&lt;password&gt;"</span></span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay <span class="number">5</span></span><br><span class="line">repl-timeout <span class="number">120</span></span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">repl-backlog-size <span class="number">100</span>mb</span><br><span class="line">slave-priority <span class="number">100</span></span><br><span class="line">rename-command flushdb rflushdb</span><br><span class="line">rename-command flushall rflushall</span><br><span class="line">rename-command keys rkeys</span><br><span class="line">rename-command shutdown rshutdown</span><br><span class="line">rename-command config rconfig</span><br><span class="line">rename-command slaveof rslaveof</span><br><span class="line">rename-command sync rsync</span><br><span class="line">rename-command monitor rmonitor</span><br><span class="line">rename-command save rsave</span><br><span class="line">rename-command bgsave rbgsave</span><br><span class="line">rename-command bgrewriteaof rbgrewriteaof</span><br><span class="line">maxmemory <span class="number">5</span>gb</span><br><span class="line"><span class="comment">#maxclients 10000</span></span><br><span class="line">maxmemory-policy volatile-lru</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">slave-lazy-flush no</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync no</span><br><span class="line">no-appendfsync-on-rewrite yes</span><br><span class="line">auto-aof-rewrite-percentage <span class="number">100</span></span><br><span class="line">auto-aof-rewrite-min-size <span class="number">1</span>gb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit <span class="number">5000</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout <span class="number">15000</span></span><br><span class="line">cluster-slave-validity-factor <span class="number">0</span></span><br><span class="line">cluster-migration-barrier <span class="number">1</span></span><br><span class="line">cluster-require-full-coverage no</span><br><span class="line">slowlog-log-slower-than <span class="number">10000</span></span><br><span class="line">slowlog-max-len <span class="number">10000</span></span><br><span class="line">latency-monitor-threshold <span class="number">0</span></span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries <span class="number">512</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value <span class="number">64</span></span><br><span class="line">list-max-ziplist-size -<span class="number">2</span></span><br><span class="line">list-compress-depth <span class="number">0</span></span><br><span class="line"><span class="built_in">set</span>-max-intset-entries <span class="number">512</span></span><br><span class="line">zset-max-ziplist-entries <span class="number">128</span></span><br><span class="line">zset-max-ziplist-value <span class="number">64</span></span><br><span class="line">hll-sparse-max-bytes <span class="number">3000</span></span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">client-output-buffer-limit slave <span class="number">256</span>mb <span class="number">64</span>mb <span class="number">60</span></span><br><span class="line">client-output-buffer-limit pubsub <span class="number">32</span>mb <span class="number">8</span>mb <span class="number">60</span></span><br><span class="line">hz <span class="number">10</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/local/redis-cluster/conf/8000.conf</span></span><br><span class="line">include /usr/<span class="built_in">local</span>/redis-cluster/redis.conf</span><br><span class="line">port <span class="number">8000</span></span><br><span class="line">dir <span class="string">"/data/redis/8000"</span></span><br><span class="line">logfile <span class="string">"/data/logs/redis/8000.log"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/local/redis-cluster/conf/8001.conf</span></span><br><span class="line">include /usr/<span class="built_in">local</span>/redis-cluster/redis.conf</span><br><span class="line">port <span class="number">8001</span></span><br><span class="line">dir <span class="string">"/data/redis/8001"</span></span><br><span class="line">logfile <span class="string">"/data/logs/redis/redis_8001.log"</span></span><br></pre></td></tr></table></figure>
<h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a><strong>集群</strong></h3><h4 id="启动redis实例"><a href="#启动redis实例" class="headerlink" title="启动redis实例"></a><strong>启动redis实例</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">su - redis -c <span class="string">"/usr/local/redis-cluster/bin/redis-server /usr/local/redis-cluster/conf/8000.conf"</span></span><br><span class="line">su - redis -c <span class="string">"/usr/local/redis-cluster/bin/redis-server /usr/local/redis-cluster/conf/8001.conf"</span></span><br><span class="line">su - redis -c <span class="string">"/usr/local/redis-cluster/bin/redis-server /usr/local/redis-cluster/conf/8002.conf"</span></span><br><span class="line">su - redis -c <span class="string">"/usr/local/redis-cluster/bin/redis-server /usr/local/redis-cluster/conf/8003.conf"</span></span><br></pre></td></tr></table></figure>
<h4 id="创建redis-cluster"><a href="#创建redis-cluster" class="headerlink" title="创建redis cluster"></a><strong>创建redis cluster</strong></h4><ul>
<li><p>iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport <span class="number">8000</span>:<span class="number">8006</span> -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport <span class="number">18000</span>:<span class="number">18006</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改:password</span></span><br><span class="line">/usr/<span class="built_in">local</span>/ruby/lib/ruby/gems/<span class="number">2.4</span>.<span class="number">0</span>/gems/redis-<span class="number">4.0</span>.<span class="number">2</span>/lib/redis/client.rb</span><br><span class="line"><span class="comment">#/usr/local/ruby/lib/ruby/gems/2.4.0/gems/redis-3.3.3/lib/redis/client.rb</span></span><br><span class="line"></span><br><span class="line">    DEFAULTS = &#123;</span><br><span class="line">      :url =&gt; lambda &#123; ENV[<span class="string">"REDIS_URL"</span>] &#125;,</span><br><span class="line">      :scheme =&gt; <span class="string">"redis"</span>,</span><br><span class="line">      :host =&gt; <span class="string">"127.0.0.1"</span>,</span><br><span class="line">      :port =&gt; <span class="number">6379</span>,</span><br><span class="line">      :path =&gt; nil,</span><br><span class="line">      :timeout =&gt; <span class="number">5.0</span>,</span><br><span class="line">      :password =&gt; nil,		<span class="comment">#修改此处</span></span><br><span class="line">      :db =&gt; <span class="number">0</span>,</span><br><span class="line">      :driver =&gt; nil,</span><br><span class="line">      :id =&gt; nil,</span><br><span class="line">      :tcp_keepalive =&gt; <span class="number">0</span>,</span><br><span class="line">      :reconnect_attempts =&gt; <span class="number">1</span>,</span><br><span class="line">      :inherit_socket =&gt; <span class="literal">false</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建集群</p>
<ul>
<li><p>自动分配主从角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create --replicas <span class="number">1</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span> <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span> <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8004</span> <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8005</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>手动分配主从角色</p>
<ul>
<li><p>创建master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on <span class="number">3</span> nodes...</span><br><span class="line">Using <span class="number">3</span> masters:</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br><span class="line">M: <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">M: <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">M: a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>)</span><br><span class="line">M: <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建slave</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加slave：将192.168.1.181:8003加入到192.168.1.180:8000集群中，并且作为指定&lt;node_id&gt;的slave</span></span><br><span class="line">redis-trib.rb add-node --slave --master-id <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Adding node <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span> to cluster <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>)</span><br><span class="line">M: <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">M: a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">0</span> additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br><span class="line">&gt;&gt;&gt; Send CLUSTER MEET to node <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span> to make it join the cluster.</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join...</span><br><span class="line">&gt;&gt;&gt; Configure node as replica of <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>.</span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb add-node --slave --master-id <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8004</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line"></span><br><span class="line">redis-trib.rb add-node --slave --master-id a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8005</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看集群信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb check <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>)M: <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line">   slots:<span class="number">0</span>-<span class="number">5460</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: dea85bf87e560b6a5074f60965b8ad334bfeb5e8 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8004</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631</span><br><span class="line">M: a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br><span class="line">   slots:<span class="number">10923</span>-<span class="number">16383</span> (<span class="number">5461</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">M: <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span></span><br><span class="line">   slots:<span class="number">5461</span>-<span class="number">10922</span> (<span class="number">5462</span> slots) master</span><br><span class="line">   <span class="number">1</span> additional replica(s)</span><br><span class="line">S: <span class="number">6</span>f12a4c4e1c60f435f68fbce1b72dc60ac73de83 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8005</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates a923e10183ef356bcadc1566503be4ab1ea1adb6</span><br><span class="line">S: <span class="number">74</span>bfaa76306dd6bc59e559d012203ceed2a8ab24 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span></span><br><span class="line">   slots: (<span class="number">0</span> slots) slave</span><br><span class="line">   replicates <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All <span class="number">16384</span> slots covered.</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>&gt; CLUSTER NODES</span><br><span class="line">dea85bf87e560b6a5074f60965b8ad334bfeb5e8 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8004</span>@<span class="number">18004</span> slave <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">0</span> <span class="number">1541155161000</span> <span class="number">2</span> connected</span><br><span class="line"><span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>@<span class="number">18000</span> myself,master - <span class="number">0</span> <span class="number">1541155160000</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line">a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span>@<span class="number">18002</span> master - <span class="number">0</span> <span class="number">1541155162973</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line"><span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span>@<span class="number">18001</span> master - <span class="number">0</span> <span class="number">1541155160000</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line"><span class="number">6</span>f12a4c4e1c60f435f68fbce1b72dc60ac73de83 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8005</span>@<span class="number">18005</span> slave a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">0</span> <span class="number">1541155162000</span> <span class="number">3</span> connected</span><br><span class="line"><span class="number">74</span>bfaa76306dd6bc59e559d012203ceed2a8ab24 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span>@<span class="number">18003</span> slave <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">0</span> <span class="number">1541155162000</span> <span class="number">1</span> connected</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>&gt; CLUSTER INFO</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:<span class="number">16384</span></span><br><span class="line">cluster_slots_ok:<span class="number">16384</span></span><br><span class="line">cluster_slots_pfail:<span class="number">0</span></span><br><span class="line">cluster_slots_fail:<span class="number">0</span></span><br><span class="line">cluster_known_nodes:<span class="number">6</span></span><br><span class="line">cluster_size:<span class="number">3</span></span><br><span class="line">cluster_current_epoch:<span class="number">3</span></span><br><span class="line">cluster_my_epoch:<span class="number">1</span></span><br><span class="line">cluster_stats_messages_ping_sent:<span class="number">1756</span></span><br><span class="line">cluster_stats_messages_pong_sent:<span class="number">1713</span></span><br><span class="line">cluster_stats_messages_sent:<span class="number">3469</span></span><br><span class="line">cluster_stats_messages_ping_received:<span class="number">1708</span></span><br><span class="line">cluster_stats_messages_pong_received:<span class="number">1756</span></span><br><span class="line">cluster_stats_messages_meet_received:<span class="number">5</span></span><br><span class="line">cluster_stats_messages_received:<span class="number">3469</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>&gt; CLUSTER SLOTS</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) (<span class="built_in">integer</span>) <span class="number">0</span></span><br><span class="line">   <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">5460</span></span><br><span class="line">   <span class="number">3</span>) <span class="number">1</span>) <span class="string">"192.168.1.180"</span></span><br><span class="line">      <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">8000</span></span><br><span class="line">      <span class="number">3</span>) <span class="string">"673e32925e0a6f9beefac8aeaad8a397758c5e47"</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"192.168.1.181"</span></span><br><span class="line">      <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">8003</span></span><br><span class="line">      <span class="number">3</span>) <span class="string">"74bfaa76306dd6bc59e559d012203ceed2a8ab24"</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) (<span class="built_in">integer</span>) <span class="number">10923</span></span><br><span class="line">   <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">16383</span></span><br><span class="line">   <span class="number">3</span>) <span class="number">1</span>) <span class="string">"192.168.1.180"</span></span><br><span class="line">      <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">8002</span></span><br><span class="line">      <span class="number">3</span>) <span class="string">"a923e10183ef356bcadc1566503be4ab1ea1adb6"</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"192.168.1.181"</span></span><br><span class="line">      <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">8005</span></span><br><span class="line">      <span class="number">3</span>) <span class="string">"6f12a4c4e1c60f435f68fbce1b72dc60ac73de83"</span></span><br><span class="line"><span class="number">3</span>) <span class="number">1</span>) (<span class="built_in">integer</span>) <span class="number">5461</span></span><br><span class="line">   <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">10922</span></span><br><span class="line">   <span class="number">3</span>) <span class="number">1</span>) <span class="string">"192.168.1.180"</span></span><br><span class="line">      <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">8001</span></span><br><span class="line">      <span class="number">3</span>) <span class="string">"605950ea5c2214f50d5f3dddd87c80f4e7d1b631"</span></span><br><span class="line">   <span class="number">4</span>) <span class="number">1</span>) <span class="string">"192.168.1.181"</span></span><br><span class="line">      <span class="number">2</span>) (<span class="built_in">integer</span>) <span class="number">8004</span></span><br><span class="line">      <span class="number">3</span>) <span class="string">"dea85bf87e560b6a5074f60965b8ad334bfeb5e8"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb info <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> (<span class="number">673</span>e3292...) -&gt; <span class="number">1</span> keys | <span class="number">5461</span> slots | <span class="number">1</span> slaves.<span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span> (a923e101...) -&gt; <span class="number">1</span> keys | <span class="number">5461</span> slots | <span class="number">1</span> slaves.</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span> (<span class="number">605950</span>ea...) -&gt; <span class="number">1</span> keys | <span class="number">5462</span> slots | <span class="number">1</span> slaves.</span><br><span class="line">[OK] <span class="number">3</span> keys <span class="keyword">in</span> <span class="number">3</span> masters.</span><br><span class="line"><span class="number">0.00</span> keys per slot on average.</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="常用管理命令"><a href="#常用管理命令" class="headerlink" title="常用管理命令"></a><strong>常用管理命令</strong></h3><h4 id="cluster-cmd"><a href="#cluster-cmd" class="headerlink" title="cluster cmd"></a><strong>cluster cmd</strong></h4><ul>
<li><p>原生redis cluster命令集</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//cluster</span><br><span class="line">CLUSTER INFO 打印集群的信息</span><br><span class="line">CLUSTER NODES 列出集群当前已知的所有节点（node），以及这些节点的相关信息。</span><br><span class="line">//node</span><br><span class="line">CLUSTER MEET &lt;ip&gt; &lt;port&gt; 将 ip 和 port 所指定的节点添加到集群当中，让它成为集群的一份子。</span><br><span class="line">CLUSTER FORGET &lt;node_id&gt; 从集群中移除 node_id 指定的节点。</span><br><span class="line">CLUSTER REPLICATE &lt;node_id&gt; 将当前节点设置为 node_id 主节点的从节点。</span><br><span class="line">CLUSTER SAVECONFIG 将节点的配置文件保存到硬盘里面。</span><br><span class="line">//slot</span><br><span class="line">CLUSTER ADDSLOTS &lt;slot&gt; [slot ...] 将一个或多个槽（slot）指派（assign）给当前节点。</span><br><span class="line">CLUSTER DELSLOTS &lt;slot&gt; [slot ...] 移除一个或多个槽对当前节点的指派。</span><br><span class="line">CLUSTER FLUSHSLOTS 移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点。</span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; NODE &lt;node_id&gt; 将槽 slot 指派给 node_id 指定的节点。</span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;node_id&gt; 将本节点的槽 slot 迁移到 node_id 指定的节点中。</span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;node_id&gt; 从 node_id 指定的节点中导入槽 slot 到本节点。</span><br><span class="line">CLUSTER SETSLOT &lt;slot&gt; STABLE 取消对槽 slot 的导入（import）或者迁移（migrate）。</span><br><span class="line">//key</span><br><span class="line">CLUSTER KEYSLOT &lt;key&gt; 计算键 key 应该被放置在哪个槽上。</span><br><span class="line">CLUSTER COUNTKEYSINSLOT &lt;slot&gt; 返回槽 slot 目前包含的键值对数量。</span><br><span class="line">CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; 返回 count 个 slot 槽中的键。</span><br><span class="line">//新增</span><br><span class="line">CLUSTER SLAVES node-id 返回一个master节点的slaves 列表</span><br></pre></td></tr></table></figure>
</li>
<li><p>更改slave隶属master</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录需要修改的slave</span></span><br><span class="line">redis-cli -c -h <span class="number">192.168</span>.<span class="number">1.181</span> -p <span class="number">8006</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调用cluster命令修改隶属master</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8006</span>&gt; CLUSTER REPLICATE &lt;new_master_id&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动缩容master(迁移slot)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">&gt; CLUSTER NODES</span><br><span class="line"><span class="number">74</span>bfaa76306dd6bc59e559d012203ceed2a8ab24 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span>@<span class="number">18003</span> slave a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">0</span> <span class="number">1542794664779</span> <span class="number">3</span> connected</span><br><span class="line">d976e1cc897744d5e5c2a0f754662c9d2a7cc077 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8006</span>@<span class="number">18006</span> myself,master - <span class="number">0</span> <span class="number">1542794660000</span> <span class="number">12</span> connected <span class="number">5461</span>-<span class="number">5558</span> <span class="number">10923</span>-<span class="number">10950</span></span><br><span class="line">a923e10183ef356bcadc1566503be4ab1ea1adb6 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span>@<span class="number">18002</span> master - <span class="number">0</span> <span class="number">1542794663778</span> <span class="number">3</span> connected <span class="number">10951</span>-<span class="number">16383</span></span><br><span class="line">dea85bf87e560b6a5074f60965b8ad334bfeb5e8 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8004</span>@<span class="number">18004</span> slave <span class="number">6</span>f12a4c4e1c60f435f68fbce1b72dc60ac73de83 <span class="number">0</span> <span class="number">1542794661000</span> <span class="number">11</span> connected</span><br><span class="line"><span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span>@<span class="number">18001</span> master - <span class="number">0</span> <span class="number">1542794664000</span> <span class="number">10</span> connected <span class="number">5559</span>-<span class="number">10922</span></span><br><span class="line"><span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span>@<span class="number">18000</span> slave <span class="number">605950</span>ea5c2214f50d5f3dddd87c80f4e7d1b631 <span class="number">0</span> <span class="number">1542794664000</span> <span class="number">10</span> connected</span><br><span class="line"><span class="number">6</span>f12a4c4e1c60f435f68fbce1b72dc60ac73de83 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8005</span>@<span class="number">18005</span> master - <span class="number">0</span> <span class="number">1542794665780</span> <span class="number">11</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line"></span><br><span class="line">将<span class="number">8006</span>迁移到<span class="number">8001</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 迁移步骤说明</span></span><br><span class="line">&gt; 在迁移目的节点执行cluster setslot &lt;slot&gt; IMPORTING &lt;<span class="built_in">source</span> node ID&gt;命令，指明需要迁移的slot和迁移源节点。</span><br><span class="line">&gt; 在迁移源节点执行cluster setslot &lt;slot&gt; MIGRATING &lt;node ID&gt;命令，指明需要迁移的slot和迁移目的节点。</span><br><span class="line">&gt; 在迁移源节点执行cluster getkeysinslot获取该slot的key列表。</span><br><span class="line">&gt; 在迁移源节点执行对每个key执行migrate命令，该命令会同步把该key迁移到目的节点。</span><br><span class="line">&gt; 在迁移源节点反复执行cluster getkeysinslot命令，直到该slot的列表为空。</span><br><span class="line">&gt; 在迁移源节点和目的节点执行cluster setslot &lt;slot&gt; NODE &lt;target node ID&gt;，完成迁移操作。</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用脚本进行迁移slot</span></span><br><span class="line">migrate_slot.sh <span class="number">192.168</span>.<span class="number">1.181</span> <span class="number">8006</span> <span class="number">192.168</span>.<span class="number">1.180</span> <span class="number">8001</span> <span class="number">5461</span> <span class="number">5558</span> <span class="string">"&lt;redis_password&gt;"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="redis-trib-rb-cmd"><a href="#redis-trib-rb-cmd" class="headerlink" title="redis-trib.rb cmd"></a><strong>redis-trib.rb cmd</strong></h4><p>官方redis cluster集群管理工具命令集</p>
<ul>
<li><p>创建集群<code>redis-trib.rb create</code></p>
<ul>
<li><p>只创建master节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create &lt;master1 ip:port&gt; &lt;master2 ip:port&gt; &lt;master3 ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb create <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>自动分配master/slave节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb create --replicas <span class="number">1</span> &lt;redis1 ip:port&gt; &lt;redis2 ip:port&gt; &lt;redis3 ip:port&gt; &lt;redis4 ip:port&gt; &lt;redis5 ip:port&gt; &lt;redis6 ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb create --replicas <span class="number">1</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8001</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8002</span> <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8003</span> <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8004</span> <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8005</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>检查集群<code>redis-trib.rb check</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb check &lt;redis ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb check <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看集群信息<code>redis-trib.rb info</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb info &lt;redis ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb info <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修复集群<code>redis-trib.rb fix</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb fix &lt;redis ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb fix <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>新增节点<code>redis-trib.rb add-node</code></p>
<ul>
<li><p>加入master节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb add-node &lt;new master ip:port&gt; &lt;one of cluster ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb add-node <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8006</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>加入slave节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将&lt;new slave ip:port&gt;节点加入集群，并作为&lt;master_id&gt;节点的slave</span></span><br><span class="line">redis-trib.rb add-node --slave --master-id &lt;master node id&gt; &lt;new slave ip:port&gt; &lt;one of cluster ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb add-node --slave --master-id <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 <span class="number">192.168</span>.<span class="number">1.181</span>:<span class="number">8007</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>删除节点<code>redis-trib.rb del-node</code></p>
<p><strong><code>redis-trib.rb del-node</code>只能删除没有分配slot的节点</strong> (slave or 空master)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb del-node &lt;one of cluster ip:port&gt; &lt;delete node id&gt;</span><br><span class="line">e.g. redis-trib.rb del-node <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> <span class="number">6</span>f12a4c4e1c60f435f68fbce1b72dc60ac73de83</span><br></pre></td></tr></table></figure>
</li>
<li><p>在线迁移slot<code>redis-trib.rb reshard</code></p>
<p><strong>redis-4.x.x.gem 有bug！不能进行扩容/缩容<code>reshard|rebalance</code>, 报错<code>Syntax error ,try CLIENT (LIST|KILL|GETNAME|SETNAME|PAUSE|REPLY)</code></strong></p>
<p><strong>安装redis-3.x.x.gem版本可调用<code>reshard|rebalance</code>但不支持密码，不适用于有密码验证的集群</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 交互式</span></span><br><span class="line">redis-trib.rb reshard &lt;one of cluster ip:port&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非交互式</span></span><br><span class="line">redis-trib.rb reshard --from &lt;all|node1_id,node2_id,node3_id&gt; --to &lt;dest node_id&gt; --slots &lt;numbers of slots&gt; &lt;one of cluster ip:port&gt;</span><br><span class="line">e.g. redis-trib.rb reshard --from all --to <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 --slots <span class="number">5461</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line">e.g. redis-trib.rb reshard --from <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47,a923e10183ef356bcadc1566503be4ab1ea1adb6 --to <span class="number">673</span>e32925e0a6f9beefac8aeaad8a397758c5e47 --slots <span class="number">5461</span> <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>平衡slot<code>redis-trib.rb rebalance</code></p>
<p><strong>redis-4.x.x.gem 有bug！不能进行扩容/缩容<code>reshard|rebalance</code>, 报错<code>Syntax error ,try CLIENT (LIST|KILL|GETNAME|SETNAME|PAUSE|REPLY)</code></strong></p>
<p><strong>安装redis-3.x.x.gem版本可调用<code>reshard|rebalance</code>但不支持密码，不适用于有密码验证的集群</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单平衡所有节点</span></span><br><span class="line">redis-trib.rb rebalance <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br><span class="line"><span class="comment"># 复杂平衡</span></span><br><span class="line">redis-trib.rb rebalance --threshold <span class="number">1</span> --weight b31e3a2e=<span class="number">5</span> --weight <span class="number">60</span>b8e3a1=<span class="number">5</span> --use-empty-masters  --simulate <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置node间心跳超时时间<code>redis-trib.rb set-timeout</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb <span class="built_in">set</span>-timeout &lt;one of cluster ip:port&gt; &lt;timeout&gt;</span><br><span class="line">e.g. redis-trib.rb <span class="built_in">set</span>-timeout <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> <span class="number">30000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>集群所有node执行命令<code>redis-trib.rb call</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb call &lt;one of cluster ip:port&gt; &lt;redis <span class="built_in">command</span>&gt;</span><br><span class="line">e.g. redis-trib.rb call <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> get key</span><br><span class="line">e.g. redis-trib.rb call <span class="number">192.168</span>.<span class="number">1.180</span>:<span class="number">8000</span> rconfig rewrite</span><br><span class="line"></span><br><span class="line">redis-trib.rb call <span class="number">10.10</span>.<span class="number">10.171</span>:<span class="number">7004</span> rconfig <span class="built_in">set</span> masterauth <span class="string">"bincentTO*TOredis"</span></span><br><span class="line">redis-trib.rb call <span class="number">10.10</span>.<span class="number">10.171</span>:<span class="number">7004</span> rconfig <span class="built_in">set</span> requirepass <span class="string">"bincentTO*TOredis"</span></span><br><span class="line">redis-trib.rb call <span class="number">10.10</span>.<span class="number">10.171</span>:<span class="number">7004</span> rconfig rewrite</span><br></pre></td></tr></table></figure>
</li>
<li><p>导入数据<code>redis-trib.rb import</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-trib.rb import --from &lt;<span class="built_in">source</span> ip:port&gt; &lt;one of cluster ip:port&gt;</span><br><span class="line"><span class="comment"># --copy  选项可以保存旧redis上的key</span></span><br><span class="line"><span class="comment"># --replace  选项可以替换集群中相同名称的key，如果不使用，此类key不会被导入</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Redis-工具"><a href="#Redis-工具" class="headerlink" title="Redis 工具"></a><strong>Redis 工具</strong></h3><p><a href="https://github.com/facebookarchive/redis-faina" target="_blank" rel="external">redis-faina</a>: 分析hot key和top commands。需要注意的是，此脚本使用<code>monitor</code>命令进行分析</p>
<p><a href="https://github.com/sripathikrishnan/redis-rdb-tools" target="_blank" rel="external">redis-rdb-tools</a>: 通过RDB文件全量分析bigkey。redis原本支持查询bigkey<code>redis-cli  --bigkeys</code></p>
<h3 id="RedisCluster-测试"><a href="#RedisCluster-测试" class="headerlink" title="RedisCluster 测试"></a><strong>RedisCluster 测试</strong></h3><table>
<thead>
<tr>
<th>模拟场景</th>
<th>是否达到预期</th>
<th>业务功能是否受损预期</th>
<th>结论</th>
</tr>
</thead>
<tbody>
<tr>
<td>宕1个slave</td>
<td>是 (耗时15s自动故障迁移)</td>
<td>业务不受损</td>
<td>当master无slave时，若有冗余slave，会自动进行切换，不影响集群功能。<strong>15s由cluster-node-timeout参数决定</strong></td>
</tr>
<tr>
<td>宕2个slave</td>
<td>是</td>
<td>业务不受损</td>
<td>master无slave不影响集群功能，slave宕机不影响集群功能</td>
</tr>
<tr>
<td>宕3个slave</td>
<td>是</td>
<td>业务不受损</td>
<td>master无slave不影响集群功能，slave宕机不影响集群功能</td>
</tr>
<tr>
<td>宕1个master</td>
<td>是 (耗时15s自动slave切换master)</td>
<td>业务受影响15s</td>
<td>slave自动切换成master期间(15s)，宕掉的master对应的slot不可用，所有对此slot的操作皆会受影响，由于设置cluster-require-full-coverage=no，没宕的2个master可正常提供服务。<strong>15s由cluster-node-timeout参数决定</strong></td>
</tr>
<tr>
<td>宕2个master</td>
<td>FAILOVER FORCE / TAKEOVER恢复</td>
<td>业务受损</td>
<td>集群超过半数master宕，集群进入fail状态，slave不会自动切换成master，整个集群不可用。<strong>不要将多个master部署在一台机器上</strong></td>
</tr>
<tr>
<td>宕3个master</td>
<td>是</td>
<td>业务受损</td>
<td>集群所有master宕，集群进入fail状态，slave不会自动切换成master。整个集群不可用</td>
</tr>
<tr>
<td>宕1组master/slave</td>
<td>是</td>
<td>业务受影响</td>
<td>一组主从同时宕机，会导致对应宕掉master的slot无法操作，由于设置cluster-require-full-coverage=no没宕的master可正常提供服务。<strong>不要将一组主从部署在一台机器上</strong></td>
</tr>
<tr>
<td>扩容/缩容1个master</td>
<td>是</td>
<td>业务不受损</td>
<td>迁移slot，不影响对集群读写操作。由于官方工具redis-trib.rb有bug，扩容/缩容需手动迁移slot，极易误操作，建议尽量不要纯手工迁移slot，非要迁移尽量使用脚本迁移，避免纯手动迁移</td>
</tr>
</tbody>
</table>
<h3 id="标准化规范"><a href="#标准化规范" class="headerlink" title="标准化规范"></a><strong>标准化规范</strong></h3><ul>
<li>公共配置文件路径: <code>/usr/local/redis-cluster/redis.conf</code></li>
<li>实例配置文件路径: <code>/usr/local/redis-cluster/conf</code></li>
<li>配置文件命名: <code>{redis_port}.conf</code>，以redis端口命名配置文件名。(e.g., /usr/local/redis-cluster/conf/8000.conf)</li>
<li>数据存放路径: <code>/data/redis/{redis_port}</code>，以redis端口命名文件夹目录。(e.g., dir “/data/redis/8000”)</li>
<li>日志存放路径: <code>/data/logs/redis/</code></li>
<li>日志文件命名: <code>redis_{redis_port}.log</code>，以redis端口命名日志。(e.g., logfile “/data/logs/redis/redis_8000.log”)</li>
<li>端口范围: redis_port &gt; 20000</li>
</ul>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a><strong>附录</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 迁移slot脚本</span></span><br><span class="line">. /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -eu</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span>_ip=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">source</span>_port=<span class="variable">$2</span></span><br><span class="line">target_ip=<span class="variable">$3</span></span><br><span class="line">target_port=<span class="variable">$4</span></span><br><span class="line">start_slot=<span class="variable">$5</span></span><br><span class="line">end_slot=<span class="variable">$6</span></span><br><span class="line">password=<span class="variable">$7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> != <span class="number">7</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"Usage: <span class="variable">$0</span> source_ip source_port target_ip target_port start_slot end_slot password"</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在目的节点执行cluster setslot &lt;slot&gt; IMPORTING &lt;source node ID&gt;命令，指明需要迁移的slot和迁移源节点</span></span><br><span class="line"><span class="keyword">for</span> slot <span class="keyword">in</span> `seq <span class="variable">$&#123;start_slot&#125;</span> <span class="variable">$&#123;end_slot&#125;</span>`; <span class="keyword">do</span></span><br><span class="line">    redis-cli -c -h <span class="variable">$&#123;target_ip&#125;</span> -p <span class="variable">$&#123;target_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster setslot <span class="variable">$&#123;slot&#125;</span> IMPORTING `redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster nodes | grep <span class="variable">$&#123;source_ip&#125;</span> | grep <span class="variable">$&#123;source_port&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在源节点执行cluster setslot &lt;slot&gt; MIGRATING &lt;target node ID&gt;命令，指明需要迁移的slot和迁移目的节点</span></span><br><span class="line"><span class="keyword">for</span> slot <span class="keyword">in</span> `seq <span class="variable">$&#123;start_slot&#125;</span> <span class="variable">$&#123;end_slot&#125;</span>`; <span class="keyword">do</span></span><br><span class="line">    redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster setslot <span class="variable">$&#123;slot&#125;</span> MIGRATING `redis-cli -c -h <span class="variable">$&#123;target_ip&#125;</span> -p <span class="variable">$&#123;target_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster nodes | grep <span class="variable">$&#123;target_ip&#125;</span> | grep <span class="variable">$&#123;target_port&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> slot <span class="keyword">in</span> `seq <span class="variable">$&#123;start_slot&#125;</span> <span class="variable">$&#123;end_slot&#125;</span>`; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> ; <span class="keyword">do</span></span><br><span class="line">        <span class="comment">#源节点执行getkeysinslot命令，从slot中取出count(20)个键值对的key</span></span><br><span class="line">        allkeys=`redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster getkeysinslot <span class="variable">$&#123;slot&#125;</span> <span class="number">20</span>`</span><br><span class="line">        <span class="comment">#若slot中有key，则需先迁移key再迁移slot</span></span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$&#123;allkeys&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment">#slot无key</span></span><br><span class="line">            <span class="comment">#源节点和目标节点执行setslot命令，将slot分配给目标节点</span></span><br><span class="line">            redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster setslot <span class="variable">$&#123;slot&#125;</span> NODE `redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster nodes | grep <span class="variable">$&#123;target_ip&#125;</span> | grep <span class="variable">$&#123;target_port&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">            redis-cli -c -h <span class="variable">$&#123;target_ip&#125;</span> -p <span class="variable">$&#123;target_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster setslot <span class="variable">$&#123;slot&#125;</span> NODE `redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> cluster nodes | grep <span class="variable">$&#123;target_ip&#125;</span> | grep <span class="variable">$&#123;target_port&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> <span class="variable">$&#123;allkeys&#125;</span>; <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"migrate slot:<span class="variable">$&#123;slot&#125;</span> key:<span class="variable">$&#123;key&#125;</span>"</span></span><br><span class="line">                <span class="comment">#源节点执行migrate命令，将key迁移到目标节点</span></span><br><span class="line">                <span class="comment"># MIGRATE target_ip target_port key db timeout(millisecond) AUTH password</span></span><br><span class="line">                redis-cli -c -h <span class="variable">$&#123;source_ip&#125;</span> -p <span class="variable">$&#123;source_port&#125;</span> <span class="operator">-a</span> <span class="variable">$&#123;password&#125;</span> MIGRATE <span class="variable">$&#123;target_ip&#125;</span> <span class="variable">$&#123;target_port&#125;</span> <span class="variable">$&#123;key&#125;</span> <span class="number">0</span> <span class="number">5000</span> AUTH <span class="variable">$&#123;password&#125;</span></span><br><span class="line">            <span class="keyword">done</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/redis/">redis</a>

					</div>

				

			</article>

			<div class="content-nav">

				
					<a href="/2019/04/05/jaeger/" title="OpenTracing & Jaeger">&larr; Prev</a>
				

				
					<a href="/2018/10/05/prometheus/" title="Prometheus">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
