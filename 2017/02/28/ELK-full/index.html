<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" ELK+Kafka+Search-Guard+Sentinl全攻略 | Hexo " />
	<meta name="twitter:title" content=" ELK+Kafka+Search-Guard+Sentinl全攻略 | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" ELK+Kafka+Search-Guard+Sentinl全攻略 | Hexo ">
	<meta property="og:description" content=" ELK+Kafka+Search-Guard+Sentinl全攻略 | Hexo " />
	<meta name="twitter:description" content=" ELK+Kafka+Search-Guard+Sentinl全攻略 | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2017/02/28/ELK-full/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2017-02-28">2017-02-28</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/OPS/">OPS</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2017/02/28/ELK-full/" itemprop="url"><span itemprop="name">ELK+Kafka+Search-Guard+Sentinl全攻略</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
					<p>&emsp;&emsp;ELK(Elasticsearch/Logstash/Kibana)是目前对日志采集分析比较适合的解决方案；Kafka是一个分布式高可用高吞吐的消息队列软件，在日志量大及对数据可靠性要求高的场景使用；Search-Guard是一款开源的、对Elasticsearch提供安全及权限控制功能的插件；Sentinl是一款类似Watch的Kibana插件，提供监控、报警和报告功能。<br>&emsp;&emsp;这整个系统为日志的采集、存储、查询、图表分析和监控报警提供一套完整的解决方案。</p>
<h2 id="软件版本列表"><a href="#软件版本列表" class="headerlink" title="软件版本列表"></a><strong>软件版本列表</strong></h2><ul>
<li>CentOS 6.8 64bit</li>
<li>JDK1.8.0_51</li>
<li><a href="https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.4.4/elasticsearch-2.4.4.tar.gz" target="_blank" rel="external">Elasticsearch-2.4.4</a></li>
<li><a href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.2.0-x86_64.rpm" target="_blank" rel="external">Filebeat-5.2.0</a></li>
<li><a href="https://download.elastic.co/logstash/logstash/logstash-2.4.1.tar.gz" target="_blank" rel="external">Logstash-2.4.1</a></li>
<li><a href="https://download.elastic.co/kibana/kibana/kibana-4.6.4-linux-x86_64.tar.gz" target="_blank" rel="external">Kibana-4.6.4</a></li>
<li><a href="http://apache.communilink.net/kafka/0.10.0.0/kafka_2.11-0.10.0.0.tgz" target="_blank" rel="external">Kafka_2.11-0.10.0.0</a></li>
<li>Search-Guard-SSL/2.4.4.19</li>
<li>Search-Guard-2/2.4.4.10</li>
<li>Sentinl</li>
</ul>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a><strong>Kafka</strong></h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf kafka_2<span class="number">.11</span>-<span class="number">0.10</span><span class="number">.0</span><span class="number">.0</span>.tgz</span><br><span class="line">mv kafka_2<span class="number">.11</span>-<span class="number">0.10</span><span class="number">.0</span><span class="number">.0</span> /usr/local/kafka</span><br><span class="line">mkdir /data/zookeeper</span><br><span class="line">chown -R osadmin:osadmin /data/zookeeper</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a><strong>配置</strong></h3><h4 id="zookeeper配置"><a href="#zookeeper配置" class="headerlink" title="zookeeper配置"></a><strong>zookeeper配置</strong></h4><ul>
<li><p><strong>/usr/local/kafka/config/zookeeper.properties</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">initLimit=<span class="number">10</span></span><br><span class="line">syncLimit=<span class="number">5</span></span><br><span class="line">dataDir=/data/zookeeper</span><br><span class="line">clientPort=<span class="number">2181</span></span><br><span class="line">server.<span class="number">0</span>=<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server.<span class="number">1</span>=<span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置集群节点myid<br>  &emsp;根据配置文件中<strong><code>server.X</code></strong>设置集群节点的<code>myid</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> X &gt; /data/zookeeper/myid</span><br></pre></td></tr></table></figure>
</li>
<li><p>zookeeper调整JVM内存大小<br>  &emsp;zookeeper默认的JVM堆内存大小为<code>512M</code>，可视具体情况调整<br>  &emsp;<strong>/usr/local/kafka/bin/zookeeper-server-start.sh</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">"-Xmx512M -Xms512M"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动zookeeper<br>  &emsp;手动启动zookeeper(更好的方式是使用<strong>Supervisord</strong>来管理)</p>
  <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup <span class="regexp">/usr/</span>local<span class="regexp">/kafka/</span>bin<span class="regexp">/zookeeper-server-start.sh /u</span>sr<span class="regexp">/local/</span>kafka<span class="regexp">/config/</span>zookeeper.properties &amp;&gt; <span class="regexp">/usr/</span>local<span class="regexp">/kafka/</span>logs<span class="regexp">/zookeeper.log &amp;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Kafka配置"><a href="#Kafka配置" class="headerlink" title="Kafka配置"></a><strong>Kafka配置</strong></h4><ul>
<li><p><strong>/usr/local/kafka/config/server.properties</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#id唯一</span></span><br><span class="line">broker.id=<span class="number">0</span></span><br><span class="line">port=<span class="number">9092</span></span><br><span class="line">advertised.host.name=<span class="number">10.201</span>.<span class="number">3.33</span></span><br><span class="line"><span class="comment">#host.name唯一</span></span><br><span class="line">host.name=<span class="number">10.201</span>.<span class="number">3.33</span></span><br><span class="line">num.network.threads=<span class="number">3</span></span><br><span class="line">num.io.threads=<span class="number">8</span></span><br><span class="line">socket.send.buffer.bytes=<span class="number">102400</span></span><br><span class="line">socket.receive.buffer.bytes=<span class="number">102400</span></span><br><span class="line">socket.request.max.bytes=<span class="number">104857600</span></span><br><span class="line">log.dirs=/usr/<span class="built_in">local</span>/kafka/logs</span><br><span class="line">num.partitions=<span class="number">5</span></span><br><span class="line">num.recovery.threads.per.data.dir=<span class="number">1</span></span><br><span class="line">log.retention.hours=<span class="number">72</span></span><br><span class="line">log.segment.bytes=<span class="number">1073741824</span></span><br><span class="line">log.retention.check.interval.ms=<span class="number">300000</span></span><br><span class="line">zookeeper.connect=<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span></span><br><span class="line">zookeeper.connection.timeout.ms=<span class="number">6000</span></span><br><span class="line">delete.topic.enable=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Kafka配置集群注意事项</strong></p>
<ol>
<li>echo X &gt; /data/zookeeper/myid</li>
<li>/usr/local/kafka/config/server.properties<ul>
<li>broker.id</li>
<li>host.name</li>
</ul>
</li>
</ol>
</li>
<li><p>Kafka调优项</p>
<ul>
<li><p>调整JVM内存大小<br>  &emsp;Kafka默认的JVM堆内存大小为<code>1G</code>，如果需要承载较大日志量可视具体情况调整JVM堆内存大小，建议JVM堆的内存大小最好不要超过<strong>4G</strong>。<br>  &emsp;<strong>/usr/local/kafka/bin/kafka-server-start.sh</strong></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">"-Xmx3G -Xms3G"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>线程数调整<br>  &emsp;在需要处理大量日志的场景时可调整<code>num.network.threads</code>和<code>num.io.threads</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">num.network.threads=nproc</span><br><span class="line">num.io.threads=<span class="number">2</span>*nproc</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>启动Kafka<br>  &emsp;手动启动kafka(更好的方式是使用<strong>Supervisord</strong>来管理)</p>
  <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup <span class="regexp">/usr/</span>local<span class="regexp">/kafka/</span>bin<span class="regexp">/kafka-server-start.sh /u</span>sr<span class="regexp">/local/</span>kafka<span class="regexp">/config/</span>server.properties &amp;&gt; <span class="regexp">/usr/</span>local<span class="regexp">/kafka/</span>logs<span class="regexp">/kafka.log &amp;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="kafka常用操作"><a href="#kafka常用操作" class="headerlink" title="kafka常用操作"></a><strong>kafka常用操作</strong></h4><ul>
<li><p>创建topic</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --create --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --replication-factor <span class="number">2</span> --partitions <span class="number">2</span> --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看topic</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出所有topic</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --list --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看具体topic</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --describe --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>删除topic</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --delete --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看logstash消费Kafka队列情况</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出所有consumer group</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --list</span><br><span class="line"><span class="comment">#默认所有logstash消费者在logstash的group中</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --describe --group logstash</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态增加Kafka partition<br>  &emsp;将<code>test</code>topic的partition<strong>增加到</strong><code>12</code>个</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --alter --topic <span class="built_in">test</span> --partitions <span class="number">12</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="测试Kafka"><a href="#测试Kafka" class="headerlink" title="测试Kafka"></a><strong>测试Kafka</strong></h4><ul>
<li><p>生产消息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-console-producer.sh --broker-list <span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">9092</span> --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>消费消息</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-console-consumer.sh --zookeeper  <span class="number">10.201</span>.<span class="number">3.30</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.33</span>:<span class="number">2181</span> --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a><strong>Elasticsearch</strong></h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf elasticsearch-<span class="number">2.4</span><span class="number">.4</span>.tar.gz</span><br><span class="line">mv elasticsearch-<span class="number">2.4</span><span class="number">.4</span> <span class="regexp">/usr/</span>local/elasticsearch</span><br><span class="line">mkdir <span class="regexp">/usr/</span>local<span class="regexp">/elasticsearch/</span>&#123;logs,plugins&#125; /data</span><br><span class="line">chown -R <span class="string">osadmin:</span>osadmin <span class="regexp">/usr/</span>local<span class="regexp">/elasticsearch/</span></span><br></pre></td></tr></table></figure>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a><strong>配置</strong></h3><h4 id="文件打开数配置"><a href="#文件打开数配置" class="headerlink" title="文件打开数配置"></a><strong>文件打开数配置</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n <span class="number">655350</span></span><br></pre></td></tr></table></figure>
<p>&emsp;<strong>/etc/security/limits.conf</strong><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">* </span>soft nofile 655350</span><br><span class="line"><span class="bullet">* </span>hard nofile 655350</span><br><span class="line">osadmin soft memlock unlimited</span><br><span class="line">osadmin hard memlock unlimited</span><br></pre></td></tr></table></figure></p>
<h4 id="ES集群配置"><a href="#ES集群配置" class="headerlink" title="ES集群配置"></a><strong>ES集群配置</strong></h4><p>&emsp;<strong>/usr/local/elasticsearch/config/elasticsearch.yml</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">path.data: /data</span><br><span class="line">path.logs: /usr/<span class="built_in">local</span>/elasticsearch/logs</span><br><span class="line">path.plugins: /usr/<span class="built_in">local</span>/elasticsearch/plugins</span><br><span class="line">network.host: <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">http.port: <span class="number">9200</span></span><br><span class="line">bootstrap.mlockall: <span class="literal">true</span></span><br><span class="line">indices.fielddata.cache.size: <span class="number">75</span>%</span><br><span class="line">indices.breaker.fielddata.limit: <span class="number">85</span>%</span><br><span class="line">threadpool.search.queue_size: <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Cluster</span></span><br><span class="line">cluster.name: elk-cluster</span><br><span class="line">node.name: <span class="string">"10.201.3.49"</span></span><br><span class="line">node.master: <span class="literal">true</span></span><br><span class="line">node.data: <span class="literal">true</span></span><br><span class="line">discovery.zen.ping.multicast.enabled: <span class="literal">true</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"10.201.3.49"</span>, <span class="string">"10.201.3.33"</span>, <span class="string">"10.201.3.30"</span>]</span><br><span class="line"><span class="comment">#cluster.routing.allocation.disk.threshold_enabled: false</span></span><br><span class="line"><span class="comment">#cluster.routing.allocation.disk.watermark.low: 90%</span></span><br><span class="line"><span class="comment">#cluster.routing.allocation.disk.watermark.high: 95%</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>path.data</code>：索引数据的存储路径</li>
<li><code>path.logs</code>：日志文件的存储路径</li>
<li><code>path.plugins</code>：插件安装路径</li>
<li><code>network.host</code>：监听IP</li>
<li><code>http.port</code>：监听端口</li>
<li><code>bootstrap.mlockall</code>：锁内存，使ES不使用swap</li>
<li><code>indices.fielddata.cache.size</code>：节点用于 fielddata 的最大内存(达到阀值旧数据将被交换出内存)</li>
<li><code>indices.breaker.fielddata.limit</code>：JVM 堆内存大小(确保 indices.breaker.fielddata.limit 的值大于 indices.fielddata.cache.size 的值)</li>
<li><p><code>threadpool.search.queue_size</code>：ES搜索队列大小(kibana查询量大时需要增大此值)</p>
</li>
<li><p><code>cluster.name</code>：集群名称(<code>cluster.name</code>相同的节点将自动组成一个集群)</p>
</li>
<li><code>node.name</code>：集群节点名称</li>
<li><code>node.master</code>：允许节点成为主节点</li>
<li><code>node.data</code>：允许节点存储数据</li>
<li><code>discovery.zen.ping.multicast.enabled</code>：允许组播发现节点</li>
<li><code>discovery.zen.ping.unicast.hosts</code>：集群初始节点列表(加速发现节点)</li>
</ul>
<h4 id="ES内存设置"><a href="#ES内存设置" class="headerlink" title="ES内存设置"></a><strong>ES内存设置</strong></h4><p><strong>/usr/local/elasticsearch/bin/elasticsearch.in.sh</strong><br>&emsp;内存充足情况尽量分配多内存给Elasticsearch，一般认为64bit机器最大分配内存不超过<strong>32G</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ES_MIN_MEM=<span class="number">10</span>g</span><br><span class="line">ES_MAX_MEM=<span class="number">10</span>g</span><br></pre></td></tr></table></figure></p>
<h3 id="Elasticsearch插件安装"><a href="#Elasticsearch插件安装" class="headerlink" title="Elasticsearch插件安装"></a><strong>Elasticsearch插件安装</strong></h3><ul>
<li><p><strong>head</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/elasticsearch</span><br><span class="line">/usr/local/elasticsearch/bin/plugin <span class="operator"><span class="keyword">install</span> mobz/elasticsearch-<span class="keyword">head</span></span><br><span class="line"></span><br><span class="line">#访问<span class="keyword">head</span>插件</span><br><span class="line"><span class="keyword">http</span>://<span class="number">10.201</span><span class="number">.3</span><span class="number">.49</span>:<span class="number">9200</span>/_plugin/<span class="keyword">head</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>kopf</strong></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> /usr/<span class="keyword">local</span>/elasticsearch</span><br><span class="line">/usr/<span class="keyword">local</span>/elasticsearch/bin/<span class="keyword">plugin</span> install lmenezes/elasticsearch-kopf/2.1.1</span><br><span class="line"></span><br><span class="line">#访问kopf插件</span><br><span class="line">http:<span class="comment">//10.201.3.49:9200/_plugin/kopf</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>curator</strong><br>  &emsp;&emsp;<strong>curator</strong>用于管理Elasticsearch索引</p>
<ul>
<li><p>安装</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install elasticsearch-curator==<span class="number">3.5</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看索引</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看前缀sd-3-centos33-nginx且旧于30天的索引</span></span><br><span class="line">curator --timeout <span class="number">36000</span> --host localhost show indices --older-than <span class="number">30</span> --time-unit days --timestring <span class="string">'%Y.%m.%d'</span> --prefix sd-<span class="number">3</span>-centos33-nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭索引</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭前缀sd-3-centos33-nginx且旧于30天的索引</span></span><br><span class="line">curator --timeout <span class="number">36000</span> --host localhost close indices --older-than <span class="number">30</span> --time-unit days --timestring <span class="string">'%Y.%m.%d'</span> --prefix sd-<span class="number">3</span>-centos33-nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除索引</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除前缀sd-3-centos33-nginx-的所有索引</span></span><br><span class="line">curator --timeout <span class="number">36000</span> --host localhost delete indices --time-unit days --timestring %Y.%m.%d --prefix sd-<span class="number">3</span>-centos33-nginx-</span><br></pre></td></tr></table></figure>
</li>
<li><p>配合search-guard执行方式<br>  &emsp;使用search-guard后所有对Elasticsearch的连接都强制使用HTTPS方式</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curator --http_auth &lt;user&gt;:&lt;password&gt; --use_ssl --timeout <span class="number">36000</span> --ssl-no-validate --host localhost show indices --time-unit days --timestring <span class="string">'%Y.%m.%d'</span> --prefix <span class="built_in">test</span>-nginx</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="Search-Guard"><a href="#Search-Guard" class="headerlink" title="Search-Guard"></a><strong>Search-Guard</strong></h2><p>&emsp;&emsp;Elasticsearch自身并没有认证和权限控制功能，导致安全性问题十分严重。Elasticsearch2.x的shield插件、Elasticsearch5.x的x-pack插件弥补了这个安全问题，但这两个插件都是需要付费才能长期使用的，<strong>search-guard</strong>是开源免费并能提供权限控制的插件。使用search-guard最好JDK的版本在<strong><code>1.8</code></strong>以上。</p>
<ul>
<li><a href="https://github.com/floragunncom/search-guard" target="_blank" rel="external">search-guard项目地址</a></li>
<li><a href="https://github.com/floragunncom/search-guard-docs" target="_blank" rel="external">search-guard官方文档</a></li>
</ul>
<h3 id="search-guard-ssl"><a href="#search-guard-ssl" class="headerlink" title="search-guard-ssl"></a><strong>search-guard-ssl</strong></h3><p>&emsp;&emsp;search-guard2.x版本需要依赖search-guard-ssl，search-guard-ssl需要使用<strong><code>openssl 1.0.1k</code></strong>以上版本。</p>
<h4 id="更新openssl"><a href="#更新openssl" class="headerlink" title="更新openssl"></a><strong>更新openssl</strong></h4><p>&emsp;&emsp;只需要要在使用search-guard-ssl生成证书的机器上更新openssl即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.openssl.org/<span class="built_in">source</span>/openssl-<span class="number">1.0</span>.<span class="number">1</span>k.tar.gz</span><br><span class="line">tar -zxf openssl-<span class="number">1.0</span>.<span class="number">1</span>k.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-<span class="number">1.0</span>.<span class="number">1</span>k</span><br><span class="line">./config shared zlib</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">mv /usr/bin/openssl /usr/bin/openssl.old &amp;&amp; mv /usr/include/openssl /usr/include/openssl.old</span><br><span class="line">ln <span class="operator">-s</span> /usr/<span class="built_in">local</span>/ssl/bin/openssl /usr/bin/openssl</span><br><span class="line">ln <span class="operator">-s</span> /usr/<span class="built_in">local</span>/ssl/include/openssl /usr/include/openssl</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/ssl/lib"</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line">ldconfig -v</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看openssl版本</span></span><br><span class="line">openssl version</span><br></pre></td></tr></table></figure></p>
<h4 id="安装search-guard-ssl"><a href="#安装search-guard-ssl" class="headerlink" title="安装search-guard-ssl"></a><strong>安装search-guard-ssl</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch</span><br><span class="line">bin/plugin install -b com.floragunn/search-guard-ssl/<span class="number">2.4</span>.<span class="number">4.19</span></span><br></pre></td></tr></table></figure>
<h4 id="制作HTTPS证书"><a href="#制作HTTPS证书" class="headerlink" title="制作HTTPS证书"></a><strong>制作HTTPS证书</strong></h4><p>&emsp;&emsp;search-guard强制只能使用HTTPS方式访问Elasticsearch，所以需要使用search-guard-ssl制作HTTPS的相关证书。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/floragunncom/search-guard-ssl.git</span><br><span class="line"><span class="built_in">cd</span> search-guard-ssl/example-pki-scripts/</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>制作HTTPS证书脚本<br>  &emsp;&emsp;search-guard-ssl提供制作证书相关的脚本</p>
<ul>
<li>gen_client_node_cert.sh<br>  制作客户端证书</li>
<li>gen_node_cert.sh<br>  创建节点证书</li>
<li>gen_root_ca.sh<br>  创建根证书</li>
</ul>
</li>
<li><p>修改证书信息<br>  &emsp;&emsp;根据自身情况修改<code>gen_client_node_cert.sh</code>、<code>gen_node_cert.sh</code>证书相关的<strong>dname</strong>信息(不修改<code>dname</code>相关信息也无碍)</p>
<ul>
<li><strong><code>CN</code></strong>: 公用名称</li>
<li><strong><code>OU</code></strong>: 组织单位名称</li>
<li><strong><code>O</code></strong>: 组织名称</li>
<li><strong><code>L</code></strong>: 城市名称</li>
<li><strong><code>S</code></strong>: 省份名称</li>
<li><p><strong><code>C</code></strong>: 国家名称</p>
</li>
<li><p>gen_client_node_cert.sh</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-dname <span class="string">"CN=<span class="variable">$CLIENT_NAME</span>, OU=client, O=client, L=SZ, C=CN"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>gen_node_cert.sh</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-dname <span class="string">"CN=<span class="variable">$NODE_NAME</span>, OU=test, O=test, L=SZ, C=CN"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>修改example.sh脚本相关密码<br>  &emsp;&emsp;<code>example.sh</code>是search-guard-ssl提供的样例脚本，把<strong><code>CA</code></strong>、<strong><code>TrustStore</code></strong>和<strong><code>KeyStore</code></strong>改成自己设置的密码</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> <span class="operator">-e</span></span><br><span class="line">./clean.sh</span><br><span class="line">./gen_root_ca.sh &lt;your_CA_password&gt; &lt;your_TrustStore_password&gt;</span><br><span class="line">./gen_node_cert.sh &lt;your_node_name&gt; &lt;your_KeyStore_password&gt; &lt;your_CA_password&gt;</span><br><span class="line">./gen_client_node_cert.sh admin &lt;your_KeyStore_password&gt; &lt;your_CA_password&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>拷贝证书<br>  &emsp;&emsp;将生成的证书拷贝到<strong>所有</strong>节点相应的目录下。search-guard官方推荐每个ES节点的节点证书不同，这里所有节点都是使用的同一个节点证书。</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp truststore.jks node-&lt;your_node_name&gt;-keystore.jks /usr/<span class="built_in">local</span>/elasticsearch/config/</span><br><span class="line">cp truststore.jks admin-keystore.jks /usr/<span class="built_in">local</span>/elasticsearch/plugins/search-guard-<span class="number">2</span>/sgconfig/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装search-guard"><a href="#安装search-guard" class="headerlink" title="安装search-guard"></a><strong>安装search-guard</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch</span><br><span class="line">bin/plugin install -b com.floragunn/search-guard-<span class="number">2</span>/<span class="number">2.4</span>.<span class="number">4.10</span></span><br></pre></td></tr></table></figure>
<h3 id="配置search-guard"><a href="#配置search-guard" class="headerlink" title="配置search-guard"></a><strong>配置search-guard</strong></h3><p>&emsp;&emsp;search-guard需要在Elasticsearch配置文件<strong>/usr/local/elasticsearch/config/elasticsearch.yml</strong>中新增配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#search-guard</span></span><br><span class="line">searchguard.authcz.admin_dn:</span><br><span class="line">  - CN=admin,OU=client, O=client, L=SZ, C=CN</span><br><span class="line"></span><br><span class="line"><span class="comment">#search-guard ssl</span></span><br><span class="line">searchguard.ssl.transport.keystore_filepath: node-&lt;your_node_name&gt;-keystore.jks</span><br><span class="line">searchguard.ssl.transport.keystore_password: your_KeyStore_password</span><br><span class="line">searchguard.ssl.transport.truststore_filepath: truststore.jks</span><br><span class="line">searchguard.ssl.transport.truststore_password: your_TrustStore_password</span><br><span class="line">searchguard.ssl.transport.enforce_hostname_verification: <span class="literal">false</span></span><br><span class="line"><span class="comment">#search-guard https</span></span><br><span class="line">searchguard.ssl.http.enabled: <span class="literal">true</span></span><br><span class="line">searchguard.ssl.http.keystore_filepath: node-&lt;your_node_name&gt;-keystore.jks</span><br><span class="line">searchguard.ssl.http.keystore_password: your_KeyStore_password</span><br><span class="line">searchguard.ssl.http.truststore_filepath: truststore.jks</span><br><span class="line">searchguard.ssl.http.truststore_password: your_TrustStore_password</span><br></pre></td></tr></table></figure></p>
<h3 id="search-guard权限设置"><a href="#search-guard权限设置" class="headerlink" title="search-guard权限设置"></a><strong>search-guard权限设置</strong></h3><p>&emsp;&emsp;search-guard的权限配置文件都在<strong><code>/usr/local/elasticsearch/plugins/search-guard-2/sgconfig</code></strong>目录下</p>
<ul>
<li><strong>sg_config.yml</strong><br>  主配置文件，定义认证类型等。一般不需要改动</li>
<li><strong>sg_internal_users.yml</strong><br>  本地用户文件，定义用户密码以及对应的权限(密码生成脚本：plugins/search-guard-2/tools/hash.sh)</li>
<li><strong>sg_roles_mapping.yml</strong><br>  定义角色(<code>sg_roles.yml</code>)和用户(<code>sg_internal_users.yml</code>)的映射关系</li>
<li><strong>sg_roles.yml</strong><br>  角色权限配置文件</li>
<li><strong>sg_action_groups.yml</strong><br>  定义权限别名，把多个单独的权限整合并配置别名，简化配置</li>
</ul>
<h4 id="创建用户及设置密码——sg-internal-users-yml"><a href="#创建用户及设置密码——sg-internal-users-yml" class="headerlink" title="创建用户及设置密码——sg_internal_users.yml"></a><strong>创建用户及设置密码——sg_internal_users.yml</strong></h4><p>&emsp;&emsp;创建具体的用户和密码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#管理员权限帐号</span></span><br><span class="line">admin:</span><br><span class="line">  <span class="built_in">hash</span>: <span class="variable">$2a</span><span class="variable">$12</span><span class="variable">$rVW6Elg3PUBTJIAXRZ881</span>.kWfG4OL/vTwX0ksJ8uUUGEC763J08SK</span><br><span class="line"></span><br><span class="line"><span class="comment">#kibana server帐号</span></span><br><span class="line"><span class="comment">#用于在kibana.yml中配置，该帐号用于创建和管理.kibana索引</span></span><br><span class="line">kibana_server:</span><br><span class="line">  <span class="built_in">hash</span>: <span class="variable">$2a</span><span class="variable">$12</span><span class="variable">$QrVeCyf7JFwq</span>/<span class="number">2.2</span>BjLP0O0g8C1hlHunoyxWFe57nlbJGHI/A/Wda</span><br><span class="line"></span><br><span class="line"><span class="comment">#kibana 登录帐号</span></span><br><span class="line">kibana_admin:</span><br><span class="line">  <span class="built_in">hash</span>: <span class="variable">$2a</span><span class="variable">$12</span>$.vAGeZm8FdFMIeDz8DlWqeWCO/Uiy12v6xJEbpGnhahSfSuPwbYOy</span><br><span class="line"></span><br><span class="line"><span class="comment">#logstash帐号</span></span><br><span class="line"><span class="comment">#用于在logstash中配置，允许logstash往Elasticsearch中写入数据</span></span><br><span class="line">logstash:</span><br><span class="line">  <span class="built_in">hash</span>: <span class="variable">$2a</span><span class="variable">$12</span><span class="variable">$zbVAUMH5thQvnCDKNfMLv</span>.QDsdFYdoiK3V70.tkC8tMVF8EvP0nf2</span><br></pre></td></tr></table></figure></p>
<h4 id="定义角色与用户映射关系——sg-roles-mapping-yml"><a href="#定义角色与用户映射关系——sg-roles-mapping-yml" class="headerlink" title="定义角色与用户映射关系——sg_roles_mapping.yml"></a><strong>定义角色与用户映射关系——sg_roles_mapping.yml</strong></h4><p>&emsp;&emsp;search-guard中的角色其实相当于用户组的概念，对角色(用户组)进行权限控制，用户加入角色(用户组)中，以此来管理权限。<br>&emsp;&emsp;用<code>sg_admin</code>角色(用户组)为例，<code>sg_admin</code>为管理员角色(用户组)，该角色(用户组)下有名为<code>admin</code>的用户。所以<code>admin</code>用户就拥有了管理员角色(组)的权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#管理员角色</span></span><br><span class="line">sg_admin:</span><br><span class="line">  users:</span><br><span class="line">    - admin</span><br><span class="line"></span><br><span class="line"><span class="comment">#kibana server帐号</span></span><br><span class="line">sg_kibana_server:</span><br><span class="line">  users:</span><br><span class="line">    - kibana_server</span><br><span class="line"></span><br><span class="line"><span class="comment">#kibana 登录帐号</span></span><br><span class="line">sg_kibana_admin:</span><br><span class="line">  users:</span><br><span class="line">    - kibana_admin</span><br><span class="line"></span><br><span class="line"><span class="comment">#logstash帐号</span></span><br><span class="line">sg_logstash:</span><br><span class="line">  users:</span><br><span class="line">    - logstash</span><br></pre></td></tr></table></figure></p>
<h4 id="定义角色-用户组-权限——sg-roles-yml"><a href="#定义角色-用户组-权限——sg-roles-yml" class="headerlink" title="定义角色(用户组)权限——sg_roles.yml"></a><strong>定义角色(用户组)权限——sg_roles.yml</strong></h4><p>&emsp;&emsp;定义不同角色(用户组)的角色有不同的权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#管理员角色</span></span><br><span class="line"><span class="comment">#拥有所有权限</span></span><br><span class="line">sg_admin:</span><br><span class="line">  cluster:</span><br><span class="line">    - <span class="string">'*'</span></span><br><span class="line">  indices:</span><br><span class="line">    <span class="string">'*'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - <span class="string">'*'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#kibana server角色</span></span><br><span class="line"><span class="comment">#对.kibana索引有所有权限，并且对集群有获取节点信息和健康状态的权限</span></span><br><span class="line">sg_kibana_server:</span><br><span class="line">  cluster:</span><br><span class="line">    - cluster:monitor/nodes/info</span><br><span class="line">    - cluster:monitor/health</span><br><span class="line">  indices:</span><br><span class="line">    <span class="string">'?kibana'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - ALL</span><br><span class="line"></span><br><span class="line"><span class="comment">#kibana登录角色</span></span><br><span class="line">sg_kibana_admin:</span><br><span class="line">  indices:</span><br><span class="line">    <span class="string">'_all'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/mget*</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/get*</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/search*</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/msearch*</span><br><span class="line">    <span class="string">'logstash-*'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - ALL</span><br><span class="line">    <span class="string">'?kibana'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - ALL</span><br><span class="line"></span><br><span class="line"><span class="comment">#logstash角色</span></span><br><span class="line"><span class="comment">#对Elasticsearch有创建索引和写入的权限</span></span><br><span class="line">sg_logstash:</span><br><span class="line">  cluster:</span><br><span class="line">    - indices:admin/template/get</span><br><span class="line">    - indices:admin/template/put</span><br><span class="line">  indices:</span><br><span class="line">    <span class="string">'*'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - WRITE</span><br><span class="line">        - CREATE_INDEX</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/search</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/scroll</span><br></pre></td></tr></table></figure></p>
<h4 id="定制权限别名——sg-action-groups-yml"><a href="#定制权限别名——sg-action-groups-yml" class="headerlink" title="定制权限别名——sg_action_groups.yml"></a><strong>定制权限别名——sg_action_groups.yml</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ALL:</span><br><span class="line">  - <span class="string">"indices:*"</span></span><br><span class="line">CREATE_INDEX:</span><br><span class="line">  - <span class="string">"indices:admin/create"</span></span><br><span class="line">WRITE:</span><br><span class="line">  - <span class="string">"indices:data/write*"</span></span><br><span class="line">READ:</span><br><span class="line">  - <span class="string">"indices:data/read*"</span></span><br><span class="line">DELETE:</span><br><span class="line">  - <span class="string">"indices:data/write/delete*"</span></span><br><span class="line">CRUD:</span><br><span class="line">  - READ</span><br><span class="line">  - WRITE</span><br></pre></td></tr></table></figure>
<h3 id="启动Elasticsearch集群"><a href="#启动Elasticsearch集群" class="headerlink" title="启动Elasticsearch集群"></a><strong>启动Elasticsearch集群</strong></h3><p>&emsp;&emsp;将证书都拷贝到集群所有节点，ES配置文件都新增相关配置后就可启动集群<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/elasticsearch/bin/elasticsearch <span class="operator">-d</span></span><br></pre></td></tr></table></figure></p>
<h3 id="search-guard初始化"><a href="#search-guard初始化" class="headerlink" title="search-guard初始化"></a><strong>search-guard初始化</strong></h3><p>&emsp;&emsp;Elasticsearch所有节点启动完成后需要对search-guard进行初始化，生成<code>searchguard</code>索引。search-guard根据权限配置文件将数据写入到<code>searchguard</code>索引中，当权限设置变更时，只需要重新初始化<code>searchguard</code>索引即可，不需要重启集群。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch/</span><br><span class="line">plugins/search-guard-<span class="number">2</span>/tools/sgadmin.sh -cd plugins/search-guard-<span class="number">2</span>/sgconfig/ -ks plugins/search-guard-<span class="number">2</span>/sgconfig/admin-keystore.jks -ts plugins/search-guard-<span class="number">2</span>/sgconfig/truststore.jks -tspass &lt;your_TrustStore_password&gt; -kspass &lt;your_KeyStore_password&gt; -icl -nhnv</span><br></pre></td></tr></table></figure></p>
<h4 id="设置searchguard索引自动分片"><a href="#设置searchguard索引自动分片" class="headerlink" title="设置searchguard索引自动分片"></a><strong>设置searchguard索引自动分片</strong></h4><p>&emsp;&emsp;初始化后生成的<code>searchguard</code>索引是不会随着集群节点增加而自动增加分片的，需要设置<code>searchguard</code>索引成自动分片。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/elasticsearch/</span><br><span class="line">plugins/search-guard-<span class="number">2</span>/tools/sgadmin.sh -cd plugins/search-guard-<span class="number">2</span>/sgconfig/ -ks plugins/search-guard-<span class="number">2</span>/sgconfig/admin-keystore.jks -ts plugins/search-guard-<span class="number">2</span>/sgconfig/truststore.jks -tspass &lt;your_TrustStore_password&gt; -kspass &lt;your_KeyStore_password&gt; -icl -era</span><br></pre></td></tr></table></figure></p>
<h2 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a><strong>Kibana</strong></h2><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf kibana-<span class="number">4.6</span><span class="number">.4</span>-linux-x86_64.tar.gz</span><br><span class="line">mv kibana-<span class="number">4.6</span><span class="number">.4</span>-linux-x86_64 /usr/local/kibana</span><br><span class="line">useradd kibana</span><br><span class="line">chown -R kibana:kibana /usr/local/kibana/</span><br></pre></td></tr></table></figure>
<h3 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a><strong>配置</strong></h3><p><strong>/usr/local/kibana/config/kibana.yml</strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server<span class="class">.port</span>: <span class="number">5601</span></span><br><span class="line">server<span class="class">.host</span>: <span class="string">"0.0.0.0"</span></span><br><span class="line">elasticsearch<span class="class">.url</span>: <span class="string">"https://localhost:9200"</span></span><br><span class="line">kibana<span class="class">.index</span>: <span class="string">".kibana"</span></span><br><span class="line">elasticsearch<span class="class">.username</span>: <span class="string">"kibana_server"</span></span><br><span class="line">elasticsearch<span class="class">.password</span>: <span class="string">"kibana"</span></span><br><span class="line">elasticsearch<span class="class">.ssl</span><span class="class">.ca</span>: /usr/local/kibana/root-ca<span class="class">.pem</span></span><br><span class="line">elasticsearch<span class="class">.ssl</span><span class="class">.verify</span>: false</span><br></pre></td></tr></table></figure></p>
<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a><strong>访问</strong></h3><p><a href="http://kibana_server_ip:5601" target="_blank" rel="external">http://kibana_server_ip:5601</a><br>输入不同用户及密码会根据用户做权限的控制</p>
<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a><strong>Logstash</strong></h2><h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf logstash-<span class="number">2.4</span><span class="number">.1</span>.tar.gz</span><br><span class="line">mv logstash-<span class="number">2.4</span><span class="number">.1</span> <span class="regexp">/usr/</span>local/logstash</span><br><span class="line">chown -R <span class="string">osadmin:</span>osadmin <span class="regexp">/usr/</span>local<span class="regexp">/logstash/</span></span><br><span class="line">mkdir <span class="regexp">/usr/</span>local<span class="regexp">/logstash/</span>config</span><br></pre></td></tr></table></figure>
<h3 id="配置-3"><a href="#配置-3" class="headerlink" title="配置"></a><strong>配置</strong></h3><p>Logstash使用<strong>grok正则表达式</strong>对日志进行匹配并json化后存入Elasticsearch<br><a href="https://grokdebug.herokuapp.com/" target="_blank" rel="external">grok正则在线测试</a></p>
<h4 id="Logstash采集Nginx"><a href="#Logstash采集Nginx" class="headerlink" title="Logstash采集Nginx"></a><strong>Logstash采集Nginx</strong></h4><ul>
<li><p>客户端配置<br>  &emsp;采集的客户端用的是<strong>filebeat</strong>，直接通过rpm安装。<br>  &emsp;/etc/filebeat/filebeat.yml</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filebeat.prospectors:</span><br><span class="line">- input_<span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /usr/<span class="built_in">local</span>/nginx/logs/access.log</span><br><span class="line">  <span class="comment">#multiline:</span></span><br><span class="line">  <span class="comment">#  pattern: '^(20[0-9]&#123;2&#125;(-[0-9]&#123;2&#125;)&#123;2&#125; [0-9]&#123;2&#125;(:[0-9]&#123;2&#125;)&#123;2&#125;)'</span></span><br><span class="line">  <span class="comment">#  negate: true</span></span><br><span class="line">  <span class="comment">#  match: after</span></span><br><span class="line"></span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: [<span class="string">"10.201.5.30:9092"</span>, <span class="string">"10.201.5.31:9092"</span>]</span><br><span class="line">  topic: <span class="string">'nginx'</span></span><br><span class="line">  partition.round_robin:</span><br><span class="line">    reachable_only: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  required_acks: <span class="number">1</span></span><br><span class="line">  compression: gzip</span><br><span class="line">  max_message_bytes: <span class="number">1000000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端配置<br>  /usr/local/logstash/config/logstash.conf<br>  <code>root-ca.pem</code>是使用search-guard-ssl生成的证书原路径——<code>search-guard-ssl/example-pki-scripts/ca/root-ca.pem</code></p>
  <figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="name">input</span> &#123;</span><br><span class="line">	kafka &#123;</span><br><span class="line">		zk_connect =&gt; <span class="string">"10.201.3.33:2181,10.201.3.30:2181"</span></span><br><span class="line">		topic_id =&gt; <span class="string">"nginx"</span></span><br><span class="line">		codec =&gt; json</span><br><span class="line">		reset_beginning =&gt; <span class="keyword">false</span></span><br><span class="line">		consumer_threads =&gt; <span class="number">5</span></span><br><span class="line">		decorate_events =&gt; <span class="keyword">true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="name">filter</span> &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		patterns_dir =&gt; [<span class="string">"/usr/local/logstash/patterns"</span>]</span><br><span class="line">		match =&gt; [<span class="string">"message"</span>, <span class="string">"%&#123;NGINXACCESS&#125;"</span>]</span><br><span class="line">		overwrite =&gt; [<span class="string">"message"</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="name">geoip</span> &#123;</span><br><span class="line">		source =&gt; <span class="string">"xforward"</span></span><br><span class="line">		target =&gt; <span class="string">"geoip"</span></span><br><span class="line">		database =&gt; <span class="string">"/usr/local/logstash/maps/GeoLiteCity.dat"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="name">output</span> &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">         user =&gt; logstash</span><br><span class="line">         password =&gt; logstash</span><br><span class="line">         ssl =&gt; <span class="keyword">true</span></span><br><span class="line">         ssl_certificate_verification =&gt; <span class="keyword">false</span></span><br><span class="line">         cacert =&gt; <span class="string">"/usr/local/logstash/config/root-ca.pem"</span></span><br><span class="line">         hosts =&gt; [<span class="string">"10.201.3.49:9200"</span>,<span class="string">"10.201.3.33:9200"</span>,<span class="string">"10.201.3.30:9200"</span>]</span><br><span class="line">         index =&gt; <span class="string">"nginx-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>grok正则<br>  /usr/local/logstash/patterns/nginx</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NGINXACCESS %&#123;<span class="string">IP:</span>ip&#125; \- \- \[%&#123;<span class="string">HTTPDATE:</span>timestamp&#125;\] <span class="string">"%&#123;WORD:method&#125; %&#123;URIPATHPARAM:uri&#125; HTTP/%&#123;NUMBER:httpversion&#125;"</span> %&#123;<span class="string">NUMBER:</span>status&#125; %&#123;<span class="string">NUMBER:</span>bytes&#125; %&#123;<span class="string">QS:</span>referer&#125; %&#123;<span class="string">QS:</span>agent&#125; \<span class="string">"(?:-|%&#123;IP:xforward&#125;[%&#123;IP&#125;\, ]*)\" "</span>%&#123;<span class="string">NUMBER:</span><span class="string">request_time:</span><span class="typename">float</span>&#125; %&#123;<span class="string">NUMBER:</span>request_length&#125; %&#123;<span class="string">NUMBER:</span>connection_requests&#125;<span class="string">" %&#123;QS:other&#125;</span></span><br></pre></td></tr></table></figure>
<p>  Nginx日志格式</p>
  <figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  '<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] <span class="string">"<span class="variable">$request</span>"</span> '</span><br><span class="line">                     '<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> <span class="string">"<span class="variable">$http_referer</span>"</span> '</span><br><span class="line">                     '<span class="string">"<span class="variable">$http_user_agent</span>"</span> <span class="string">"<span class="variable">$http_x_forwarded_for</span>"</span> <span class="string">"<span class="variable">$request_time</span> <span class="variable">$request_length</span> <span class="variable">$connection_requests</span>"</span> <span class="string">"<span class="variable">$http_syncsession</span>| <span class="variable">$http_sessionkey</span>| <span class="variable">$http_cookie</span>| <span class="variable">$http_accept</span>| <span class="variable">$http_content_length</span>| <span class="variable">$http_x_forwarded_proto</span>"</span>'<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a><strong>启动</strong></h4><p>测试Logstash配置文件是否正确<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/logstash/</span>bin<span class="regexp">/logstash -f /u</span>sr<span class="regexp">/local/</span>logstash<span class="regexp">/config/</span>logstash.conf --configtest --verbose</span><br></pre></td></tr></table></figure></p>
<p>启动Logstash(尽量使用Supervisord管理)<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/logstash/</span>bin<span class="regexp">/logstash -f /u</span>sr<span class="regexp">/local/</span>logstash<span class="regexp">/config/</span>logstash.conf</span><br></pre></td></tr></table></figure></p>
<h2 id="Sentinl"><a href="#Sentinl" class="headerlink" title="Sentinl"></a><strong>Sentinl</strong></h2><p>&emsp;&emsp;Sentinl是一个开源的Kibana插件，用于监控报警和报告，可弥补ELK缺乏报警的功能。<a href="https://github.com/sirensolutions/sentinl" target="_blank" rel="external">Sentinl项目地址</a></p>
<h3 id="安装-4"><a href="#安装-4" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/kibana/</span><br><span class="line">bin/kibana plugin --install sentinl -u https://github.com/sirensolutions/sentinl/releases/download/snapshot/sentinl-latest.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="search-guard权限设置-1"><a href="#search-guard权限设置-1" class="headerlink" title="search-guard权限设置"></a><strong>search-guard权限设置</strong></h3><p>&emsp;&emsp;Sentinl需要查询Elasticsearch的数据，所以需要给<code>kibana.yml</code>中的用户相应的权限<br>&emsp;&emsp;<strong>sg_roles.yml</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sg_kibana_server:</span><br><span class="line">  cluster:</span><br><span class="line">    - cluster:monitor/nodes/info</span><br><span class="line">    - cluster:monitor/health</span><br><span class="line">  indices:</span><br><span class="line">    <span class="string">'?kibana'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - ALL</span><br><span class="line">    <span class="string">'watcher*'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - ALL</span><br><span class="line">    <span class="string">'*'</span>:</span><br><span class="line">      <span class="string">'*'</span>:</span><br><span class="line">        - indices:data/<span class="built_in">read</span>/search*</span><br></pre></td></tr></table></figure></p>
<h3 id="kibana设置"><a href="#kibana设置" class="headerlink" title="kibana设置"></a><strong>kibana设置</strong></h3><p>&emsp;&emsp;需要在<code>kibana.yml</code>中设置发邮帐号和监控相对应的Elasticsearch索引。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sentinl:</span><br><span class="line"> es:</span><br><span class="line">   timefield: <span class="string">'@timestamp'</span></span><br><span class="line">   default_index: watcher</span><br><span class="line">   <span class="built_in">type</span>: watch</span><br><span class="line">   alarm_index: watcher_alarms</span><br><span class="line"> sentinl:</span><br><span class="line">   <span class="built_in">history</span>: <span class="number">20</span></span><br><span class="line">   results: <span class="number">50</span></span><br><span class="line"> settings:</span><br><span class="line">   email:</span><br><span class="line">     active: <span class="literal">true</span></span><br><span class="line">     user: <span class="built_in">test</span>@<span class="number">163</span>.com</span><br><span class="line">     password: &lt;password&gt;</span><br><span class="line">     host: smtp.<span class="number">163</span>.com</span><br><span class="line">     ssl: <span class="literal">true</span></span><br><span class="line">   report:</span><br><span class="line">     active: <span class="literal">true</span></span><br><span class="line">     tmp_path: /tmp/</span><br></pre></td></tr></table></figure></p>
<h3 id="配置Watch监控"><a href="#配置Watch监控" class="headerlink" title="配置Watch监控"></a><strong>配置Watch监控</strong></h3><p>&emsp;&emsp;登录Kibana后进入Sentinl点击Watch创建监控规则。规则中的<code>email from</code>需要和<code>kibana.yml</code>中邮箱的<code>user</code>一致。<br>&emsp;&emsp;下面这个示例是5分钟内<code>nginx-</code>索引日志中<code>status</code>http状态码为<code>502</code>的记录出现超过<code>3</code>次则报警<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"_index"</span>: <span class="string">"watcher"</span>,</span><br><span class="line">  <span class="string">"_type"</span>: <span class="string">"watch"</span>,</span><br><span class="line">  <span class="string">"_id"</span>: <span class="string">"ops_1"</span>,</span><br><span class="line">  <span class="string">"_score"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">"_source"</span>: &#123;</span><br><span class="line">    <span class="string">"disable"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"uuid"</span>: <span class="string">"ops_1"</span>,</span><br><span class="line">    <span class="string">"trigger"</span>: &#123;</span><br><span class="line">      <span class="string">"schedule"</span>: &#123;</span><br><span class="line">        <span class="string">"later"</span>: <span class="string">"every 5 minutes"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"input"</span>: &#123;</span><br><span class="line">      <span class="string">"search"</span>: &#123;</span><br><span class="line">        <span class="string">"request"</span>: &#123;</span><br><span class="line">          <span class="string">"index"</span>: [</span><br><span class="line">            <span class="string">"&lt;nginx-&#123;now/d&#125;&gt;"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">"body"</span>: &#123;</span><br><span class="line">            <span class="string">"size"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">"query"</span>: &#123;</span><br><span class="line">              <span class="string">"bool"</span>: &#123;</span><br><span class="line">                <span class="string">"must"</span>: &#123;</span><br><span class="line">                  <span class="string">"match"</span>: &#123;</span><br><span class="line">                    <span class="string">"status"</span>: <span class="string">"502"</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"filter"</span>: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">"range"</span>: &#123;</span><br><span class="line">                      <span class="string">"@timestamp"</span>: &#123;</span><br><span class="line">                        <span class="string">"gt"</span>: <span class="string">"now-5m"</span></span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"condition"</span>: &#123;</span><br><span class="line">      <span class="string">"script"</span>: &#123;</span><br><span class="line">        <span class="string">"script"</span>: <span class="string">"payload.hits.total &gt; 3"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"transform"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"actions"</span>: &#123;</span><br><span class="line">      <span class="string">"email_admin"</span>: &#123;</span><br><span class="line">        <span class="string">"throttle_period"</span>: <span class="string">"5m"</span>,</span><br><span class="line">        <span class="string">"email"</span>: &#123;</span><br><span class="line">          <span class="string">"to"</span>: <span class="string">"admin@gmail.com"</span>,</span><br><span class="line">          <span class="string">"from"</span>: <span class="string">"test@163.com"</span>,</span><br><span class="line">          <span class="string">"subject"</span>: <span class="string">"Sentinl Alarm"</span>,</span><br><span class="line">          <span class="string">"priority"</span>: <span class="string">"high"</span>,</span><br><span class="line">          <span class="string">"body"</span>: <span class="string">"Found &#123;&#123;payload.hits.total&#125;&#125; 502 Events"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Supervisord"><a href="#Supervisord" class="headerlink" title="Supervisord"></a><strong>Supervisord</strong></h2><p>&emsp;&emsp;使用Supervisord来管理Logstash、Zookeeper和Kafka的启动/停止</p>
<h3 id="安装-5"><a href="#安装-5" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> -U setuptools</span><br><span class="line">pip <span class="keyword">install</span> supervisor</span><br></pre></td></tr></table></figure>
<h3 id="配置-4"><a href="#配置-4" class="headerlink" title="配置"></a><strong>配置</strong></h3><p>生成模板配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>_supervisord_conf &gt; /etc/supervisord.conf</span><br></pre></td></tr></table></figure></p>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a><strong>启动</strong></h3><ul>
<li><p>启动Supervisor</p>
  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord</span><br></pre></td></tr></table></figure>
</li>
<li><p>supervisorctl<br>  通过supervisorctl控制程序的启动，也可以通过Web界面管理<strong><a href="http://supervisor_server_ip:9001" target="_blank" rel="external">http://supervisor_server_ip:9001</a></strong></p>
  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl  [start|<span class="string">stop</span>|<span class="string">restart</span>|<span class="string">reread</span>|<span class="string">update] program_name</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/ELK/">ELK</a>

					</div>

				

			</article>

			<div class="content-nav">

				
					<a href="/2017/05/23/kubernetes/" title="Kubernetes理论篇">&larr; Prev</a>
				

				
					<a href="/2017/02/02/linux-kernel-note/" title="《深入理解Linux内核》读书笔记">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
