<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" Kafka &amp; ZooKeeper | Hexo " />
	<meta name="twitter:title" content=" Kafka &amp; ZooKeeper | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" Kafka &amp; ZooKeeper | Hexo ">
	<meta property="og:description" content=" Kafka &amp; ZooKeeper | Hexo " />
	<meta name="twitter:description" content=" Kafka &amp; ZooKeeper | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2017/08/31/Kafka/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2017-08-31">2017-08-31</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/Bigdata/">Bigdata</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2017/08/31/Kafka/" itemprop="url"><span itemprop="name">Kafka &amp; ZooKeeper</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
                    <!-- Table of Contents -->
                    
                    <div id="toc" class="toc-article">
                        <strong class="toc-title">目录</strong>
                        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka原理"><span class="toc-number">1.</span> <span class="toc-text">Kafka原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础概念"><span class="toc-number">1.1.</span> <span class="toc-text">基础概念</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper原理"><span class="toc-number">2.</span> <span class="toc-text">ZooKeeper原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础概念-1"><span class="toc-number">2.1.</span> <span class="toc-text">基础概念</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZooKeeper集群部署"><span class="toc-number">3.</span> <span class="toc-text">ZooKeeper集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">3.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群配置"><span class="toc-number">3.2.</span> <span class="toc-text">集群配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动ZooKeeper集群"><span class="toc-number">3.3.</span> <span class="toc-text">启动ZooKeeper集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper日志维护"><span class="toc-number">3.4.</span> <span class="toc-text">ZooKeeper日志维护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZooKeeper常用操作"><span class="toc-number">3.5.</span> <span class="toc-text">ZooKeeper常用操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#命令行连接ZooKeeper"><span class="toc-number">3.5.1.</span> <span class="toc-text">命令行连接ZooKeeper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#四字命令"><span class="toc-number">3.5.2.</span> <span class="toc-text">四字命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kafka集群部署"><span class="toc-number">4.</span> <span class="toc-text">Kafka集群部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka安装"><span class="toc-number">4.1.</span> <span class="toc-text">Kafka安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka集群配置"><span class="toc-number">4.2.</span> <span class="toc-text">Kafka集群配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置文件"><span class="toc-number">4.2.1.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka-JVM设置"><span class="toc-number">4.2.2.</span> <span class="toc-text">Kafka JVM设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动Kafka"><span class="toc-number">4.2.3.</span> <span class="toc-text">启动Kafka</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kafka常用操作"><span class="toc-number">4.3.</span> <span class="toc-text">Kafka常用操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建topic"><span class="toc-number">4.3.1.</span> <span class="toc-text">创建topic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看topic"><span class="toc-number">4.3.2.</span> <span class="toc-text">查看topic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除topic"><span class="toc-number">4.3.3.</span> <span class="toc-text">删除topic</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态修改topic的数据保留时间"><span class="toc-number">4.3.4.</span> <span class="toc-text">动态修改topic的数据保留时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生产消费测试"><span class="toc-number">4.3.5.</span> <span class="toc-text">生产消费测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#consumer-group-操作"><span class="toc-number">4.3.6.</span> <span class="toc-text">consumer group 操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态增加partition数量"><span class="toc-number">4.3.7.</span> <span class="toc-text">动态增加partition数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手动修改Kafka-topic-offset"><span class="toc-number">4.3.8.</span> <span class="toc-text">手动修改Kafka topic offset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka集群扩容"><span class="toc-number">4.3.9.</span> <span class="toc-text">Kafka集群扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#增加topic的replication数量"><span class="toc-number">4.3.10.</span> <span class="toc-text">增加topic的replication数量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kafka集群间数据同步——MirrorMaker"><span class="toc-number">4.3.11.</span> <span class="toc-text">Kafka集群间数据同步——MirrorMaker</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KafkaOffsetMonitor监控部署"><span class="toc-number">4.3.12.</span> <span class="toc-text">KafkaOffsetMonitor监控部署</span></a></li></ol></li></ol></li></ol>
                    </div>
                    

					<h2 id="Kafka原理"><a href="#Kafka原理" class="headerlink" title="Kafka原理"></a><strong>Kafka原理</strong></h2><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a><strong>基础概念</strong></h3><ul>
<li><p><strong>producer</strong>: 生产者，将消息发到<code>topic</code>里的为生产者</p>
</li>
<li><p><strong>consumer</strong>: 消费者，从<code>topic</code>里读取消息的为消费者。Kafka以<code>group</code>为单位组织<code>consumer</code>，同一个<code>topic</code>可有多个<code>consumer group</code>，一条消息会发到所有<code>consumer group</code>中，一个<code>consumer group</code>可能会有多个<code>consumer</code>，但一条消息只会被<code>consumer group</code>内的一个<code>consumer</code>消费，即一条消息在同一个<code>consumer group</code>内只会被消费一次。Kafka有<strong>consumer rebalance</strong>机制，自动平衡消费者，但在平衡期间不会进行消费，consumer或broker的增减都会触发rebalance，Kafka也会将无法消费或消费过慢的consumer剔除后自动引发rebalance。</p>
</li>
<li><p><strong>broker</strong>: 每个Kafka实例称之为<code>broker</code></p>
</li>
<li><p><strong>topic</strong>: Kafka以<code>topic</code>为单位对消息进行分类，相同类型的消息分到同一个<code>topic</code>进行生成消费管理。一个<code>topic</code>由一个或多个<code>partition</code>组成。</p>
</li>
<li><p><strong>partition</strong>: Kafka中可将一个<code>topic</code>切分成一个或多个<code>partition</code>，<code>partition</code>是Kafka横向扩展及并行处理的关键。每个<code>partition</code>都是一个顺序、不可变的消息队列。Kafka会将消息持久化到磁盘，但官方建议消息的高可用应由partition replication来保证。可为每个partition设置replicas，每个partition会选举出唯一一个leader partition，<strong>所有的读写请求都由leader处理</strong>，replicas只负责将消息同步到本地确保高可用。</p>
<ul>
<li><strong>Isr</strong>: In-Sync Replica，表示能与leader保持数据同步的replicas。如果replicas同步leader消息的<strong>延迟时间</strong>或<strong>延迟条数</strong>其中一个超出阀值，则会将延迟的replicas剔出Isr。当leader partition挂掉后，<strong>只有在Isr队列里的replicas才可参与leader partition的选举过程</strong>。</li>
<li><strong>replication-factor</strong>: 复制因子，topic partition的副本数目，默认<code>1</code>，即无副本。若<code>replication-factor=N</code>，则允许<code>N-1</code>台机器宕机以确保消息的高可用。</li>
</ul>
</li>
<li><p><strong>offset</strong>: 每个<code>partition</code>内的消息都有一个序列号，称之为<code>offset</code>。<code>offset</code>在<code>partition</code>内是有序的，不能跨<code>partition</code>使用<code>offset</code>，<code>offset</code>的移动表示<code>partition</code>内消息的消费位置。在Kafka的设计中，<strong>一个<code>partition</code>中消费<code>offset</code>完全是由消费者自己控制的</strong>。假若一个消费者将<code>offset</code>设置成<code>0</code>，则意味着该消费者会从该<code>partition</code>中最开始的消息开始消费。一个消费者的<code>offset</code>操作不会影响到该<code>partition</code>内的其他消费者，因为每个消费者都维护着自己的消费<code>offset</code>。</p>
<p>关于<code>offset</code>还涉及到以下4个概念</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last Commit Offset————Current Posision————High Watermark————Log End Offset</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>Last Commit Offset</code></strong>: consumer group最新一次commit的offset位置，<code>Last Commit Offset</code>表示在此之前的所有消息都以消费完并确认。</li>
<li><strong><code>Current Posision</code></strong>: 当前consumer group消费消息的offset位置。<code>Last Commit Offset</code>与<code>Current Posision</code>之间的消息表示已经被consumer group读取但还在处理中，<strong>没有确认(commit)</strong>。</li>
<li><strong><code>High Watermark</code></strong>: 表示<code>High Watermark</code>之前的数据都已被同步到所有replicas中，<code>High Watermark</code>offset之前的数据是高可用的(消息有多个副本)。</li>
<li><strong><code>Log End Offset</code></strong>: 表示producer发送到该partition中最新消息的offset。<code>High Watermark</code>和<code>Log End Offset</code>之间的数据表示消息已写入leader partition但未同步至replicas中，这之间的数据没高可用，是不安全的，<strong>不允许消费</strong></li>
</ul>
<p>从<code>0.9</code>版本后的Kafka开始，新版的consumer api是将<code>offset</code>存放在Kafka的<strong><code>__consumer_offsets</code></strong> topic中。该topic默认有<strong><code>50</code></strong>个partition和<strong><code>3</code></strong>个replicas。某个consumer group的offset具体存放在哪个partition是通过<strong><code>abs(GroupId.hashCode()) % NumPartitions</code></strong> 计算出来的(<code>NumPartitions</code>默认<code>50</code>)。旧版本的Kafka默认是将offset存在ZooKeeper中。</p>
</li>
<li><p><strong>ack</strong>: ack确认机制是producer发送消息给Kafka，确认消息高可用的机制，依赖于producer的<code>request.required.acks</code>设置</p>
<ul>
<li><strong><code>0</code></strong>: producer只管发送，不管Kafka是否接收成功</li>
<li><strong><code>1</code></strong>: Kafka partition的leader写入后即返回成功，replicas异步同步消息。风险在于leader挂了，消息还没同步的话则会丢失数据。</li>
<li><strong><code>all/-1</code></strong>: 旧版Kafka(<code>0.8</code>)值为<code>-1</code>，新版Kafka值为<code>all</code>。等待所有replicas都同步消息后才返回成功，数据高可用最安全，生产消息性能会受影响。</li>
</ul>
</li>
<li><p><strong>ZeroCopy</strong>: Kafka使用ZeroCopy机制以提高性能，以从磁盘读取数据返回给消费者为例</p>
<ul>
<li>传统方式(涉及4次切换):<ol>
<li>进程通过<code>read()</code>系统调用从用户态切换到内核态[1]，内核向磁盘发起请求，将数据从磁盘读取到内核缓存区</li>
<li>进程将数据从内核空间拷贝到用户空间，从内核态切换到用户态[2]</li>
<li>进程将数据发送到Socket，从用户态切换到内核态[3]，将数据写入到Socket Buffer</li>
<li>内核将Socket Buffer中的数据拷贝到NIC Buffer中，最终发送给消费者。从内核态切换用户态[4]，完成操作</li>
</ol>
</li>
<li>ZeroCopy方式(涉及2次切换):<ol>
<li>进程通过<code>sendfile()</code>从用户态切换到内核态[1]，内核从磁盘读取数据到内核缓存区，然后直接将数据拷贝到Socket Buffer，再将数据从Socket Buffer拷贝到NIC Buffer</li>
<li>完成操作后从内核态切换用户态[2]</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="ZooKeeper原理"><a href="#ZooKeeper原理" class="headerlink" title="ZooKeeper原理"></a><strong>ZooKeeper原理</strong></h2><h3 id="基础概念-1"><a href="#基础概念-1" class="headerlink" title="基础概念"></a><strong>基础概念</strong></h3><ul>
<li><p><strong>角色</strong>: ZK中分为3中角色。ZK所有节点都可接收并处理<strong>读请求</strong>(<code>exists</code>/<code>getData</code>/<code>getChildren</code>…)，但只有<strong>Leader</strong>角色节点才能处理<strong>写请求</strong>(<code>create</code>/<code>setData</code>/<code>delete</code>)</p>
<ul>
<li><strong>Leader</strong>: 主节点，响应所有其余节点请求(包括写请求)，维护集群状态</li>
<li><strong>Follower</strong>: 从Leader中同步消息和状态，接收并处理读请求，转发写请求到Leader。可参与选举</li>
<li><strong>Observer</strong>: <code>3.3.0</code>版本开始引入，仅处理读请求，提高读请求吞吐量，转发写请求到Leader。数据不持久化到磁盘，不可参与选举</li>
</ul>
</li>
<li><p><strong>ZNODE</strong>: ZK使用类似文件系统方式组织资源，资源中的每个节点称为ZNODE。ZNODE分4中类型</p>
<ul>
<li><strong>持久节点(persistent)</strong>: 只能通过<code>delete</code>指令删除，数据会被持久化</li>
<li><strong>临时节点(ephemeral)</strong>: 创建该ZNODE的客户端断开连接后，临时节点会被<strong>自动删除</strong></li>
<li><strong>有序节点</strong>: 创建节点时会自动在节点名后添加一串单调递增序号，<code>/tasks/task0000000001</code></li>
<li><strong>无序节点</strong>: 默认创建无序节点</li>
</ul>
</li>
<li><p><strong>ZNODE stat结构</strong>: 每个ZNODE都会有一个<code>stat</code>信息，可通过<code>stat &lt;/zookeeper/test/node&gt;</code>或<code>ls2 &lt;/zookeeper/test/node&gt;</code>查看</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost(CONNECTED) <span class="number">0</span>] <span class="built_in">stat</span> /zookeeper</span><br><span class="line">cZxid = <span class="number">0</span>x0</span><br><span class="line">ctime = Thu Jan <span class="number">01</span> <span class="number">05</span>:<span class="number">30</span>:<span class="number">00</span> IST <span class="number">1970</span></span><br><span class="line">mZxid = <span class="number">0</span>x0</span><br><span class="line">mtime = Thu Jan <span class="number">01</span> <span class="number">05</span>:<span class="number">30</span>:<span class="number">00</span> IST <span class="number">1970</span></span><br><span class="line">pZxid = <span class="number">0</span>x0</span><br><span class="line">cversion = -<span class="number">1</span></span><br><span class="line">dataVersion = <span class="number">0</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">dataLength = <span class="number">0</span></span><br><span class="line">numChildren = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>cZxid</strong>: 导致创建znode更改的事务ID</li>
<li><strong>mZxid</strong>: 最后修改znode更改的事务ID</li>
<li><strong>pZxid</strong>: 用于添加或删除子节点的znode更改的事务ID</li>
<li><strong>ctime</strong>: 表示从1970-01-01T00:00:00Z开始以毫秒为单位的znode创建时间</li>
<li><strong>mtime</strong>: 表示从1970-01-01T00:00:00Z开始以毫秒为单位的znode最近修改时间</li>
<li><strong>dataVersion</strong>: 表示对该znode的数据所做的更改次数</li>
<li><strong>cversion</strong>: 这表示对此znode的子节点进行的更改次数</li>
<li><strong>aclVersion</strong>: 表示对此znode的ACL进行更改的次数</li>
<li><strong>ephemeralOwner</strong>: 如果znode是临时节点，则为此znode所有者的 session ID；如果znode不是临时节点，则该字段设置为零</li>
<li><strong>dataLength</strong>: 这是znode数据字段的长度</li>
<li><strong>numChildren</strong>: 这表示znode的子节点的数量</li>
</ul>
</li>
<li><p><strong>监视通知机制</strong>: ZK自身提供监视通知机制，可对某ZNODE设置一个监视<code>watcher</code>，当监视事件发生时会发送通知。可设置2种类似watcher</p>
<ul>
<li><strong>Data Watches</strong>: ZNODE数据变更触发通知(<code>create</code>/<code>setData</code>)</li>
<li><strong>Child Watches</strong>: ZNODE子节点变更触发通知(<code>delete</code>/<code>create</code>[child znode])</li>
</ul>
</li>
<li><p><strong>会话(session)</strong>: client连接到ZK时，便会创建一个会话(session)。会话失效后ZK会清除会话相关信息(临时节点/Watcher)。每个会话session都有4个基本属性</p>
<ul>
<li><strong>SID</strong>: 会话ID，唯一标识每个会话</li>
<li><strong>TimeOut</strong>: 会话超时时间。会话异常断开后，client会尝试重连，若在TimeOut时间内重连上，则收到<code>syncconnected</code>事件重用会话；若超过TimeOut时间重连上，则收到<code>expired</code>事件，结束会话重新发起新连接。</li>
<li><strong>TickTime</strong>: 下次会话超时时间点，13位long型数据，<code>TickTime ~= NowTime + TimeOut</code></li>
<li><strong>isClosing</strong>: 会话超时标记，会话超时失效时，将会话标记为已关闭</li>
</ul>
</li>
<li><p><strong>Leader选举</strong>:</p>
<ul>
<li><strong>ZAB协议</strong>: ZK通过ZAB(Zookeeper Atomic Broadcast)协议进行消息传递，选举消息自然使用ZAB协议进行</li>
<li><strong>选举算法</strong>: <code>3.4.10</code>为止，有4种选举算法，<strong>默认3</strong><ul>
<li><code>0</code>: 基于UDP的LeaderElection</li>
<li><code>1</code>: 基于UDP的FastLeaderElection</li>
<li><code>2</code>: 基于UDP和认证的FastLeaderElection</li>
<li><code>3</code>: 基于TCP的FastLeaderElection</li>
</ul>
</li>
<li><strong>选举消息</strong><ul>
<li><strong>sid</strong>: ZK配置文件中配置<code>server.&lt;X&gt;</code>，ZK集群的唯一ID</li>
<li><strong>zxid</strong>: 事务ID，每个zxid由64位数字表示，zxid全局单调递增</li>
<li><strong>epoch</strong>: zxid高32位为epoch，从<code>1</code>开始单调递增，每选举投票一轮<code>epoch + 1</code>。低32位为epoch内序号，epoch变化则重置</li>
</ul>
</li>
<li><strong>选举优先级原则</strong><ul>
<li><strong>epoch &gt; zxid(低32位) &gt; sid</strong><ul>
<li>只有epoch为最新的follower才能参加选举(收到的epoch比自身大，无条件放弃选举)</li>
<li>zxid大的优先级高</li>
<li>sid大的优先级高</li>
</ul>
</li>
<li><strong>过半原则</strong>: 得票数 &gt; 集群总节点数/2，则产生新Leader</li>
</ul>
</li>
<li><strong>选举大致过程</strong><ul>
<li>产生选举信息。所有ZK节点(Observer除外)产生<code>(sid, zxid)</code>选举信息，并都认为自己是Leader，投自己一票</li>
<li>接收选举信息。ZK节点之间会建立TCP连接，为避免重复建立连接，ZK节点只允许<strong>sid</strong>大于自身的节点与自己建立连接，否则断开连接，并主动和对方建立连接</li>
<li>处理选举信息。<ul>
<li>检查epoch，收到的epoch大于自身epoch，退出选举，更新投票信息，发送投票结果</li>
<li>epoch相同，比较zxid，较大节点胜出</li>
<li>zxid相同，比较sid，较大节点胜出</li>
</ul>
</li>
<li>统计选举信息。每轮投票结束都会统计选举结果，若过半则产生新Leader，否则继续下一轮选举投票</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ZooKeeper集群部署"><a href="#ZooKeeper集群部署" class="headerlink" title="ZooKeeper集群部署"></a><strong>ZooKeeper集群部署</strong></h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><p>JDK安装省略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.apache.org/dist/zookeeper/zookeeper-<span class="number">3.4</span>.<span class="number">8</span>/zookeeper-<span class="number">3.4</span>.<span class="number">8</span>.tar.gz</span><br><span class="line">tar -zxvf zookeeper-<span class="number">3.4</span>.<span class="number">8</span>.tar.gz</span><br><span class="line">mv zookeeper-<span class="number">3.4</span>.<span class="number">8</span> /usr/<span class="built_in">local</span>/zookeeper</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/zookeeper/data /usr/<span class="built_in">local</span>/zookeeper/<span class="built_in">log</span> /usr/<span class="built_in">local</span>/zookeeper/datalog</span><br></pre></td></tr></table></figure>
<h3 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a><strong>集群配置</strong></h3><ul>
<li><p>zoo.cfg</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tickTime=<span class="number">2000</span></span><br><span class="line">initLimit=<span class="number">10</span></span><br><span class="line">syncLimit=<span class="number">5</span></span><br><span class="line">dataDir=/usr/<span class="built_in">local</span>/zookeeper/data</span><br><span class="line">dataLogDir=/usr/<span class="built_in">local</span>/zookeeper/datalog</span><br><span class="line">clientPort=<span class="number">2181</span></span><br><span class="line"></span><br><span class="line">server.<span class="number">1</span>=<span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server.<span class="number">2</span>=<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line">server.<span class="number">3</span>=<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2888</span>:<span class="number">3888</span></span><br><span class="line"></span><br><span class="line">maxClientCnxns=<span class="number">500</span></span><br><span class="line">minSessionTimeout=<span class="number">30000</span></span><br><span class="line">maxSessionTimeout=<span class="number">60000</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>tickTime</code>: 基本时间单元，以毫秒为单位。它用来控制心跳和超时，默认情况下最小的会话超时时间为两倍的tickTime</li>
<li><code>initLimit</code>: 允许follower连接并同步到leader的初始化连接时间，以tickTime倍数计算</li>
<li><code>syncLimit</code>:  Leader与Follower间请求和应答时间长度</li>
<li><code>dataDir</code>: 快照文件目录</li>
<li><code>dataLogDir</code>: 事务日志目录(<code>dataDir</code>和<code>dataLogDir</code>目录最好是在两个不同磁盘中，避免IO竞争)</li>
<li><code>2181</code>: ZooKeeper监听端口(客户端连接端口)</li>
<li><code>2888</code>: leader和follower之间数据同步使用的端口号</li>
<li><code>3888</code>: leader选举专用的端口号</li>
<li><code>maxClientCnxns</code>: 客户端并发连接数目</li>
</ul>
</li>
<li><p>ServerID</p>
<p>集群每个节点都需要配置唯一的<strong>ServerID</strong>，ServerID保持和<code>zoo.cfg</code>中<strong><code>server.X</code></strong>中的<strong><code>X</code></strong>一致</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 10.201.3.222</span></span><br><span class="line"><span class="built_in">echo</span> <span class="number">1</span> &gt; /usr/<span class="built_in">local</span>/zookeeper/data/myid</span><br><span class="line"><span class="comment"># 10.201.3.223</span></span><br><span class="line"><span class="built_in">echo</span> <span class="number">2</span> &gt; /usr/<span class="built_in">local</span>/zookeeper/data/myid</span><br><span class="line"><span class="comment"># 10.201.3.224</span></span><br><span class="line"><span class="built_in">echo</span> <span class="number">3</span> &gt; /usr/<span class="built_in">local</span>/zookeeper/data/myid</span><br></pre></td></tr></table></figure>
</li>
<li><p>优化配置——<code>zkEnv.sh</code></p>
<p>一些额外的优化配置建议写在<code>zkEnv.sh</code>中，如JVM、Log Level等。修改滚动日志选项(size等)则在<code>conf/log4j.properties</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zkEnv.sh</span></span><br><span class="line">JAVA_HOME=/usr/share/java</span><br><span class="line">ZOO_LOG_DIR=/usr/<span class="built_in">local</span>/zookeeper/<span class="built_in">log</span></span><br><span class="line"><span class="comment"># 设置日志轮转</span></span><br><span class="line">ZOO_LOG4J_PROP=<span class="string">"INFO,ROLLINGFILE"</span></span><br><span class="line">JVMFLAGS=<span class="string">"-Xms1024m -Xmx1024m <span class="variable">$JVMFLAGS</span>"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="启动ZooKeeper集群"><a href="#启动ZooKeeper集群" class="headerlink" title="启动ZooKeeper集群"></a><strong>启动ZooKeeper集群</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># **所有节点执行，启动ZooKeeper集群**</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh start</span><br><span class="line"><span class="comment"># **查看集群状态**</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh status</span><br></pre></td></tr></table></figure>
<h3 id="ZooKeeper日志维护"><a href="#ZooKeeper日志维护" class="headerlink" title="ZooKeeper日志维护"></a><strong>ZooKeeper日志维护</strong></h3><p>默认ZooKeeper不会定期清除日志，<code>3.4.0</code>开始支持定期清理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># **zoo.cfg**</span></span><br><span class="line"><span class="comment"># **清理频率，单位小时**</span></span><br><span class="line">autopurge.purgeInterval=<span class="number">24</span></span><br><span class="line"><span class="comment"># **保留文件数目，默认3**</span></span><br><span class="line">autopurge.snapRetainCount=<span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>但一般采用计划任务选择在空闲时间段定期删除，避免占用大量IO影响ZooKeeper。<strong>ZooKeeper每次执行事务都会写入事务日志，而且需要过半节点同步</strong>。磁盘IO直接影响事务处理速度！</p>
<p>有鉴于此，尽量让<code>dataDir</code>和<code>dataLogDir</code>分开在不同的磁盘，避免IO竞争。ZooKeeper提供<code>zkCleanup.sh</code>脚本帮助清理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkCleanup.sh -n &lt;日志保留数目/默认<span class="number">3</span>&gt;</span><br></pre></td></tr></table></figure>
<h3 id="ZooKeeper常用操作"><a href="#ZooKeeper常用操作" class="headerlink" title="ZooKeeper常用操作"></a><strong>ZooKeeper常用操作</strong></h3><h4 id="命令行连接ZooKeeper"><a href="#命令行连接ZooKeeper" class="headerlink" title="命令行连接ZooKeeper"></a><strong>命令行连接ZooKeeper</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkCli.sh -server <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span></span><br></pre></td></tr></table></figure>
<h4 id="四字命令"><a href="#四字命令" class="headerlink" title="四字命令"></a><strong>四字命令</strong></h4><p>可通过常用的ZooKeeper四字命令监控ZooKeeper，一般用法为：<strong><code>echo &lt;四字命令&gt; | nc localhost 2181</code></strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>conf</td>
<td>3.3.0版本引入的。打印出服务相关配置的详细信息。</td>
</tr>
<tr>
<td>cons</td>
<td>3.3.0版本引入的。列出所有连接到这台服务器的客户端全部连接/会话详细信息。包括”接受/发送”的包数量、会话id、操作延迟、最后的操作执行等等信息。</td>
</tr>
<tr>
<td>crst</td>
<td>3.3.0版本引入的。重置所有连接的连接和会话统计信息。</td>
</tr>
<tr>
<td>dump</td>
<td>列出那些比较重要的会话和临时节点。这个命令只能在leader节点上有用。</td>
</tr>
<tr>
<td>envi</td>
<td>打印出服务环境的详细信息。</td>
</tr>
<tr>
<td>reqs</td>
<td>列出未经处理的请求</td>
</tr>
<tr>
<td>ruok</td>
<td>测试服务是否处于正确状态。如果确实如此，那么服务返回”imok”，否则不做任何相应。</td>
</tr>
<tr>
<td>stat</td>
<td>输出关于性能和连接的客户端的列表。</td>
</tr>
<tr>
<td>srst</td>
<td>重置服务器的统计。</td>
</tr>
<tr>
<td>srvr</td>
<td>3.3.0版本引入的。列出连接服务器的详细信息</td>
</tr>
<tr>
<td>wchs</td>
<td>3.3.0版本引入的。列出服务器watch的详细信息。</td>
</tr>
<tr>
<td>wchc</td>
<td>3.3.0版本引入的。通过session列出服务器watch的详细信息，它的输出是一个与watch相关的会话的列表。</td>
</tr>
<tr>
<td>wchp</td>
<td>3.3.0版本引入的。通过路径列出服务器watch的详细信息。它输出一个与session相关的路径。</td>
</tr>
<tr>
<td>mntr</td>
<td>3.4.0版本引入的。输出可用于检测集群健康状态的变量列表</td>
</tr>
</tbody>
</table>
<h2 id="Kafka集群部署"><a href="#Kafka集群部署" class="headerlink" title="Kafka集群部署"></a><strong>Kafka集群部署</strong></h2><h3 id="Kafka安装"><a href="#Kafka安装" class="headerlink" title="Kafka安装"></a><strong>Kafka安装</strong></h3><p>JDK安装省略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">'http://mirror.bit.edu.cn/apache/kafka/0.10.0.0/kafka_2.11-0.10.0.0.tgz'</span></span><br><span class="line">tar -zxf kafka_2.<span class="number">11</span>-<span class="number">0.10</span>.<span class="number">0.0</span>.tgz &amp;&amp; mv kafka_2.<span class="number">11</span>-<span class="number">0.10</span>.<span class="number">0.0</span> /usr/<span class="built_in">local</span>/kafka</span><br><span class="line">mkdir -p /usr/<span class="built_in">local</span>/kafka/&#123;logs,data&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Kafka集群配置"><a href="#Kafka集群配置" class="headerlink" title="Kafka集群配置"></a><strong>Kafka集群配置</strong></h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a><strong>配置文件</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># **config/server.properties**</span></span><br><span class="line">broker.id=<span class="number">1</span></span><br><span class="line">port=<span class="number">9092</span></span><br><span class="line">advertised.host.name=<span class="number">10.201</span>.<span class="number">3.222</span></span><br><span class="line">host.name=<span class="number">10.201</span>.<span class="number">3.222</span></span><br><span class="line">num.network.threads=<span class="number">4</span></span><br><span class="line">num.io.threads=<span class="number">8</span></span><br><span class="line">socket.send.buffer.bytes=<span class="number">1048576</span></span><br><span class="line">socket.receive.buffer.bytes=<span class="number">1048576</span></span><br><span class="line">socket.request.max.bytes=<span class="number">104857600</span></span><br><span class="line">log.dirs=/usr/<span class="built_in">local</span>/kafka/data</span><br><span class="line">num.partitions=<span class="number">5</span></span><br><span class="line">num.recovery.threads.per.data.dir=<span class="number">1</span></span><br><span class="line">log.retention.hours=<span class="number">72</span></span><br><span class="line">log.segment.bytes=<span class="number">1073741824</span></span><br><span class="line">log.retention.check.interval.ms=<span class="number">300000</span></span><br><span class="line">zookeeper.connect=<span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span></span><br><span class="line">zookeeper.connection.timeout.ms=<span class="number">6000</span></span><br><span class="line">delete.topic.enable=<span class="literal">true</span></span><br><span class="line">default.replication.factor=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>broker.id</code>: kafka broker唯一标识，集群各节点必须唯一。</li>
<li><code>num.network.threads</code>: 网络IO线程数(优化配置成CPU核心数目一致)</li>
<li><code>num.io.threads</code>: 磁盘IO线程数(优化配置成CPU核心数的2倍)</li>
<li><code>socket.send.buffer.bytes/socket.receive.buffer.bytes</code>: 发送/接收缓冲区大小</li>
<li><code>socket.request.max.bytes</code>: 最大请求接收大小</li>
<li><code>log.dirs</code>: kafka数据存放目录，多目录间用<code>,</code>分隔</li>
<li><code>num.partitions</code>: 默认partition数目</li>
<li><code>num.recovery.threads.per.data.dir</code>: 每个数据目录kafka启动恢复日志、关闭刷盘的线程数</li>
<li><code>log.retention.hours</code>: 消息保留时间</li>
<li><code>log.segment.bytes</code>: 日志段大小。日志文件达到该值则切割</li>
<li><code>log.retention.check.interval.ms</code>: 检查消息/日志是否达到删除要求的间隔时间</li>
<li><code>delete.topic.enable</code>: 允许删除topic而非仅标识为<code>delete</code></li>
<li><code>default.replication.factor</code>: 默认消息备份数目，默认为<code>1</code>不做复制</li>
</ul>
<h4 id="Kafka-JVM设置"><a href="#Kafka-JVM设置" class="headerlink" title="Kafka JVM设置"></a><strong>Kafka JVM设置</strong></h4><p><strong><code>/usr/local/kafka/bin/kafka-server-start.sh</code></strong>，kafka heap大小最好不要超过<code>4G</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KAFKA_HEAP_OPTS=<span class="string">"-Xmx3G -Xms3G"</span></span><br></pre></td></tr></table></figure>
<h4 id="启动Kafka"><a href="#启动Kafka" class="headerlink" title="启动Kafka"></a><strong>启动Kafka</strong></h4><p>尽量使用Supervisor管理启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /usr/<span class="built_in">local</span>/kafka/bin/kafka-server-start.sh /usr/<span class="built_in">local</span>/kafka/config/server.properties &amp;&gt; /usr/<span class="built_in">local</span>/kafka/logs/kafka.log &amp;</span><br></pre></td></tr></table></figure>
<h3 id="Kafka常用操作"><a href="#Kafka常用操作" class="headerlink" title="Kafka常用操作"></a><strong>Kafka常用操作</strong></h3><h4 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a><strong>创建topic</strong></h4><p><code>replication-factor</code>的数目要小于等于<code>broker</code>数目。<code>replication-factor</code>为复制因子，默认值<code>1</code>表示无副本，<code>2</code>表示有一个副本。<code>partitions</code>为partition数目，partition越多并发消费量越大，partition维护成本也越大。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --create --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --replication-factor <span class="number">2</span> --partitions <span class="number">2</span> --topic &lt;topic_name&gt;</span><br></pre></td></tr></table></figure>
<h4 id="查看topic"><a href="#查看topic" class="headerlink" title="查看topic"></a><strong>查看topic</strong></h4><ul>
<li><p>列出所有topic</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --list --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看具体topic</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --describe --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --topic &lt;topic_name&gt;</span><br><span class="line">Topic:<span class="built_in">test</span>	PartitionCount:<span class="number">2</span>	ReplicationFactor:<span class="number">2</span>	Configs:</span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">0</span>	Leader: <span class="number">3</span>	Replicas: <span class="number">3</span>,<span class="number">1</span>	Isr: <span class="number">3</span>,<span class="number">1</span></span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">1</span>	Leader: <span class="number">1</span>	Replicas: <span class="number">1</span>,<span class="number">2</span>	Isr: <span class="number">1</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a><strong>删除topic</strong></h4><p>如果<code>delete.topic.enable=true</code>则topic会被直接删除，否则仅仅只是会被先标记为删除并不会实际删。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --delete --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h4 id="动态修改topic的数据保留时间"><a href="#动态修改topic的数据保留时间" class="headerlink" title="动态修改topic的数据保留时间"></a><strong>动态修改topic的数据保留时间</strong></h4><p>topic数据保留时间由配置文件中<code>log.retention.hours</code>指定，运行时可动态修改具体topic保留时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># **旧方法**</span></span><br><span class="line"><span class="comment">#/usr/local/kafka/bin/kafka-topics.sh --zookeeper 10.201.3.222:2181,10.201.3.223:2181,10.201.3.224:2181 --alter --topic &lt;topic_name&gt; --config retention.ms=86400000</span></span><br><span class="line"><span class="comment"># **新方法**</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-configs.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --alter --entity-type topics --entity-name &lt;topic_name&gt; --add-config retention.ms=<span class="number">86400000</span></span><br><span class="line"><span class="comment"># **查看修改**</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-configs.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --describe --entity-type topics --entity-name &lt;topic_name&gt;</span><br></pre></td></tr></table></figure>
<h4 id="生产消费测试"><a href="#生产消费测试" class="headerlink" title="生产消费测试"></a><strong>生产消费测试</strong></h4><ul>
<li><p>生产消息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-console-producer.sh --broker-list <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">9092</span> --topic &lt;topic_name&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>消费消息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-console-consumer.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --topic &lt;topic_name&gt; --from-beginning</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="consumer-group-操作"><a href="#consumer-group-操作" class="headerlink" title="consumer group 操作"></a><strong>consumer group 操作</strong></h4><ul>
<li><p>列出所有消费组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># old consumer api</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --list</span><br><span class="line"><span class="comment"># new consumer api</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">9092</span> --list</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看具体消费组</p>
<p>如果是使用logstash作为consumer的话，默认的grout_name为<code>logstash</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># old consumer api</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --describe --group &lt;group_name&gt;</span><br><span class="line"><span class="comment"># new consumer api</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --new-consumer --bootstrap-server <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">9092</span> --describe --group &lt;group_name&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除具体消费组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --delete --group &lt;group-name&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="动态增加partition数量"><a href="#动态增加partition数量" class="headerlink" title="动态增加partition数量"></a><strong>动态增加partition数量</strong></h4><p>动态增加partition数目可能会影响消息消费的顺序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --alter --topic &lt;topic_name&gt; --partitions <span class="number">8</span></span><br></pre></td></tr></table></figure>
<h4 id="手动修改Kafka-topic-offset"><a href="#手动修改Kafka-topic-offset" class="headerlink" title="手动修改Kafka topic offset"></a><strong>手动修改Kafka topic offset</strong></h4><p>先手动导出Kafka topic的offset</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-run-class.sh kafka.tools.ExportZkOffsets --zkconnect <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --group &lt;group_id&gt; --output-file kafka_offset.txt</span><br></pre></td></tr></table></figure>
<p>手动调整Kafka topic的offset</p>
<ul>
<li><p>方法一</p>
<p>这种方法只能简单的将<code>offset</code>设置成<code>earliest</code>或<code>latest</code></p>
<ul>
<li><p>配置文件——<code>manual_offset.properties</code></p>
<p><strong><code>group.id</code></strong>为consumer group的名称，针对特定的comsumer group来设置，切勿弄错！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zookeeper.connect=<span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span></span><br><span class="line">zookeeper.connection.timeout.ms=<span class="number">6000</span></span><br><span class="line"><span class="comment">#consumer group id</span></span><br><span class="line">group.id=logstash</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行</p>
<p>将topic的offset设置成最新，即忽略已经堆积的历史消息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /usr/local/kafka/bin/kafka-run-class.sh kafka.tools.UpdateOffsetsInZK [earliest|latest] &lt;config_file&gt; &lt;topic_name&gt;</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-run-class.sh kafka.tools.UpdateOffsetsInZK latest manual_offset.properties <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>方法二</p>
<p>这种方法允许指定<code>offset</code>到具体位置，需要通过ZooKeeper修改</p>
<ul>
<li><p>进入ZooKeeper命令行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkCli.sh -server <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看具体topic partition的offset</p>
<p>第一行的值就是当前<code>offset</code>值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">get /consumers/logstash/offsets/<span class="built_in">test</span>/<span class="number">0</span></span><br><span class="line">  <span class="number">13652</span></span><br><span class="line">  cZxid = <span class="number">0</span>x300007fe0</span><br><span class="line">  ctime = Tue Nov <span class="number">01</span> <span class="number">16</span>:<span class="number">11</span>:<span class="number">03</span> CST <span class="number">2016</span></span><br><span class="line">  mZxid = <span class="number">0</span>xd000ad433</span><br><span class="line">  mtime = Tue Jun <span class="number">20</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">37</span> CST <span class="number">2017</span></span><br><span class="line">  pZxid = <span class="number">0</span>x300007fe0</span><br><span class="line">  cversion = <span class="number">0</span></span><br><span class="line">  dataVersion = <span class="number">252</span></span><br><span class="line">  aclVersion = <span class="number">0</span></span><br><span class="line">  ephemeralOwner = <span class="number">0</span>x0</span><br><span class="line">  dataLength = <span class="number">5</span></span><br><span class="line">  numChildren = <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置具体topic partition的offset</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> /consumers/logstash/offsets/<span class="built_in">test</span>/<span class="number">0</span> <span class="number">13650</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>命令详解</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Usage: [get|<span class="built_in">set</span>] /consumers/[groupId]/offsets/[topic]/[partitionId]</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>方法三：</p>
<p>方法一、方法二都适用于旧版的consumer api，新版Kafka使用了新的consumer api不再依赖ZooKeeper管理offset，而是直接将offset存放在<code>__consumer_offsets</code>这个内部topic中。最简单的识别方法是，新版api使用<strong><code>--bootstrap-server</code></strong>而非<code>--zookeeper</code>，如果consumer是使用<code>--bootstrap-server</code>则使用的是新api，方法一、二并不适用新版api手动调整offset，需要使用方法三。</p>
<p>方法三也有个限制，只适用与<code>kafka 0.11.0.0</code>之后的版本，而且consumer group的状态须为<strong>inactive</strong>，即没有消费者正在消费消息。<code>0.11.0.0</code>之前的版本，新版consumer api只能通过编写Java程序手动调用<code>KafkaConsumer seek</code>方法。</p>
<ul>
<li><p>新版consumer api查看consumer group情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --bootstrap-server <span class="number">10.201</span>.<span class="number">5.30</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">5.31</span>:<span class="number">9092</span> --describe --group mirror --new-consumer</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动调整offset</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/local/kafka/bin/kafka-consumer-groups.sh  --bootstrap-server 10.201.5.30:9092,10.201.5.31:9092 --execute --group mirror --reset-offsets --all-topics --to-earliest</span></span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh  --bootstrap-server <span class="number">10.201</span>.<span class="number">5.30</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">5.31</span>:<span class="number">9092</span> --execute --group mirror --reset-offsets --topic jr_tomcat --to-latest</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="Kafka集群扩容"><a href="#Kafka集群扩容" class="headerlink" title="Kafka集群扩容"></a><strong>Kafka集群扩容</strong></h4><p>Kafka集群扩容，新节点机器加入集群后，原本存在topic的partitions是不会自动迁移到新节点，只有新建的topic会分配到新节点上，这样新节点对于旧有的topic是无用的。为了旧有的topic也能用到新节点，在扩容后需要手动将旧有topic的partition迁移到新节点中。</p>
<ul>
<li><p>配置新节点并启动Kafka</p>
<p>复制现有Kafka集群节点配置，修改<code>broker.id</code>后启动Kafka。通过ZooKeeper查看新增<code>broker id</code>，验证Kafka已加入集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkCli.sh -server <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span></span><br><span class="line">[zk: <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span>(CONNECTED) <span class="number">0</span>] ls /brokers/ids</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">[zk: <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span>/(CONNECTED) <span class="number">1</span>] ls /brokers/ids</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure>
<p>查看旧有topic partition的Leader、Replicas都是没有<code>broker.id=4</code>的新节点的，只有旧的节点<code>1, 2, 3</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --describe --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --topic jr_tomcat</span><br><span class="line">Topic:jr_tomcat	PartitionCount:<span class="number">5</span>	ReplicationFactor:<span class="number">2</span>	Configs:</span><br><span class="line">	Topic: jr_tomcat	Partition: <span class="number">0</span>	Leader: <span class="number">2</span>	Replicas: <span class="number">2</span>,<span class="number">3</span>	Isr: <span class="number">2</span>,<span class="number">3</span></span><br><span class="line">	Topic: jr_tomcat	Partition: <span class="number">1</span>	Leader: <span class="number">3</span>	Replicas: <span class="number">3</span>,<span class="number">1</span>	Isr: <span class="number">3</span>,<span class="number">1</span></span><br><span class="line">	Topic: jr_tomcat	Partition: <span class="number">2</span>	Leader: <span class="number">1</span>	Replicas: <span class="number">1</span>,<span class="number">2</span>	Isr: <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">	Topic: jr_tomcat	Partition: <span class="number">3</span>	Leader: <span class="number">2</span>	Replicas: <span class="number">2</span>,<span class="number">1</span>	Isr: <span class="number">2</span>,<span class="number">1</span></span><br><span class="line">	Topic: jr_tomcat	Partition: <span class="number">4</span>	Leader: <span class="number">3</span>	Replicas: <span class="number">3</span>,<span class="number">2</span>	Isr: <span class="number">3</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成迁移分配规则文件</p>
<p>假若需要对<code>jr_tomcat</code>这个topic进行重新平衡</p>
<ul>
<li><p>创建需要迁移topic的json文件——<code>topic-to-move.json</code></p>
<p>多个topic写到<code>[]</code>数组里，用<code>,</code>分隔</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># topic-to-move.json</span></span><br><span class="line">&#123;<span class="string">"topics"</span>:</span><br><span class="line">    [&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>&#125;],</span><br><span class="line">    <span class="string">"version"</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#&#123;"topics": [&#123;"topic": "topic_1"&#125;,</span></span><br><span class="line"><span class="comment">#            &#123;"topic": "topic_2"&#125;],</span></span><br><span class="line"><span class="comment"># "version":1</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成迁移分配规则文件</p>
<p><code>broker-list</code>为所有集群节点的<code>broker.id</code></p>
<p><code>Proposed partition reassignment configuration</code>下面内容是新节点加入后的partition分配情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --topics-to-move-json-file topic-to-move.json --broker-list <span class="string">"1,2,3,4"</span> --generate</span><br><span class="line"></span><br><span class="line">Current partition replica assignment</span><br><span class="line">&#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">4</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">2</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">1</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">1</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">3</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">1</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">2</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">2</span>]&#125;]&#125;</span><br><span class="line"></span><br><span class="line">Proposed partition reassignment configuration</span><br><span class="line">&#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">2</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">4</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">1</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">3</span>,<span class="string">"replicas"</span>:[<span class="number">4</span>,<span class="number">1</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">2</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">4</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行迁移分配</p>
<p>将上一步得到的新的partition分配情况保存成<code>expand-reassignment.json</code>文件并执行partition迁移分配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --reassignment-json-file expand-reassignment.json --execute</span><br><span class="line"></span><br><span class="line">Current partition replica assignment</span><br><span class="line">&#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">4</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">2</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">1</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">1</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">3</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">1</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">2</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">2</span>]&#125;]&#125;</span><br><span class="line">Save this to use as the --reassignment-json-file option during rollback</span><br><span class="line"></span><br><span class="line">Successfully started reassignment of partitions &#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">4</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">3</span>,<span class="string">"replicas"</span>:[<span class="number">4</span>,<span class="number">1</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">1</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">2</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">4</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"jr_tomcat"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">2</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>检测执行状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --reassignment-json-file expand-reassignment.json --verify</span><br><span class="line">Status of partition reassignment:</span><br><span class="line">Reassignment of partition [jr_tomcat,<span class="number">4</span>] completed successfully</span><br><span class="line">Reassignment of partition [jr_tomcat,<span class="number">3</span>] completed successfully</span><br><span class="line">Reassignment of partition [jr_tomcat,<span class="number">1</span>] completed successfully</span><br><span class="line">Reassignment of partition [jr_tomcat,<span class="number">2</span>] completed successfully</span><br><span class="line">Reassignment of partition [jr_tomcat,<span class="number">0</span>] completed successfully</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="增加topic的replication数量"><a href="#增加topic的replication数量" class="headerlink" title="增加topic的replication数量"></a><strong>增加topic的replication数量</strong></h4><ul>
<li><p>查看topic情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --describe --topic <span class="built_in">test</span></span><br><span class="line">Topic:<span class="built_in">test</span>	PartitionCount:<span class="number">3</span>	ReplicationFactor:<span class="number">2</span>	Configs:</span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">0</span>	Leader: <span class="number">3</span>	Replicas: <span class="number">3</span>,<span class="number">2</span>	Isr: <span class="number">3</span>,<span class="number">2</span></span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">1</span>	Leader: <span class="number">1</span>	Replicas: <span class="number">1</span>,<span class="number">2</span>	Isr: <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">2</span>	Leader: <span class="number">2</span>	Replicas: <span class="number">2</span>,<span class="number">3</span>	Isr: <span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对单独partition增加replication</p>
<p>先对<code>partition 0</code>增加replication</p>
<ul>
<li><p>准备文件——<code>increase-replication-factor.json</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"test"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行增加replication操作。执行后会显示旧有配置，提示保存以便回滚。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --reassignment-json-file increase-replication-factor.json --execute</span><br><span class="line"></span><br><span class="line">Current partition replica assignment</span><br><span class="line">&#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"test"</span>,<span class="string">"partition"</span>:<span class="number">1</span>,<span class="string">"replicas"</span>:[<span class="number">1</span>,<span class="number">2</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"test"</span>,<span class="string">"partition"</span>:<span class="number">2</span>,<span class="string">"replicas"</span>:[<span class="number">2</span>,<span class="number">3</span>]&#125;,&#123;<span class="string">"topic"</span>:<span class="string">"test"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">2</span>]&#125;]&#125;</span><br><span class="line">Save this to use as the --reassignment-json-file option during rollback</span><br><span class="line">Successfully started reassignment of partitions &#123;<span class="string">"version"</span>:<span class="number">1</span>,<span class="string">"partitions"</span>:[&#123;<span class="string">"topic"</span>:<span class="string">"test"</span>,<span class="string">"partition"</span>:<span class="number">0</span>,<span class="string">"replicas"</span>:[<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>确认执行情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --reassignment-json-file increase-replication-factor.json --verify</span><br><span class="line"></span><br><span class="line">Status of partition reassignment:</span><br><span class="line">Reassignment of partition [<span class="built_in">test</span>,<span class="number">0</span>] completed successfully</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看partition分区情况</p>
<p><code>partition 0</code>的replicas已从<code>3,1</code>增加为<code>3,2,1</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --describe --topic <span class="built_in">test</span></span><br><span class="line">Topic:<span class="built_in">test</span>	PartitionCount:<span class="number">3</span>	ReplicationFactor:<span class="number">2</span>	Configs:</span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">0</span>	Leader: <span class="number">3</span>	Replicas: <span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>	Isr: <span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span></span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">1</span>	Leader: <span class="number">1</span>	Replicas: <span class="number">1</span>,<span class="number">2</span>	Isr: <span class="number">1</span>,<span class="number">2</span></span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: <span class="number">2</span>	Leader: <span class="number">2</span>	Replicas: <span class="number">2</span>,<span class="number">3</span>	Isr: <span class="number">2</span>,<span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>批量增加剩余partition的replication</p>
<p>修改<code>increase-replication-factor.json</code>文件，执行增加命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --reassignment-json-file increase-replication-factor.json --execute</span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-reassign-partitions.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --reassignment-json-file increase-replication-factor.json --verify</span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-topics.sh --zookeeper <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> --describe --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Kafka集群间数据同步——MirrorMaker"><a href="#Kafka集群间数据同步——MirrorMaker" class="headerlink" title="Kafka集群间数据同步——MirrorMaker"></a><strong>Kafka集群间数据同步——MirrorMaker</strong></h4><p>KafkaMirrorMaker提供不同Kafka集群之间数据同步，基本就是从Source Kafka Cluster消费消息然后生产到Target Kafka Cluster中。若Target Kafka Cluster中不存在topic，KafkaMirrorMaker会自动在Target Kafka Cluster上创建和Source Kafka Cluster完全相同的topic(topic_name、partition、replication)。从Kafka0.9版本开始引入新的consumer api，默认是使用旧版api，使用<code>--new.consumer</code>参数可指定使用新版api。</p>
<ul>
<li><p>mirror_maker_consumer.config</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新版consumer</span></span><br><span class="line">bootstrap.servers=<span class="number">10.201</span>.<span class="number">5.30</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">5.31</span>:<span class="number">9092</span></span><br><span class="line"><span class="comment">#旧版comsumer</span></span><br><span class="line"><span class="comment">#zookeeper.connect=10.201.5.30:2181,10.201.5.31:2181</span></span><br><span class="line"><span class="comment">#default request timeout 40000</span></span><br><span class="line">request.timeout.ms=<span class="number">50000</span></span><br><span class="line"><span class="comment">#default heartbeat interval 3000</span></span><br><span class="line">heartbeat.interval.ms=<span class="number">15000</span></span><br><span class="line"><span class="comment">#default session timeout 30000</span></span><br><span class="line">session.timeout.ms=<span class="number">40000</span></span><br><span class="line"><span class="comment">#consumer group id</span></span><br><span class="line">group.id=mirrormaker</span><br><span class="line">partition.assignment.strategy=org.apache.kafka.clients.consumer.RoundRobinAssignor</span><br><span class="line"><span class="comment">#default max poll records 2147483647</span></span><br><span class="line">max.poll.records=<span class="number">20000</span></span><br><span class="line"><span class="comment">#default receive buffer 64kB, now 512kb</span></span><br><span class="line">receive.buffer.bytes=<span class="number">524288</span></span><br><span class="line"><span class="comment">#default max amount of data per partition to override 1048576</span></span><br><span class="line">max.partition.fetch.bytes=<span class="number">5248576</span></span><br><span class="line"><span class="comment">#consumer timeout</span></span><br><span class="line"><span class="comment">#consumer.timeout.ms=5000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mirror_maker_producer.config</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.servers=<span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">9092</span></span><br><span class="line"><span class="comment">#buffer.memory=134217728</span></span><br><span class="line">batch.size=<span class="number">32768</span></span><br><span class="line">receive.buffer.bytes=<span class="number">327680</span></span><br><span class="line">send.buffer.bytes=<span class="number">262144</span></span><br><span class="line">max.request.size=<span class="number">10485760</span></span><br><span class="line">linger.ms=<span class="number">3000</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动KafkaMirrorMaker</p>
<p><code>--whitelist</code>支持正则匹配符<code>|</code>，也支持<code>,</code>，比如<code>--whitelist &#39;nginx_log|tomcat_log&#39;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-mirror-maker.sh --new.consumer --consumer.config mirror_maker_consumer.config --num.streams <span class="number">3</span> --producer.config mirror_maker_producer.config --whitelist=<span class="string">"nginx_log"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看生产消费情况</p>
<p>在mirror consumer端查看消费情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-consumer-groups.sh --bootstrap-server <span class="number">10.201</span>.<span class="number">5.30</span>:<span class="number">9092</span>,<span class="number">10.201</span>.<span class="number">5.31</span>:<span class="number">9092</span> --describe --group mirrormaker --new-consumer</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="KafkaOffsetMonitor监控部署"><a href="#KafkaOffsetMonitor监控部署" class="headerlink" title="KafkaOffsetMonitor监控部署"></a><strong>KafkaOffsetMonitor监控部署</strong></h4><p>KafkaOffsetMonitor监控Kafka消费队列堆积情况</p>
<p>下载<a href="https://github.com/quantifind/KafkaOffsetMonitor/releases/download/v0.2.1/KafkaOffsetMonitor-assembly-0.2.1.jar" target="_blank" rel="external">KafkaOffsetMonitor-assembly-0.2.1.jar</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java -cp KafkaOffsetMonitor-assembly-<span class="number">0.2</span>.<span class="number">1</span>.jar \</span><br><span class="line">    com.quantifind.kafka.offsetapp.OffsetGetterWeb \</span><br><span class="line">    --zk <span class="number">10.201</span>.<span class="number">3.222</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.223</span>:<span class="number">2181</span>,<span class="number">10.201</span>.<span class="number">3.224</span>:<span class="number">2181</span> \</span><br><span class="line">    --port <span class="number">8088</span> \</span><br><span class="line">    --refresh <span class="number">30</span>.seconds \</span><br><span class="line">    --retain <span class="number">7</span>.days</span><br></pre></td></tr></table></figure>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/kafka/">kafka</a>

					</div>

				

			</article>

			<div class="content-nav">

				
					<a href="/2017/11/22/OpenLDAP/" title="OpenLDAP简录">&larr; Prev</a>
				

				
					<a href="/2017/08/23/RabbitMQ/" title="RabbitMQ">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
