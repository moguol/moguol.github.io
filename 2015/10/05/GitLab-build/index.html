<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" GitLab搭建记 | Hexo " />
	<meta name="twitter:title" content=" GitLab搭建记 | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" GitLab搭建记 | Hexo ">
	<meta property="og:description" content=" GitLab搭建记 | Hexo " />
	<meta name="twitter:description" content=" GitLab搭建记 | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2015/10/05/GitLab-build/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2015-10-05">2015-10-05</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/OPS/">OPS</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2015/10/05/GitLab-build/" itemprop="url"><span itemprop="name">GitLab搭建记</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
					<p>&emsp;最近在系统的学习<strong>Git</strong>，需要用到远程仓库，于是想搭个<strong>GitLab</strong>玩玩。没想到想玩好GitLab也不是件容易的事情，即便是按照教程来搭都折腾了挺久，GitLab对各软件版本的要求比较苛刻，所以搭建起来也比较麻烦，在此记录一下搭建的过程以便备忘，其实如果不想折腾可直接使用<a href="https://github.com/" target="_blank" rel="external">GitHub</a>。<br>&emsp;本文记录在<strong>CentOS6.4 64bit</strong>上搭建<strong>GitLab</strong>的过程，搭建<strong>GitLab</strong>需要涉及到如下软件：</p>
<ul>
<li>Git</li>
<li>Ruby</li>
<li>MySQL</li>
<li>Redis</li>
<li>GitLab</li>
<li>GitLab-shell</li>
<li>Gem</li>
<li>Nginx</li>
</ul>
<h3 id="安装依赖"><strong>安装依赖</strong></h3><p>&emsp;添加EPEL源<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; wget -O <span class="regexp">/etc/</span>pki<span class="regexp">/rpm-gpg/</span>RPM-GPG-KEY-EPEL-<span class="number">6</span> <span class="string">https:</span><span class="comment">//www.fedoraproject.org/static/0608B895.txt --no-check-certificate</span></span><br><span class="line">shell&gt; rpm --<span class="keyword">import</span> <span class="regexp">/etc/</span>pki<span class="regexp">/rpm-gpg/</span>RPM-GPG-KEY-EPEL-<span class="number">6</span></span><br><span class="line">shell&gt; rpm -Uvh <span class="string">http:</span><span class="comment">//dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">#验证安装</span><br><span class="line">shell&gt; rpm -qa gpg-pubkey</span><br><span class="line">gpg-pubkey-<span class="number">0608</span>b895-<span class="number">4</span>bd22942</span><br></pre></td></tr></table></figure></p>
<p>&emsp;添加puias源<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; wget -O <span class="regexp">/etc/</span>yum.repos.d<span class="regexp">/PUIAS_6_computational.repo https:/</span><span class="regexp">/gitlab.com/</span>gitlab-org<span class="regexp">/gitlab-recipes/</span>raw<span class="regexp">/master/</span>install<span class="regexp">/centos/</span>PUIAS_6_computational.repo</span><br><span class="line">shell&gt; wget -O <span class="regexp">/etc/</span>pki<span class="regexp">/rpm-gpg/</span>RPM-GPG-KEY-puias <span class="string">http:</span><span class="comment">//springdale.math.ias.edu/data/puias/6/x86_64/os/RPM-GPG-KEY-puias</span></span><br><span class="line">shell&gt; rpm --<span class="keyword">import</span> <span class="regexp">/etc/</span>pki<span class="regexp">/rpm-gpg/</span>RPM-GPG-KEY-puias</span><br><span class="line"></span><br><span class="line">#验证安装</span><br><span class="line">shell&gt; rpm -qa gpg-pubkey</span><br><span class="line">gpg-pubkey-<span class="number">41</span>a40948-<span class="number">4</span>ce19266</span><br></pre></td></tr></table></figure></p>
<p>&emsp;查看以上添加的EPEL和puias源<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; yum repolist</span><br><span class="line">Loaded <span class="string">plugins:</span> fastestmirror, refresh-packagekit, security</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * <span class="string">PUIAS_6_computational:</span> puias.math.ias.edu</span><br><span class="line"> * <span class="string">base:</span> ftp.sjtu.edu.cn</span><br><span class="line"> * <span class="string">extras:</span> mirrors.nwsuaf.edu.cn</span><br><span class="line"> * <span class="string">updates:</span> ftp.sjtu.edu.cn</span><br><span class="line">PUIAS_6_computational                                                                                                   | <span class="number">3.3</span> kB     <span class="number">00</span>:<span class="number">00</span></span><br><span class="line">PUIAS_6_computational/primary_db                                                                                        | <span class="number">1.9</span> MB     <span class="number">00</span>:<span class="number">15</span></span><br><span class="line">repo id                                                 repo name                                                                        status</span><br><span class="line">PUIAS_6_computational                                   PUIAS computational Base <span class="number">6</span> - x86_64                                               <span class="number">2</span>,<span class="number">837</span></span><br><span class="line">base                                                    CentOS-<span class="number">6</span> - Base                                                                   <span class="number">6</span>,<span class="number">575</span></span><br><span class="line">epel                                                    Extra Packages <span class="keyword">for</span> Enterprise Linux <span class="number">6</span> - x86_64                                   <span class="number">11</span>,<span class="number">764</span></span><br><span class="line">extras                                                  CentOS-<span class="number">6</span> - Extras                                                                    <span class="number">35</span></span><br><span class="line">treasuredata                                            TreasureData                                                                         <span class="number">14</span></span><br><span class="line">updates                                                 CentOS-<span class="number">6</span> - Updates                                                                  <span class="number">298</span></span><br><span class="line"><span class="string">repolist:</span> <span class="number">21</span>,<span class="number">523</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;安装依赖包<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y groupinstall <span class="string">'Development Tools'</span></span><br><span class="line">yum -y install gcc-c++ readline-devel zlib-devel libffi-devel openssl-devel <span class="built_in">make</span> autoconf automake libtool bison libxml2-devel libxslt-devel libyaml-devel</span><br></pre></td></tr></table></figure></p>
<h3 id="添加Git系统用户"><strong>添加Git系统用户</strong></h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; adduser --system --shell /bin/bash --comment <span class="string">'GitLab'</span> --create-home --home-dir /home/git/ git</span><br><span class="line"><span class="comment">#将/usr/local/bin添加到系统默认路径</span></span><br><span class="line">shell&gt; visudo</span><br><span class="line">	<span class="constant">Defaults </span>   secure_path = <span class="regexp">/sbin:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span><span class="symbol">:/usr/local/bin</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装Git"><strong>编译安装Git</strong></h3><p>&emsp;需要确保<code>Git</code>的版本在<strong><code>1.7.10</code></strong>或以上，CentOS6.4通过<code>yum</code>的版本是<strong><code>1.7.1</code></strong>，要手动编译安装更高版本<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#如果通过yum安装过Git，需要先删除</span><br><span class="line"><span class="keyword">shell</span>&gt; yum <span class="built_in">remove</span> git</span><br><span class="line"><span class="keyword">shell</span>&gt; yum install zlib-devel <span class="keyword">perl</span>-CPAN gettext curl-devel expat-devel gettext-devel openssl-devel</span><br><span class="line"><span class="keyword">shell</span>&gt; wget http<span class="variable">s:</span>//www.kernel.org/pub/software/scm/git/git-<span class="number">2.5</span>.<span class="number">3</span>.tar.gz</span><br><span class="line"><span class="keyword">shell</span>&gt; tar -zxf git-<span class="number">2.5</span>.<span class="number">3</span>.tar.gz &amp;&amp; <span class="keyword">cd</span> git-<span class="number">2.5</span>.<span class="number">3</span></span><br><span class="line"><span class="keyword">shell</span>&gt; ./configure &amp;&amp; <span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> prefix=/usr/local install</span><br><span class="line"><span class="keyword">shell</span>&gt; git --<span class="keyword">version</span></span><br><span class="line">git <span class="keyword">version</span> <span class="number">2.5</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="编译安装ruby"><strong>编译安装ruby</strong></h3><p>&emsp;<strong><code>ruby</code></strong>需要<strong><code>2.0+</code></strong>的版本，CentOS6.4通过<code>yum</code>安装的版本是<strong><code>1.8</code></strong><br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果通过yum安装过ruby，需要先删除</span></span><br><span class="line"><span class="built_in">shell</span>&gt; yum remove ruby</span><br><span class="line"><span class="built_in">shell</span>&gt; wget <span class="keyword">ftp</span>://<span class="keyword">ftp</span>.ruby-lang.org/pub/ruby/<span class="number">2.1</span>/ruby-<span class="number">2.1</span><span class="number">.2</span>.tar.gz</span><br><span class="line"><span class="built_in">shell</span>&gt; tar -zxf ruby-<span class="number">2.1</span><span class="number">.2</span>.tar.gz &amp;&amp; cd ruby-<span class="number">2.1</span><span class="number">.2</span></span><br><span class="line"><span class="built_in">shell</span>&gt; ./configure <span class="comment">--disable-install-rdoc &amp;&amp; make &amp;&amp; make prefix=/usr/local install</span></span><br><span class="line"><span class="built_in">shell</span>&gt; ruby -v</span><br><span class="line">ruby <span class="number">2.1</span><span class="number">.2</span>p95 (<span class="number">2014</span>-<span class="number">05</span>-<span class="number">08</span> revision <span class="number">45877</span>) [x86_64-linux]</span><br></pre></td></tr></table></figure></p>
<p>&emsp;安装bundler，由于<code>https://rubygems.org/</code>被墙，需要修改ruby源<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; gem sources --<span class="built_in">remove</span> http<span class="variable">s:</span>//rubygems.org/</span><br><span class="line"><span class="keyword">shell</span>&gt; gem sources -<span class="keyword">a</span> http<span class="variable">s:</span>//<span class="keyword">ruby</span>.taobao.org/</span><br><span class="line"><span class="keyword">shell</span>&gt; gem sources -<span class="keyword">l</span></span><br><span class="line"><span class="keyword">shell</span>&gt; gem install bundler --<span class="keyword">no</span>-doc</span><br></pre></td></tr></table></figure></p>
<h3 id="安装MySQL数据库"><strong>安装MySQL数据库</strong></h3><p>&emsp;官方推荐使用<strong>MySQL</strong>或<strong>PostgreSQL</strong>作为数据库，如果使用MySQL版本需要高于<strong><code>5.5.14</code></strong>，CentOS6.4通过<code>yum</code>默认安装版本为<strong><code>5.1.73</code></strong>，这里使用<code>yum</code>安装<strong><code>5.5.45</code></strong><br>&emsp;安装MySQL 5.5.45<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shell</span>&gt; rpm -Uvh <span class="keyword">http</span>://dl.fedoraproject.org/pub/epel/<span class="number">6</span>/i386/epel-release-<span class="number">6</span>-<span class="number">8.</span>noarch.rpm</span><br><span class="line"><span class="built_in">shell</span>&gt; rpm -Uvh <span class="keyword">http</span>://rpms.famillecollet.com/enterprise/remi-release-<span class="number">6.</span>rpm</span><br><span class="line"><span class="built_in">shell</span>&gt; yum <span class="comment">--enablerepo=remi,remi-test install mysql mysql-server mysql-devel</span></span><br><span class="line"><span class="built_in">shell</span>&gt; mysql <span class="comment">--version</span></span><br><span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.5</span><span class="number">.45</span>, <span class="keyword">for</span> Linux (x86_64) <span class="keyword">using</span> readline <span class="number">5.1</span></span><br><span class="line"><span class="built_in">shell</span>&gt; /etc/init.d/mysqld start</span><br><span class="line"><span class="built_in">shell</span>&gt; mysql_secure_installation</span><br><span class="line"><span class="comment">#mysql_secure_installation作用</span></span><br><span class="line">	<span class="comment">#为root用户设置密码</span></span><br><span class="line">	<span class="comment">#删除匿名账号</span></span><br><span class="line">	<span class="comment">#取消root用户远程登录</span></span><br><span class="line">	<span class="comment">#删除test库和对test库的访问权限</span></span><br><span class="line">	<span class="comment">#刷新授权表使修改生效</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;创建GitLab所需数据库用户<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell &gt; mysql -uroot -p</span><br><span class="line">		mysql&gt; <span class="keyword">CREATE</span> USER <span class="string">'git'</span>@<span class="string">'localhost'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'gitlab'</span>;</span><br><span class="line">		mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;GitLab需要用INNODB，设置默认存储引擎为INNODB<br>&emsp;&emsp;配置文件设置my.cnf<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"><span class="default"><span class="keyword">default</span>-storage-engine = innodb</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;命令行设置<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET storage<span class="emphasis">_engine=INNODB;</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE '%engine';</span><br><span class="line">+------------------------+---------+</span><br><span class="line">| Variable_</span>name          | Value   |</span><br><span class="line">|------------------------+---------|</span><br><span class="line">| default<span class="emphasis">_storage_</span>engine | InnoDB  |</span><br><span class="line"><span class="header">| storage_engine         | InnoDB  |</span><br><span class="line">+------------------------+---------+</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;创建GitLab相关数据库及授权<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="subst">&gt;</span> CREATE DATABASE <span class="keyword">IF</span> <span class="literal">NOT</span> EXISTS <span class="string">`gitlabhq_production`</span> DEFAULT CHARACTER <span class="built_in">SET</span> <span class="string">`utf8`</span> COLLATE <span class="string">`utf8_unicode_ci`</span>;</span><br><span class="line">mysql<span class="subst">&gt;</span> GRANT <span class="keyword">SELECT</span>, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER <span class="keyword">ON</span> <span class="string">`gitlabhq_production`</span><span class="built_in">.</span><span class="subst">*</span> <span class="keyword">TO</span> <span class="string">'git'</span>@<span class="string">'localhost'</span>;</span><br><span class="line">mysql<span class="subst">&gt;</span> FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;登陆验证<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; mysql -ugit -p -<span class="keyword">D</span> gitlabhq_production</span><br></pre></td></tr></table></figure></p>
<h3 id="安装Redis"><strong>安装Redis</strong></h3><p>&emsp;使用<code>yum</code>安装<strong>Redis</strong>，完全按照官方文档配置无任何优化<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; yum install redis</span><br><span class="line"><span class="keyword">shell</span>&gt; cp /etc/redis.<span class="keyword">conf</span> /etc/redis.<span class="keyword">conf</span>.org</span><br><span class="line"><span class="keyword">shell</span>&gt; sed 's/^port .*/port 0/' /etc/redis.<span class="keyword">conf</span>.org |tee /etc/redis.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">shell</span>&gt; echo 'unixsocket /<span class="keyword">var</span>/<span class="keyword">run</span>/redis/redis.sock' |tee -a /etc/redis.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">shell</span>&gt; echo -<span class="keyword">e</span> 'unixsocketperm 0770' |tee -a /etc/redis.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">shell</span>&gt; chown redis:redis /<span class="keyword">var</span>/<span class="keyword">run</span>/redis</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod 755 /<span class="keyword">var</span>/<span class="keyword">run</span>/redis</span><br><span class="line"><span class="keyword">shell</span>&gt; usermod -aG redis git</span><br><span class="line"><span class="keyword">shell</span>&gt; /etc/init.<span class="keyword">d</span>/redis start</span><br></pre></td></tr></table></figure></p>
<h3 id="安装GitLab"><strong>安装GitLab</strong></h3><h4 id="GitLab配置"><strong>GitLab配置</strong></h4><p>&emsp;在配置文件<code>config/unicorn.rb</code>时中有个<strong><code>timeout</code></strong>设置，若机器性能差需要将<strong><code>timeout</code></strong>值设置大些，否则<code>GitLab</code>在初始化时可能超时<br>&emsp;<code>host</code>最好填域名，此处使用HTTPS<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; <span class="keyword">cd</span> /home/git</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> git clone https:<span class="comment">//gitlab.com/gitlab-org/gitlab-ce.git -b 7-4-stable gitlab</span></span><br><span class="line"><span class="keyword">shell</span>&gt; <span class="keyword">cd</span> gitlab/</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> cp config/gitlab.yml.example config/gitlab.yml</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> vim config/gitlab.yml</span><br><span class="line">			  gitlab:</span><br><span class="line">				host: yourdomain</span><br><span class="line">				port: 443</span><br><span class="line">				https: true</span><br><span class="line"><span class="keyword">shell</span>&gt; chown -R git <span class="keyword">log</span>/</span><br><span class="line"><span class="keyword">shell</span>&gt; chown -R git tmp/</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod -R <span class="keyword">u</span>+rwX <span class="keyword">log</span>/</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod -R <span class="keyword">u</span>+rwX tmp/</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod -R <span class="keyword">u</span>+rwX tmp/pids/</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod -R <span class="keyword">u</span>+rwX tmp/sockets/</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod -R <span class="keyword">u</span>+rwX  public/uploads</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> <span class="keyword">mkdir</span> /home/git/gitlab-satellites</span><br><span class="line"><span class="keyword">shell</span>&gt; chmod <span class="keyword">u</span>+rwx,<span class="keyword">g</span>=rx,o-rwx /home/git/gitlab-satellites</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> cp config/unicorn.rb.example config/unicorn.rb</span><br><span class="line">#查看系统核心数</span><br><span class="line"><span class="keyword">shell</span>&gt; nproc</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> vim config/unicorn.rb</span><br><span class="line">			worker_processes 核心数</span><br></pre></td></tr></table></figure></p>
<h4 id="配置全局用户及邮箱"><strong>配置全局用户及邮箱</strong></h4><p>&emsp;此处使用163邮箱作为GitLab的发送邮箱<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> git config --<span class="keyword">global</span> user.name <span class="string">"GitLab"</span></span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> git config --<span class="keyword">global</span> user.email <span class="string">"username@163.com"</span></span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> git config --<span class="keyword">global</span> core.autocrlf <span class="keyword">input</span></span><br></pre></td></tr></table></figure></p>
<h4 id="GitLab_SMTP设置"><strong>GitLab SMTP设置</strong></h4><p>&emsp;<code>GitLab</code>默认使用<strong>Sendmail</strong>进行邮件的发送，邮件发送配置比较重要，当新建用户时<code>GitLab</code>会发送一封邮件给用户并要求重置密码，若要使用<strong>SMTP</strong>发送邮件则需如下配置(此处用的是163邮箱)。<br>&emsp;编辑配置文件<strong><code>sudo -u git -H vim /home/git/gitlab/config/environments/production.rb</code></strong><br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config<span class="class">.action_mailer</span><span class="class">.delivery_method</span>= :smtp</span><br></pre></td></tr></table></figure></p>
<p>&emsp;编辑配置文件<strong><code>sudo -u git -H vim /home/git/gitlab/config/initializers/smtp_settings.rb</code></strong><br>&emsp;<strong><code>domain</code></strong>选项用于重置密码时访问的<code>GitLab</code>域名，根据自身情况配置，如<code>domain: &quot;test.com:8080&quot;</code><br>&emsp;<strong><code>enable_starttls_auto</code></strong>假若SMTP没有开启加密连接则此值设置为<code>false</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; cp <span class="regexp">/home/</span>git<span class="regexp">/gitlab/</span>config<span class="regexp">/initializers/</span>smtp_settings.rb.sample <span class="regexp">/home/</span>git<span class="regexp">/gitlab/</span>config<span class="regexp">/initializers/</span>smtp_settings.rb</span><br><span class="line">#smtp_settings.rb</span><br><span class="line">	<span class="keyword">if</span> Rails.env.production?</span><br><span class="line">	  Gitlab::Application.config.action_mailer.delivery_method = :smtp</span><br><span class="line"><span class="label"></span><br><span class="line">	  ActionMailer:</span>:Base.smtp_settings = &#123;</span><br><span class="line"><span class="label">		address:</span> <span class="string">"smtp.163.com"</span>,</span><br><span class="line"><span class="label">		port:</span> <span class="number">25</span>,</span><br><span class="line"><span class="label">		user_name:</span> <span class="string">"username@163.com"</span>,</span><br><span class="line"><span class="label">		password:</span> <span class="string">"password"</span>,</span><br><span class="line"><span class="label">		domain:</span> <span class="string">"domain.com"</span>,</span><br><span class="line"><span class="label">		authentication:</span> :login,</span><br><span class="line"><span class="label">		enable_starttls_auto:</span> <span class="literal">false</span></span><br><span class="line">	  &#125;</span><br><span class="line">	end</span><br></pre></td></tr></table></figure></p>
<p>&emsp;假若SMTP服务器只允许以用登陆方式发送邮件，则还需要配置<strong><code>sudo -u git -H vim /home/git/gitlab/config/gitlab.yml</code></strong><br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">email_from</span>: username<span class="variable">@163</span>.com</span><br></pre></td></tr></table></figure></p>
<h3 id="GitLab连接Redis配置"><strong>GitLab连接Redis配置</strong></h3><p>&emsp;假若redis有自定义优化配置，则按自身需求修改配置文件<code>sudo -u git -H vim /home/git/gitlab/config/resque.yml</code>，否则按照默然配置(此处按照默认)<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; sudo -u git -H cp <span class="regexp">/home/gi</span>t<span class="regexp">/gitlab/</span>config<span class="regexp">/resque.yml.example /</span>home<span class="regexp">/git/gi</span>tlab<span class="regexp">/config/</span>resque.yml</span><br></pre></td></tr></table></figure></p>
<h3 id="GitLab连接MySQL配置"><strong>GitLab连接MySQL配置</strong></h3><p>&emsp;根据自身MySQL配置修改文件<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; sudo -u git cp <span class="regexp">/home/</span>git<span class="regexp">/gitlab/</span>config<span class="regexp">/database.yml.mysql /</span>home<span class="regexp">/git/</span>gitlab<span class="regexp">/config/</span>database.yml</span><br><span class="line">shell&gt; sudo -u git -H vim <span class="regexp">/home/</span>git<span class="regexp">/gitlab/</span>config/database.yml</span><br><span class="line"><span class="label">			production:</span></span><br><span class="line"><span class="label">				adapter:</span> mysql2</span><br><span class="line"><span class="label">				encoding:</span> utf8</span><br><span class="line"><span class="label">				collation:</span> utf8_general_ci</span><br><span class="line"><span class="label">				reconnect:</span> <span class="literal">false</span></span><br><span class="line"><span class="label">				database:</span> gitlabhq_production</span><br><span class="line"><span class="label">				pool:</span> <span class="number">10</span></span><br><span class="line"><span class="label">				username:</span> git</span><br><span class="line"><span class="label">				password:</span> <span class="string">"gitlab"</span></span><br><span class="line"><span class="label">				host:</span> localhost</span><br><span class="line"><span class="label">				socket:</span> <span class="regexp">/var/</span>lib<span class="regexp">/mysql/</span>mysql.sock</span><br></pre></td></tr></table></figure></p>
<h3 id="安装Gem"><strong>安装Gem</strong></h3><p>&emsp;如果太慢或根本无法下载安装，则可把<strong><code>/home/git/gitlab/Gemfile</code></strong>中的源需要改成淘宝的源<br>&emsp;安装前需要先安装libicu-devel及cmake，否则会报错<code>An error occurred while installing charlock_holmes (0.6.9.4)/rugged (0.21.2), and Bundler cannot continue.</code><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; yum -y install libicu-devel cmake</span><br><span class="line"></span><br><span class="line">#修改源</span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> vim /home/git/gitlab/Gemfile</span><br><span class="line">			source 'https:<span class="comment">//ruby.taobao.org/'</span></span><br><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> bundle install --deployment --without development <span class="keyword">test</span> postgres aws</span><br></pre></td></tr></table></figure></p>
<h3 id="安装GitLat_shell"><strong>安装GitLat shell</strong></h3><p>&emsp;根据自身情况可修改<code>GitLab shell</code>的配置文件<strong><code>sudo -u git -H vim /home/git/gitlab-shell/config.yml</code></strong><br>&emsp;<code>GitLab-shell</code>的版本使用<strong><code>2.0.1</code></strong>，原本使用<strong><code>2.2.0</code></strong>版本但在<code>git push</code>的时候会报错，此为GitLab-shell版本的问题导致。可以通过<strong><code>sudo -u git -H bundle exec rake gitlab:check RAILS_ENV=production</code></strong>该命令检查<code>GitLab-shell</code>是否正确<br>&emsp;<code>git push</code>时报错内容如下：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Check GitLab API access: /home/git/gitlab-shell/<span class="keyword">lib</span>/gitlab_net.rb:<span class="number">122</span>:<span class="keyword">in</span> `read<span class="comment">': No such file or directory @ rb_sysopen - /home/git/gitlab-shell/.gitlab_shell_secret (Errno::ENOENT)</span></span><br><span class="line">        <span class="keyword">from</span> /home/git/gitlab-shell/<span class="keyword">lib</span>/gitlab_net.rb:<span class="number">122</span>:<span class="keyword">in</span> `secret_token<span class="comment">'</span></span><br><span class="line">        <span class="keyword">from</span> /home/git/gitlab-shell/<span class="keyword">lib</span>/gitlab_net.rb:<span class="number">79</span>:<span class="keyword">in</span> `<span class="keyword">get</span><span class="comment">'</span></span><br><span class="line">        <span class="keyword">from</span> /home/git/gitlab-shell/<span class="keyword">lib</span>/gitlab_net.rb:<span class="number">39</span>:<span class="keyword">in</span> `check<span class="comment">'</span></span><br><span class="line">        <span class="keyword">from</span> /home/git/gitlab-shell/bin/check:<span class="number">11</span>:<span class="keyword">in</span> `&lt;main&gt;<span class="comment">''</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;<del>2.2.0</del>版本试过有问题，git push报错，请使用2.0.1版本<br><del>shell&gt; sudo -u git -H bundle exec rake gitlab:shell:install[v2.2.0] REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production</del><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> bundle exec rake gitlab:<span class="keyword">shell</span>:install[v2.0.1] REDIS_URL=unix:/<span class="keyword">var</span>/<span class="keyword">run</span>/redis/redis.sock RAILS_ENV=production</span><br></pre></td></tr></table></figure></p>
<p>&emsp;<strong><code>/home/git/gitlab-shell/config.yml</code></strong>的配置，是否使用HTTPS决定某些配置项的细微差别(以下是使用HTTPS)<br>&emsp;<strong><code>gitlab_url</code></strong>和<strong><code>self_signed_cert</code></strong>的配置必须匹配，否则在<strong><code>git push</code></strong>的时候会报错<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="string">user:</span> git</span><br><span class="line"><span class="string">gitlab_url:</span> <span class="string">https:</span><span class="comment">//yourdomain/</span></span><br><span class="line"><span class="string">http_settings:</span></span><br><span class="line"><span class="label">  self_signed_cert:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">repos_path:</span> <span class="string">"/home/git/repositories/"</span></span><br><span class="line"><span class="string">auth_file:</span> <span class="string">"/home/git/.ssh/authorized_keys"</span></span><br><span class="line"><span class="string">redis:</span></span><br><span class="line"><span class="label">  bin:</span> <span class="string">"/usr/bin/redis-cli"</span></span><br><span class="line"><span class="label">  namespace:</span> <span class="string">resque:</span>gitlab</span><br><span class="line"><span class="label">  socket:</span> <span class="string">"/var/run/redis/redis.sock"</span></span><br><span class="line"><span class="string">log_level:</span> INFO</span><br><span class="line"><span class="string">audit_usernames:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<h3 id="初始化数据库"><strong>初始化数据库</strong></h3><p>&emsp;设置<code>GitLab</code>的root用户密码并初始化数据库<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">shell</span>&gt; sudo -<span class="keyword">u</span> git -<span class="keyword">H</span> bundle exec rake gitlab:setup RAILS_ENV=production GITLAB_ROOT_PASSWORD=your_gitlab_root_passwd</span><br></pre></td></tr></table></figure></p>
<h3 id="下载GitLab脚本"><strong>下载GitLab脚本</strong></h3><p>&emsp;下载管理<code>GitLab</code>的脚本，设置<code>logrotate</code>，检查应用状态<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; wget -O <span class="regexp">/etc/</span>init.d<span class="regexp">/gitlab https:/</span><span class="regexp">/gitlab.com/</span>gitlab-org<span class="regexp">/gitlab-recipes/</span>raw<span class="regexp">/master/</span>init<span class="regexp">/sysvinit/</span>centos/gitlab-unicorn --no-check-certificate</span><br><span class="line">shell&gt; chmod a+x <span class="regexp">/etc/</span>init.d/gitlab</span><br><span class="line">shell&gt; cp lib<span class="regexp">/support/</span>logrotate<span class="regexp">/gitlab /</span>etc<span class="regexp">/logrotate.d/</span>gitlab</span><br><span class="line">shell&gt; sudo -u git -H bundle exec rake <span class="string">gitlab:</span><span class="string">env:</span>info RAILS_ENV=production</span><br><span class="line">			System information</span><br><span class="line"><span class="label">			System:</span>         CentOS <span class="number">6.4</span></span><br><span class="line">			Current <span class="string">User:</span>   git</span><br><span class="line">			Using <span class="string">RVM:</span>      no</span><br><span class="line">			Ruby <span class="string">Version:</span>   <span class="number">2.1</span><span class="number">.2</span>p95</span><br><span class="line">			Gem <span class="string">Version:</span>    <span class="number">2.2</span><span class="number">.2</span></span><br><span class="line">			Bundler <span class="string">Version:</span><span class="number">1.10</span><span class="number">.6</span></span><br><span class="line">			Rake <span class="string">Version:</span>   <span class="number">10.3</span><span class="number">.2</span></span><br><span class="line">			Sidekiq <span class="string">Version:</span><span class="number">2.17</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">			GitLab information</span><br><span class="line"><span class="label">			Version:</span>        <span class="number">7.4</span><span class="number">.5</span></span><br><span class="line"><span class="label">			Revision:</span>       <span class="number">19</span>d572e</span><br><span class="line"><span class="label">			Directory:</span>      <span class="regexp">/home/</span>git/gitlab</span><br><span class="line">			DB <span class="string">Adapter:</span>     mysql2</span><br><span class="line"><span class="label">			URL:</span>            <span class="string">http:</span><span class="comment">//yourdomain</span></span><br><span class="line">			HTTP Clone <span class="string">URL:</span> <span class="string">http:</span><span class="comment">//yourdomain/some-project.git</span></span><br><span class="line">			SSH Clone <span class="string">URL:</span>  git<span class="annotation">@yourdomain</span>:some-project.git</span><br><span class="line">			Using <span class="string">LDAP:</span>     no</span><br><span class="line">			Using <span class="string">Omniauth:</span> no</span><br><span class="line"></span><br><span class="line">			GitLab Shell</span><br><span class="line"><span class="label">			Version:</span>        <span class="number">2.0</span><span class="number">.1</span></span><br><span class="line"><span class="label">			Repositories:</span>   <span class="regexp">/home/</span>git<span class="regexp">/repositories/</span></span><br><span class="line"><span class="label">			Hooks:</span>          <span class="regexp">/home/</span>git<span class="regexp">/gitlab-shell/</span>hooks/</span><br><span class="line"><span class="label">			Git:</span>            <span class="regexp">/usr/</span>bin/git</span><br><span class="line">shell&gt; sudo -u git -H bundle exec rake <span class="string">assets:</span>precompile RAILS_ENV=production</span><br><span class="line">shell&gt; <span class="regexp">/etc/</span>init.d/gitlab start</span><br></pre></td></tr></table></figure></p>
<h3 id="配置Nginx"><strong>配置Nginx</strong></h3><p>&emsp;要通过web访问需要配置web服务器，这里选择Nginx。<br>&emsp;配置主要是修改<strong><code>server_name</code></strong>，自定义日志路径等。可适当调大<strong><code>client_max_body_size</code></strong>的值(防止推送时数据过大而出错)<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#使用SSL</span><br><span class="line"><span class="keyword">shell</span>&gt; wget -O /usr/local/nginx/<span class="keyword">conf</span>/vhosts/gitlab.<span class="keyword">conf</span> http<span class="variable">s:</span>//gitlab.<span class="keyword">com</span>/gitlab-org/gitlab-<span class="keyword">ce</span>/raw/master/lib/support/nginx/gitlab-ssl --<span class="keyword">no</span>-check-certificate</span><br><span class="line"></span><br><span class="line">#不使用SSL</span><br><span class="line"><span class="keyword">shell</span>&gt; wget -O /usr/local/nginx/<span class="keyword">conf</span>/vhosts/gitlab.<span class="keyword">conf</span> http<span class="variable">s:</span>//gitlab.<span class="keyword">com</span>/gitlab-org/gitlab-<span class="keyword">ce</span>/raw/master/lib/support/nginx/gitlab --<span class="keyword">no</span>-check-certificate</span><br><span class="line"></span><br><span class="line">#生成证书，将gitlab.crt和gitlab.key放到Nginx配置文件gitlab.<span class="keyword">conf</span>中ssl指定的目录下</span><br><span class="line"><span class="keyword">shell</span>&gt; openssl req -<span class="keyword">new</span> -x509 -nodes -days <span class="number">3560</span> -out gitlab.crt -keyout gitlab.key</span><br><span class="line"></span><br><span class="line"><span class="keyword">shell</span>&gt; usermod -<span class="keyword">a</span> -G git nginx &amp;&amp; chmod <span class="keyword">g</span>+rx /home/git/</span><br></pre></td></tr></table></figure></p>
<h3 id="关于git_clone"><strong>关于git clone</strong></h3><p>&emsp;一般从远程库克隆仓库到本地使用<code>git clone</code>命令，克隆有两种方式<strong>SSH</strong>(<code>git clone git@gitlab_server:username/repo_name.git</code>)和<strong>HTTPS</strong>(<code>git clone https://gitlab_server/username/repo_name.git</code>)。假若添加了<strong>SSH KEY</strong>就使用<strong>SSH</strong>即可，但为了使用<strong>HTTPS</strong>方式克隆，折腾了很久！又是安装<strong>gitlab-git-http-server</strong>又是安装<strong>GO</strong>，网上搜索折腾了很久都无果，最后灵机一动搞定了！</p>
<p>&emsp;假若<strong>HTTPS</strong>方式克隆报错<strong><code>Peer certificate cannot be authenticated with known CA certificates</code></strong>，则在需要克隆的机器上的<strong><code>~/.bash_profile</code></strong>添加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GIT_SSL_NO_VERIFY=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加后重新加载</span></span><br><span class="line">shell&gt; <span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></p>
<p>&emsp;CentOS上使用<code>yum</code>安装的<code>git</code>版本为<strong><code>1.7.1</code></strong>，在使用<strong><code>git clone</code></strong>克隆GitLab仓库时若出现如下报错则需要手动编译<strong>2.0</strong>版本以上的<strong>git</strong>(编译安装详见上文)<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">error:</span>  <span class="keyword">while</span> accessing <span class="string">https:</span><span class="comment">//gitlab_server/username/repo_name.git/info/refs</span></span><br><span class="line"><span class="string">fatal:</span> HTTP request failed</span><br></pre></td></tr></table></figure></p>
<p>&emsp;GitLab默认的Nginx配置文件中定义了规则，将<strong>HTTPS</strong>方式克隆的请求转到<code>gitlab-git-http-server.socket</code>，问题是GitLab默认并没有启用<strong>gitlab-git-http-server</strong>。若要安装<code>gitlab-git-http-server</code>则需先安装<code>Go</code>，当安装好<code>gitlab-git-http-server</code>后发现仍然无法使用。最后抱着试试看的心态将<code>upstream</code>转到<code>gitlab.socket</code>而非<code>gitlab-git-http-server.socket</code>，然后<strong>HTTPS</strong>方式的克隆就搞定了！<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">upstream gitlab-git-http-server </span><span class="expression">&#123;</span><br><span class="line">  #默认配置</span><br><span class="line">  <span class="begin-block">#server unix</span>:<span class="end-block">/home</span><span class="end-block">/git</span><span class="end-block">/gitlab</span><span class="end-block">/tmp</span><span class="end-block">/sockets</span><span class="end-block">/gitlab-git-http-server.socket fail</span>_<span class="variable">timeout</span>=0;</span><br><span class="line"></span><br><span class="line">  #修改后</span><br><span class="line">  <span class="variable">server</span> <span class="variable">unix</span>:<span class="end-block">/home</span><span class="end-block">/git</span><span class="end-block">/gitlab</span><span class="end-block">/tmp</span><span class="end-block">/sockets</span><span class="end-block">/gitlab.socket fail</span>_<span class="variable">timeout</span>=0;</span><br><span class="line">&#125;</span><span class="xml"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">location ~ [-\/\w\.]+\.git\/ </span><span class="expression">&#123;</span><br><span class="line">	#其余详细配置省略</span><br><span class="line">	<span class="variable">proxy</span>_<span class="variable">pass</span> <span class="variable">http</span>:/<span class="end-block">/gitlab-git-http-server</span>;</span><br><span class="line">&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure></p>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/GitLab/">GitLab</a>

					</div>

				

			</article>

			<div class="content-nav">

				
					<a href="/2015/11/11/ddos/" title="DDOS浅记">&larr; Prev</a>
				

				
					<a href="/2015/09/30/LVS/" title="LVS笔记">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
