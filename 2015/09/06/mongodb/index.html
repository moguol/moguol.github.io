<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" MongoDB初识 | Hexo " />
	<meta name="twitter:title" content=" MongoDB初识 | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" MongoDB初识 | Hexo ">
	<meta property="og:description" content=" MongoDB初识 | Hexo " />
	<meta name="twitter:description" content=" MongoDB初识 | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2015/09/06/mongodb/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2015-09-06">2015-09-06</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/OPS/">OPS</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2015/09/06/mongodb/" itemprop="url"><span itemprop="name">MongoDB初识</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
                    <!-- Table of Contents -->
                    
                    <div id="toc" class="toc-article">
                        <strong class="toc-title">目录</strong>
                        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置"><span class="toc-number">2.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建目录"><span class="toc-number">2.1.</span> <span class="toc-text">创建目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置文件"><span class="toc-number">2.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-停止"><span class="toc-number">2.3.</span> <span class="toc-text">启动/停止</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB用户管理"><span class="toc-number">3.</span> <span class="toc-text">MongoDB用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建用户"><span class="toc-number">3.1.</span> <span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除用户"><span class="toc-number">3.2.</span> <span class="toc-text">删除用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改用户角色"><span class="toc-number">3.3.</span> <span class="toc-text">修改用户角色</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB数据库操作"><span class="toc-number">4.</span> <span class="toc-text">MongoDB数据库操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建数据库"><span class="toc-number">4.1.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询"><span class="toc-number">4.2.</span> <span class="toc-text">查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除"><span class="toc-number">4.3.</span> <span class="toc-text">删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python操作MongoDB"><span class="toc-number">5.</span> <span class="toc-text">Python操作MongoDB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pymongo操作MongoDB"><span class="toc-number">5.1.</span> <span class="toc-text">pymongo操作MongoDB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB主从复制"><span class="toc-number">6.</span> <span class="toc-text">MongoDB主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#无验证主从配置"><span class="toc-number">6.1.</span> <span class="toc-text">无验证主从配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#有验证的主从配置"><span class="toc-number">6.2.</span> <span class="toc-text">有验证的主从配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB备份恢复"><span class="toc-number">7.</span> <span class="toc-text">MongoDB备份恢复</span></a></li></ol>
                    </div>
                    

					<p>&emsp;最近需要用Python对MongoDB进行操作，所以简单对MongoDB做了些了解，记录以备方便查阅。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h2><p>&emsp;从<a href="http://www.mongodb.org/downloads" target="_blank" rel="external">官网</a>上下载源码包(在<strong>CentOS6.4 64bit</strong>上安装<a href="http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.6.11.tgz" target="_blank" rel="external">MongoDB2.6.11</a>)。下载完后直接解压到目标目录(这里使用的是<code>/usr/local/mongodb</code>)</p>
<p>&emsp;配置环境变量，这步非必要，配上只是为了方便，不配的话就要写绝对路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加环境变量</span></span><br><span class="line">$ vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> MONGODB_HOME=/usr/<span class="built_in">local</span>/mongodb</span><br><span class="line"><span class="built_in">export</span> PATH+=:<span class="variable">$MONGODB_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#使环境变量生效</span></span><br><span class="line">$ <span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查环境变量是否生效</span></span><br><span class="line">$ mongod --version</span><br></pre></td></tr></table></figure></p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a><strong>配置</strong></h2><p>&emsp;配置及设置都来源于<a href="http://docs.mongodb.org/v2.6/" target="_blank" rel="external">MongoDB2.6官方文档</a></p>
<h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a><strong>创建目录</strong></h3><p>&emsp;创建相关目录<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /usr/<span class="keyword">local</span>/mongodb/&#123;<span class="keyword">log</span>,etc&#125;</span><br><span class="line"><span class="keyword">mkdir</span> -p /data/dbdata</span><br></pre></td></tr></table></figure></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a><strong>配置文件</strong></h3><p>&emsp;配置文件<strong><code>/usr/local/mongodb/etc/mongodb.conf</code></strong><br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="setting">dbpath=<span class="value">/data/dbdata</span></span></span><br><span class="line"><span class="setting">logpath=<span class="value">/usr/local/mongodb/log/mongodb.log</span></span></span><br><span class="line"><span class="setting">pidfilepath=<span class="value">/usr/local/mongodb/mongodb.pid</span></span></span><br><span class="line"><span class="setting">logappend=<span class="value"><span class="keyword">true</span></span></span></span><br><span class="line"><span class="setting">port=<span class="value"><span class="number">27017</span></span></span></span><br><span class="line"><span class="setting">fork=<span class="value"><span class="keyword">true</span></span></span></span><br><span class="line"><span class="setting">smallfiles = <span class="value"><span class="keyword">true</span></span></span></span><br><span class="line"><span class="comment">#noauth=true</span></span><br><span class="line"><span class="setting">auth=<span class="value"><span class="keyword">true</span></span></span></span><br><span class="line"><span class="comment">#nojournal = true</span></span><br><span class="line"><span class="comment">#noprealloc = true</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong><code>dbpath</code></strong>：指定数据存储路径</li>
<li><strong><code>logpath</code></strong>：指定日志路径</li>
<li><strong><code>logappend</code></strong>：写日志模式，true为追加，默认覆盖</li>
<li><strong><code>port</code></strong>：指定监听端口</li>
<li><strong><code>fork</code></strong>：后台运行，true为守护进程运行，默认false</li>
<li><strong>noauth</strong>：用户认证，默认true</li>
<li><strong>nojournal</strong>：禁止操作日志，64位系统2.0版本后默认是启用journal日志(journal=true)。journal是redo log，开启journal日志可确保数据安全，开启journal日志后默认100ms会将内存中的数据写入到journal日志文件中。</li>
<li><strong>smallfiles</strong>：使用较小的默认数据文件大小，smallfiles会减少数据文件的初始大小，并限制到512M，也减少了日志文件的大小，并限制到128M。假若数据库很大，各持有少量的数据，会导致mongodb创建很多文件，会影响性能</li>
<li><strong>noprealloc</strong>：禁用预分配方式。预分配方式是为了保证写入性能的稳定，预分频会预先生存若干文件并都用0进行填充。让MongoDB始终保持额外的空间和空余的数据文件，从而避免IO阻塞。假若禁用预分频(noprealloc=true)会使得MongoDB启动时间缩短但写入性能可能会下降。</li>
</ul>
<p>&emsp;MongoDB<strong>默认是没有权限验证的</strong>!在生产环境下，为安全考虑必须启用验证。生产环境下可如下操作：</p>
<ol>
<li>首次启动MongoDB前不配置<strong><code>auto=true</code></strong>选项(MongoDB默认<code>noauth=true</code>)，启动MongoDB进入MongoDB Shell<strong>创建用户</strong></li>
<li>创建完用户后停止MongoDB，开启<strong><code>auto=true</code></strong>选项，启用用户验证后再启动MongoDB。</li>
</ol>
<h3 id="启动-停止"><a href="#启动-停止" class="headerlink" title="启动/停止"></a><strong>启动/停止</strong></h3><p>&emsp;<strong>启动MongoDB</strong><br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/mongodb/</span>bin<span class="regexp">/mongod -f /u</span>sr<span class="regexp">/local/m</span>ongodb<span class="regexp">/etc/m</span>ongodb.conf</span><br></pre></td></tr></table></figure></p>
<p>&emsp;<strong>停止MongoDB</strong><br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法一：</span></span><br><span class="line"><span class="variable">$ </span>kill -<span class="number">2</span> pid</span><br><span class="line">或</span><br><span class="line"><span class="variable">$ </span>kill -<span class="number">4</span> pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法二：</span></span><br><span class="line"><span class="variable">$ </span>/usr/local/mongodb/bin/mongo</span><br><span class="line">&gt; <span class="keyword">use</span> admin;</span><br><span class="line">&gt; db.shutdownServer();</span><br></pre></td></tr></table></figure></p>
<h2 id="MongoDB用户管理"><a href="#MongoDB用户管理" class="headerlink" title="MongoDB用户管理"></a><strong>MongoDB用户管理</strong></h2><p>&emsp;MongoDB默认是不会进行安全验证也没有管理员账号，为了安全考虑需要创建用户及权限设置<br>&emsp;MongoDB默认就是<code>noauth</code>，先启动后直接登录<code>MongoDB shell</code>，然后使用MongoDB内置方法<strong><code>createUser</code></strong>(<code>addUser</code>为旧方法)添加账号<br>&emsp;<strong><code>createUser</code></strong>方法包含四个参数：</p>
<ul>
<li><strong><code>user</code></strong>：用户名</li>
<li><strong><code>pwd</code></strong>：密码</li>
<li><strong><code>roles</code></strong>：指定用户的角色，此选项必须为<strong>数组</strong>。<strong>可为空<code>[]</code></strong>。所有内置角色详见<a href="http://docs.mongodb.org/v2.6/reference/built-in-roles/" target="_blank" rel="external">这里</a><br>  Example：  <figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">roles:</span> [</span><br><span class="line">			 &#123; role: <span class="string">"read"</span>, db: <span class="string">"reporting"</span> &#125;,</span><br><span class="line">			 &#123; role: <span class="string">"readWrite"</span>, db: <span class="string">"accounts"</span> &#125;,</span><br><span class="line">			 &#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125;</span><br><span class="line">			]</span><br><span class="line"></span><br><span class="line"><span class="label">roles:</span> [&#123; role: <span class="string">"userAdminAnyDatabase"</span>, db: <span class="string">"admin"</span> &#125;]		<span class="preprocessor">#管理员权限，有用户管理权限但各个数据库仍需要再各自授权</span></span><br><span class="line"><span class="label">roles:</span> [&#123; role: <span class="string">"root"</span>, db: <span class="string">"admin"</span> &#125;]						<span class="preprocessor">#管理员权限，最大权限</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a><strong>创建用户</strong></h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$  mongo</span><br><span class="line">&gt; use admin</span><br><span class="line">&gt; db.createUser(&#123;</span><br><span class="line">... user: <span class="string">"test"</span>,</span><br><span class="line">... pwd: <span class="string">"mogl"</span>,</span><br><span class="line">... roles: [&#123;role: <span class="string">"read"</span>, db: <span class="string">"admin"</span>&#125;, &#123;role: <span class="string">"readWrite"</span>, db: <span class="string">"local"</span>&#125;]</span><br><span class="line">... &#125;);</span><br><span class="line">Successfully added user: &#123;</span><br><span class="line">        <span class="string">"user"</span> : <span class="string">"test"</span>,</span><br><span class="line">        <span class="string">"roles"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"role"</span> : <span class="string">"read"</span>,</span><br><span class="line">                        <span class="string">"db"</span> : <span class="string">"admin"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"role"</span> : <span class="string">"readWrite"</span>,</span><br><span class="line">                        <span class="string">"db"</span> : <span class="string">"local"</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line">&gt; show collections;</span><br><span class="line">system.indexes</span><br><span class="line">system.users</span><br><span class="line">system.version</span><br><span class="line">&gt; db.system.users.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="string">"admin.test"</span>, <span class="string">"user"</span> : <span class="string">"test"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span>, <span class="string">"credentials"</span> : &#123; <span class="string">"MONGODB-CR"</span> : <span class="string">"dce6309d11410ce1bdd249fecd9700a5"</span> &#125;, <span class="string">"roles"</span> : [ &#123; <span class="string">"role"</span> : <span class="string">"read"</span>, <span class="string">"db"</span> : <span class="string">"admin"</span> &#125;, &#123; <span class="string">"role"</span> : <span class="string">"readWrite"</span>, <span class="string">"db"</span> : <span class="string">"local"</span> &#125; ] &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;创建用户后，停止MongoDB，注释<code>noauth=true</code>语句，添加<strong><code>auto=true</code></strong>。启动MongoDB后进行认证登陆<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&gt; mongo <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/admin -utest -p</span><br><span class="line"><span class="preprocessor">#或</span></span><br><span class="line">$&gt; mongo admin -utest -p</span><br></pre></td></tr></table></figure></p>
<p>&emsp;如果是在<code>admin</code>库对其他库授权，登陆的时候需要制定认证的<code>admin</code>库。如上例子中，用户<code>test</code>是在库<code>admin</code>对库<code>local</code>授权，登陆时则需：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&gt; mongo <span class="keyword">local</span> -<span class="keyword">u</span> <span class="keyword">test</span> -p --authenticationDatabase admin</span><br></pre></td></tr></table></figure></p>
<p>&emsp;旧版的MongoDB使用的是<strong><code>db.addUser(&#39;username&#39;, &#39;password&#39;)</code></strong>，默认拥有所有数据库所有权限。<strong><code>db.addUser(&#39;username&#39;, &#39;password&#39;, true)</code></strong>，拥有所有数据库的只读权限。</p>
<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a><strong>删除用户</strong></h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">db</span>.dropUser(<span class="string">"username"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="修改用户角色"><a href="#修改用户角色" class="headerlink" title="修改用户角色"></a><strong>修改用户角色</strong></h3><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; show users;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"admin.root"</span>,</span><br><span class="line">        <span class="string">"user"</span> : <span class="string">"root"</span>,        <span class="string">"db"</span> : <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"roles"</span> : [                &#123;</span><br><span class="line">                        <span class="string">"role"</span> : <span class="string">"userAdminAnyDatabase"</span>,</span><br><span class="line">                        <span class="string">"db"</span> : <span class="string">"admin"</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; db.updateUser(<span class="string">'root'</span>,</span><br><span class="line">... &#123;roles: [&#123;role: <span class="string">'root'</span>, db: <span class="string">'admin'</span>&#125;]&#125;</span><br><span class="line">... );</span><br></pre></td></tr></table></figure>
<h2 id="MongoDB数据库操作"><a href="#MongoDB数据库操作" class="headerlink" title="MongoDB数据库操作"></a><strong>MongoDB数据库操作</strong></h2><p>&emsp;记录MongoDB数据库的增删查改等操作</p>
<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a><strong>创建数据库</strong></h3><p>&emsp;MongoDB创建数据库只需要<code>use database_name</code>即可，但创建库后必须插入一条数据，否则离开后库系统<strong>自动删除</strong>刚刚<code>use</code>的库。<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; use mydb</span><br><span class="line">&gt; switched <span class="keyword">to</span> db mydb</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#usr是collection_name，可理解为<span class="string">'表名'</span></span></span><br><span class="line">&gt; db.usr.insert(&#123;<span class="string">'name'</span>: <span class="string">'mogl'</span>&#125;)<span class="comment">;</span></span><br><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line">&gt; show collections<span class="comment">;</span></span><br><span class="line">system.indexes</span><br><span class="line">usr</span><br><span class="line">&gt; db.usr.find()<span class="comment">;</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"55ed032aaaabebb7d6ffb58e"</span>), <span class="string">"name"</span> : <span class="string">"mogl"</span> &#125;</span><br><span class="line">&gt; show dbs<span class="comment">;</span></span><br><span class="line">admin  <span class="number">0.031</span>GB</span><br><span class="line"><span class="keyword">local</span>  <span class="number">0.031</span>GB</span><br><span class="line">mydb   <span class="number">0.031</span>GB</span><br><span class="line">test   (empty)</span><br></pre></td></tr></table></figure></p>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a><strong>查询</strong></h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="tag">db</span><span class="class">.zabbix_log</span><span class="class">.find</span>()<span class="class">.limit</span>(5)<span class="class">.pretty</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>zabbix_log</code></strong>：collection名</li>
<li><strong><code>limit(5)</code></strong>：限制输出5个记录</li>
<li><strong><code>pretty()</code></strong>：格式化显示</li>
</ul>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;db.zabbixLog.find().sort(&#123;<span class="variable">$natural</span>: -<span class="number">1</span>&#125;).limit(<span class="number">1</span>).pretty();</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>sort({$natural: -1})</code></strong>：逆序</li>
</ul>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a><strong>删除</strong></h3><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; use mydb</span><br><span class="line"><span class="preprocessor">#删除一条记录</span></span><br><span class="line">&gt; db.foo.remove(&#123;<span class="string">"id"</span>:<span class="string">"bar"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#清空foo中所有记录，但foo这个collection不会被删除</span></span><br><span class="line">&gt; db.foo.remove()</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#仅删除一条符合查询的记录</span></span><br><span class="line">&gt; db.restult.remove(&#123;<span class="string">'error_code'</span>: <span class="number">9</span>&#125;, &#123;justOne: <span class="literal">true</span>&#125;);</span><br><span class="line">WriteResult(&#123; <span class="string">"nRemoved"</span> : <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#删除foo这个collection.show collections不会有foo，但查看数据文件发现大小不变，Mongodb不会自动释放文件空间</span></span><br><span class="line">&gt; db.foo.drop()</span><br><span class="line"><span class="preprocessor">#使MongoDB释放不需要的空间</span></span><br><span class="line">&gt; db.repairDatabase()</span><br></pre></td></tr></table></figure>
<h2 id="Python操作MongoDB"><a href="#Python操作MongoDB" class="headerlink" title="Python操作MongoDB"></a><strong>Python操作MongoDB</strong></h2><p>&emsp;安装<strong><code>pymongo</code></strong><br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> pymongo</span><br></pre></td></tr></table></figure></p>
<h3 id="pymongo操作MongoDB"><a href="#pymongo操作MongoDB" class="headerlink" title="pymongo操作MongoDB"></a><strong>pymongo操作MongoDB</strong></h3><p>&emsp;详细内容查看<a href="https://api.mongodb.org/python/current/" target="_blank" rel="external">pymongo文档</a><br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line">import pymongo</span><br><span class="line"></span><br><span class="line">host = <span class="string">'mongodb.host'</span></span><br><span class="line">port = <span class="number">27017</span></span><br><span class="line">user = <span class="string">'username'</span></span><br><span class="line">pwd = <span class="string">'password'</span></span><br><span class="line">db_name = <span class="string">'mydb'</span></span><br><span class="line">collection_name = <span class="string">'mycollection'</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#noauth</span></span><br><span class="line"><span class="preprocessor">#mongo_con = pymongo.Connection(host, port)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#auth</span></span><br><span class="line">mongo_client = pymongo.MongoClient(<span class="string">"%s:%d"</span> % (host, port))</span><br><span class="line">mongo_client[db_name].authenticate(user, pwd, db_name, mechanism=<span class="string">'MONGODB-CR'</span>)</span><br><span class="line">mongo_db = mongo_client[db_name]</span><br><span class="line">mongo_collection = mongo_db[collection_name]</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#操作</span></span><br><span class="line">count = mongo_collection.count()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert_data = &#123;<span class="string">'pv'</span>: pv,</span><br><span class="line">               <span class="string">'code_200'</span>: code_200,</span><br><span class="line">               <span class="string">'error_code'</span>: error_code</span><br><span class="line">               &#125;</span><br><span class="line">mongo_collection.insert(insert_data)</span><br></pre></td></tr></table></figure></p>
<h2 id="MongoDB主从复制"><a href="#MongoDB主从复制" class="headerlink" title="MongoDB主从复制"></a><strong>MongoDB主从复制</strong></h2><p>&emsp;一个MongoDB主从复制集群里只能有主节点，主节点将所有collection的变动记录到<strong>oplog</strong>(类似MySQL的binlog)，从节点将<code>oplog</code>复制并应用操作实现数据一致。</p>
<ul>
<li><strong><code>主节点</code></strong>：负责接收数据并写入数据库</li>
<li><strong><code>从节点</code></strong>：通过复制主节点的<code>oplog</code>保持数据一致。若主节点挂了，有多个从节点时会从中选举新的主节点。</li>
<li><strong><code>投票节点</code></strong>：不包含数据，仅在选举中起作用，当选举结果出现平局时通过投票节点选出新的主节点。</li>
</ul>
<h3 id="无验证主从配置"><a href="#无验证主从配置" class="headerlink" title="无验证主从配置"></a><strong>无验证主从配置</strong></h3><ul>
<li><p><strong>主节点</strong><br>  在<code>/usr/local/mongodb/etc/mongodb.conf</code>配置文件上新增，主节点启动后在<strong><code>local</code></strong>库下会生成<strong><code>oplog.$main</code></strong>的collection</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master=<span class="literal">true</span></span><br><span class="line">oplogSize=<span class="number">2048</span> 		<span class="preprocessor">#oplog日志大小，单位M</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>从节点</strong><br>  在<code>/usr/local/mongodb/etc/mongodb.conf</code>配置文件上新增</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slave=<span class="literal">true</span></span><br><span class="line"><span class="built_in">source</span>=host:port   			<span class="comment">#指定主mongodb server</span></span><br><span class="line">slavedelay=<span class="number">10</span>               <span class="comment">#延迟复制，单位为s</span></span><br><span class="line">autoresync=<span class="literal">true</span>             <span class="comment">#从节点数据不是最新时，自动向主节点同步数据</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="有验证的主从配置"><a href="#有验证的主从配置" class="headerlink" title="有验证的主从配置"></a><strong>有验证的主从配置</strong></h3><p>&emsp;<a href="http://docs.mongodb.org/v2.6/tutorial/deploy-replica-set-with-auth/" target="_blank" rel="external">官方文档</a><br>&emsp;需要验证的主从涉及到<strong>keyFile</strong>的验证，需要利用<code>openssl</code>生成keyFile(可不用openssl而选择其他工具)<br>&emsp;在<strong>主节点</strong>生成<strong>keyFile</strong>并在配置文件指定路径，将<strong>keyFile</strong>复制到<strong>从节点</strong>并在配置文件指定路径<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&gt;</span> cd /usr/local/mongodb</span><br><span class="line"><span class="variable">$&gt;</span> openssl rand -base64 <span class="number">741</span> &gt; mongodb-keyfile</span><br><span class="line"><span class="variable">$&gt;</span> chmod <span class="number">600</span> mongodb-keyfile</span><br><span class="line"><span class="variable">$&gt;</span> echo <span class="string">'keyFile=/usr/local/mongodb/mongodb-keyfile'</span> &gt;&gt; <span class="regexp">/usr/local</span><span class="regexp">/mongodb/etc</span><span class="regexp">/mongodb.conf</span></span><br></pre></td></tr></table></figure></p>
<h2 id="MongoDB备份恢复"><a href="#MongoDB备份恢复" class="headerlink" title="MongoDB备份恢复"></a><strong>MongoDB备份恢复</strong></h2><ul>
<li><p><strong>MongoDB备份</strong></p>
  <figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#备份特定collection</span></span><br><span class="line"><span class="comment">$</span>&gt; <span class="comment">mongodump</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">host</span> <span class="comment">mongodb</span><span class="string">.</span><span class="comment">example</span><span class="string">.</span><span class="comment">net</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">27017</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">db</span> <span class="comment">test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">collection</span> <span class="comment">some</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">backup</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">password</span> <span class="comment">passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份所有数据库</span></span><br><span class="line"><span class="comment">$</span>&gt; <span class="comment">mongodump</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">host</span> <span class="comment">mongos3</span><span class="string">.</span><span class="comment">example</span><span class="string">.</span><span class="comment">net</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">27017</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#备份特定数据库</span></span><br><span class="line"><span class="comment">$</span>&gt; <span class="comment">mongodump</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">host</span> <span class="comment">mongodb</span><span class="string">.</span><span class="comment">example</span><span class="string">.</span><span class="comment">net</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">27017</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">db</span> <span class="comment">test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">backup</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">password</span> <span class="comment">passwd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MongoDB恢复</strong></p>
  <figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从/data/backup中恢复test库的名为some的collection</span></span><br><span class="line"><span class="comment">mongorestore</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">host</span> <span class="comment">mongodb</span><span class="string">.</span><span class="comment">example</span><span class="string">.</span><span class="comment">net</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">27017</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">db</span> <span class="comment">test</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">collection</span> <span class="comment">some</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">backup</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">password</span> <span class="comment">password</span> <span class="comment">/data/backup</span></span><br></pre></td></tr></table></figure>
</li>
</ul>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/MongoDB/">MongoDB</a>

					</div>

				

			</article>

			<div class="content-nav">

				
					<a href="/2015/09/20/keepalived/" title="Keepalived">&larr; Prev</a>
				

				
					<a href="/2015/08/30/openvpn/" title="OpenVPN使用小记">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
