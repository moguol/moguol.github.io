<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" Open-Falcon源码阅读-Agent | Hexo " />
	<meta name="twitter:title" content=" Open-Falcon源码阅读-Agent | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" Open-Falcon源码阅读-Agent | Hexo ">
	<meta property="og:description" content=" Open-Falcon源码阅读-Agent | Hexo " />
	<meta name="twitter:description" content=" Open-Falcon源码阅读-Agent | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2019/06/05/Open-Falcon-agent/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2019-06-05">2019-06-05</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/Golang/">Golang</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2019/06/05/Open-Falcon-agent/" itemprop="url"><span itemprop="name">Open-Falcon源码阅读-Agent</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
                    <!-- Table of Contents -->
                    
                    <div id="toc" class="toc-article">
                        <strong class="toc-title">目录</strong>
                        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Agent源码目录结构"><span class="toc-number">1.</span> <span class="toc-text">Agent源码目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main函数"><span class="toc-number">2.</span> <span class="toc-text">main函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行参数解析"><span class="toc-number">2.1.</span> <span class="toc-text">命令行参数解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#funcs-CheckCollector"><span class="toc-number">2.1.1.</span> <span class="toc-text">funcs.CheckCollector()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置文件解析"><span class="toc-number">2.2.</span> <span class="toc-text">配置文件解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#g-ParseConfig-cfg"><span class="toc-number">2.2.1.</span> <span class="toc-text">g.ParseConfig(*cfg)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#g初始化"><span class="toc-number">2.2.2.</span> <span class="toc-text">g初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#监控项采集mapping"><span class="toc-number">2.3.</span> <span class="toc-text">监控项采集mapping</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#funcs-BuildMappers"><span class="toc-number">2.3.1.</span> <span class="toc-text">funcs.BuildMappers()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定时任务"><span class="toc-number">2.4.</span> <span class="toc-text">定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cron-InitDataHistory"><span class="toc-number">2.4.1.</span> <span class="toc-text">cron.InitDataHistory()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cron-ReportAgentStatus"><span class="toc-number">2.4.2.</span> <span class="toc-text">cron.ReportAgentStatus()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cron-SyncMinePlugins"><span class="toc-number">2.4.3.</span> <span class="toc-text">cron.SyncMinePlugins()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cron-SyncBuiltinMetrics"><span class="toc-number">2.4.4.</span> <span class="toc-text">cron.SyncBuiltinMetrics()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cron-SyncTrustableIps"><span class="toc-number">2.4.5.</span> <span class="toc-text">cron.SyncTrustableIps()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cron-Collect"><span class="toc-number">2.4.6.</span> <span class="toc-text">cron.Collect()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-amp-Dashboard"><span class="toc-number">2.5.</span> <span class="toc-text">API & Dashboard</span></a></li></ol></li></ol>
                    </div>
                    

					<h2 id="Agent源码目录结构"><a href="#Agent源码目录结构" class="headerlink" title="Agent源码目录结构"></a><strong>Agent源码目录结构</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cfg.example.json	// 配置文件示例</span><br><span class="line">├── control</span><br><span class="line">├── cron	// 定时任务</span><br><span class="line">├── funcs	// 各种采集指标函数</span><br><span class="line">├── g	// 配置文件、日志、rpc等全局设置及初始化</span><br><span class="line">├── http    // HTTP API</span><br><span class="line">├── LICENSE</span><br><span class="line">├── main.go		// 入口函数</span><br><span class="line">├── NOTICE</span><br><span class="line">├── plugins     // 插件</span><br><span class="line">├── public      // html、css、js文件</span><br><span class="line">└── README.md</span><br></pre></td></tr></table></figure>
<h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a><strong>main函数</strong></h2><h3 id="命令行参数解析"><a href="#命令行参数解析" class="headerlink" title="命令行参数解析"></a><strong>命令行参数解析</strong></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 命令行参数解析</span></span><br><span class="line">cfg := flag.String(<span class="string">"c"</span>, <span class="string">"cfg.json"</span>, <span class="string">"configuration file"</span>)</span><br><span class="line">version := flag.Bool(<span class="string">"v"</span>, <span class="constant">false</span>, <span class="string">"show version"</span>)</span><br><span class="line">check := flag.Bool(<span class="string">"check"</span>, <span class="constant">false</span>, <span class="string">"check collector"</span>)</span><br><span class="line"></span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否打印agent版本信息</span></span><br><span class="line"><span class="keyword">if</span> *version &#123;</span><br><span class="line">    fmt.Println(g.VERSION)	<span class="comment">// g/const.go VERSION</span></span><br><span class="line">    os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否检查采集器</span></span><br><span class="line"><span class="keyword">if</span> *check &#123;</span><br><span class="line">    funcs.CheckCollector()	<span class="comment">// funcs/checker.go</span></span><br><span class="line">    os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="funcs-CheckCollector"><a href="#funcs-CheckCollector" class="headerlink" title="funcs.CheckCollector()"></a><strong>funcs.CheckCollector()</strong></h4><p>函数主要功能为检测各个采集模块功能是否正常</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> CheckCollector() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建并初始化存放检测结果mapping</span></span><br><span class="line">    output := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="typename">string</span>]<span class="typename">bool</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// toolkits/nux/cpustat.go</span></span><br><span class="line">    <span class="comment">// 检测CPU状态，/proc/stat</span></span><br><span class="line">    _, procStatErr := nux.CurrentProcStat()</span><br><span class="line">    <span class="comment">// toolkits/nux/iostat.go</span></span><br><span class="line">    <span class="comment">// 检测磁盘状态，/proc/diskstats</span></span><br><span class="line">    _, listDiskErr := nux.ListDiskStats()</span><br><span class="line">    <span class="comment">// toolkits/nux/prostat.go</span></span><br><span class="line">    <span class="comment">// 获取系统所有TCP监听端口，ss -t -n -l</span></span><br><span class="line">    ports, listeningPortsErr := nux.ListeningPorts()</span><br><span class="line">    <span class="comment">// toolkits/nux/proc.go</span></span><br><span class="line">    <span class="comment">// 获取所有进程，/proc/&lt;pid&gt;/status，/proc/&lt;pid&gt;cmdline</span></span><br><span class="line">    procs, psErr := nux.AllProcs()</span><br><span class="line"></span><br><span class="line">    _, duErr := sys.CmdOut(<span class="string">"du"</span>, <span class="string">"--help"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 大部分调用funcs包下模块对各采集项进行检测</span></span><br><span class="line">    output[<span class="string">"kernel  "</span>] = <span class="built_in">len</span>(KernelMetrics()) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"df.bytes"</span>] = DeviceMetricsCheck()</span><br><span class="line">    output[<span class="string">"net.if  "</span>] = <span class="built_in">len</span>(CoreNetMetrics([]<span class="typename">string</span>&#123;&#125;)) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"loadavg "</span>] = <span class="built_in">len</span>(LoadAvgMetrics()) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"cpustat "</span>] = procStatErr == <span class="constant">nil</span></span><br><span class="line">    output[<span class="string">"disk.io "</span>] = listDiskErr == <span class="constant">nil</span></span><br><span class="line">    output[<span class="string">"memory  "</span>] = <span class="built_in">len</span>(MemMetrics()) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"netstat "</span>] = <span class="built_in">len</span>(NetstatMetrics()) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"ss -s   "</span>] = <span class="built_in">len</span>(SocketStatSummaryMetrics()) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"ss -tln "</span>] = listeningPortsErr == <span class="constant">nil</span> &amp;&amp; <span class="built_in">len</span>(ports) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"ps aux  "</span>] = psErr == <span class="constant">nil</span> &amp;&amp; <span class="built_in">len</span>(procs) &gt; <span class="number">0</span></span><br><span class="line">    output[<span class="string">"du -bs  "</span>] = duErr == <span class="constant">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印检测结果</span></span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> output &#123;</span><br><span class="line">        status := <span class="string">"fail"</span></span><br><span class="line">        <span class="keyword">if</span> v &#123;</span><br><span class="line">            status = <span class="string">"ok"</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(k, <span class="string">"..."</span>, status)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置文件解析"><a href="#配置文件解析" class="headerlink" title="配置文件解析"></a><strong>配置文件解析</strong></h3><h4 id="g-ParseConfig-cfg"><a href="#g-ParseConfig-cfg" class="headerlink" title="g.ParseConfig(*cfg)"></a><strong>g.ParseConfig(*cfg)</strong></h4><p>解析通过命令行<code>-c</code>参数传入的配置文件</p>
<p>通过调用<code>g.Config()</code>函数获取package级变量<code>config *GlobalConfig</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`g.Config()` ---&gt; `config`(`config *GobalConfig`) ---&gt; `config = &amp;c` ---&gt; `json.Unmarshal([]byte(configContent), &amp;c)` ---&gt; `configContent, err := file.ToTrimString(cfg)`</span><br></pre></td></tr></table></figure>
<p>通过<code>g.Config().XXX</code>即可获取<code>-c</code>指定配置文件的具体配置项目</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// g/cfg.go</span></span><br><span class="line"><span class="keyword">func</span> ParseConfig(cfg <span class="typename">string</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// toolkits/file/reader.go</span></span><br><span class="line">    <span class="comment">// ToTrimString()/strings.TrimSpace() ---&gt; ToString() ---&gt; ioutil.ReadFile()</span></span><br><span class="line">    configContent, err := file.ToTrimString(cfg)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        log.Fatalln(<span class="string">"read config file:"</span>, cfg, <span class="string">"fail:"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// agent配置文件结构体</span></span><br><span class="line">    <span class="comment">// GlobalConfig嵌套了Plugin、Heartbeat、Transfer、Http和Collector结构体，结合cfg.example.json模板配置文件看</span></span><br><span class="line">    <span class="comment">// json ---&gt; struct</span></span><br><span class="line">    <span class="keyword">var</span> c GlobalConfig</span><br><span class="line">    err = json.Unmarshal([]<span class="typename">byte</span>(configContent), &amp;c)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        log.Fatalln(<span class="string">"parse config file:"</span>, cfg, <span class="string">"fail:"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// package级变量</span></span><br><span class="line">    <span class="comment">// lock = new(sync.RWMutex)</span></span><br><span class="line">    lock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> lock.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// package级变量</span></span><br><span class="line">    <span class="comment">// config *GlobalConfig</span></span><br><span class="line">    config = &amp;c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// g/cfg.go</span></span><br><span class="line"><span class="comment">// 通过g.Config()函数获取到存放配置文件内容的*GlobalConfig指针结构体变量config</span></span><br><span class="line"><span class="keyword">func</span> Config() *GlobalConfig &#123;</span><br><span class="line">    lock.RLock()</span><br><span class="line">    <span class="keyword">defer</span> lock.RUnlock()</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="g初始化"><a href="#g初始化" class="headerlink" title="g初始化"></a><strong>g初始化</strong></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用os.Getwd()获取当前目录路径</span></span><br><span class="line">g.InitRootDir()</span><br><span class="line"><span class="comment">// 通过net包向Heartbeat server服务发起TCP连接获取本地agent机器IP</span></span><br><span class="line">g.InitLocalIp()</span><br><span class="line"><span class="comment">// 构造SingleConnRpcClient结构体对象，设置Heartbeat server服务端IP:Port及连接超时时间</span></span><br><span class="line">g.InitRpcClients()</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SingleConnRpcClient <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.Mutex</span><br><span class="line">    rpcClient *rpc.Client</span><br><span class="line">    RpcServer <span class="typename">string</span></span><br><span class="line">    Timeout   time.Duration</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="监控项采集mapping"><a href="#监控项采集mapping" class="headerlink" title="监控项采集mapping"></a><strong>监控项采集mapping</strong></h3><h4 id="funcs-BuildMappers"><a href="#funcs-BuildMappers" class="headerlink" title="funcs.BuildMappers()"></a><strong>funcs.BuildMappers()</strong></h4><p><code>BuildMappers()</code>函数的作用是构建采集各种指标的函数，而这些函数的返回值统一都是<code>[]*model.MetricValue</code>，<code>model.MetricValue</code>结构体为: </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MetricValue <span class="keyword">struct</span> &#123;</span><br><span class="line">    Endpoint  <span class="typename">string</span>      <span class="string">`json:"endpoint"`</span></span><br><span class="line">    Metric    <span class="typename">string</span>      <span class="string">`json:"metric"`</span>	<span class="comment">// 监控项名称</span></span><br><span class="line">    Value     <span class="keyword">interface</span>&#123;&#125; <span class="string">`json:"value"`</span>	<span class="comment">// 监控项值</span></span><br><span class="line">    Step      <span class="typename">int64</span>       <span class="string">`json:"step"`</span>		<span class="comment">// 采集间隔</span></span><br><span class="line">    Type      <span class="typename">string</span>      <span class="string">`json:"counterType"`</span>	<span class="comment">//RRD数据类型: Counter、Derive、Absolute、Gauge、Compute</span></span><br><span class="line">    Tags      <span class="typename">string</span>      <span class="string">`json:"tags"`</span>		<span class="comment">// 监控项标签</span></span><br><span class="line">    Timestamp <span class="typename">int64</span>       <span class="string">`json:"timestamp"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>Type</code>是指RRD中的DST(data source type)，共计5种: </p>
<ul>
<li><strong><code>Counter</code></strong>: 递增类型(必须增加) (Open-Falcon常用类型)</li>
<li><strong><code>Derive</code></strong>: 可增可减类型</li>
<li><strong><code>Absolute</code></strong>: 每次都假定前一个interval的值是0，再计算平均值</li>
<li><strong><code>Gauge</code></strong>: 直接将值存入RRD，不做任何处理 (Open-Falcon常用类型)</li>
<li><strong><code>Compute</code></strong>: 不接受输入，直接定义表达式，引用其他RRD中的DS自动计算出某个值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// funcs/funcs.go</span></span><br><span class="line"><span class="keyword">type</span> FuncsAndInterval <span class="keyword">struct</span> &#123;</span><br><span class="line">    Fs       []<span class="keyword">func</span>() []*model.MetricValue	<span class="comment">// 一组生成MetricValue的函数</span></span><br><span class="line">    Interval <span class="typename">int</span>	<span class="comment">// 上传数据到Transfer的时间间隔</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Mappers []FuncsAndInterval</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> BuildMappers() &#123;</span><br><span class="line">    interval := g.Config().Transfer.Interval	<span class="comment">// 获取配置文件中上传数据到Transfer的时间间隔</span></span><br><span class="line">    Mappers = []FuncsAndInterval&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            Fs: []<span class="keyword">func</span>() []*model.MetricValue&#123;</span><br><span class="line">                AgentMetrics,</span><br><span class="line">                CpuMetrics,</span><br><span class="line">                NetMetrics,</span><br><span class="line">                KernelMetrics,</span><br><span class="line">                LoadAvgMetrics,</span><br><span class="line">                MemMetrics,</span><br><span class="line">                DiskIOMetrics,</span><br><span class="line">                IOStatsMetrics,</span><br><span class="line">                NetstatMetrics,</span><br><span class="line">                ProcMetrics,</span><br><span class="line">                UdpMetrics,</span><br><span class="line">            &#125;,</span><br><span class="line">            Interval: interval,</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>以<code>LoadAvgMetrics</code>为例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">获取指标值 ---&gt; GaugeValue()|CounterValue() ---&gt; NewMetricValue() 创建*model.MetricValue</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> LoadAvgMetrics() []*model.MetricValue &#123;</span><br><span class="line">    load, err := nux.LoadAvg()	<span class="comment">// 获取指标值</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        log.Println(err)</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> []*model.MetricValue&#123;</span><br><span class="line">        GaugeValue(<span class="string">"load.1min"</span>, load.Avg1min),	<span class="comment">// 调用GaugeValue()函数，实际构建*medel.MetricValue数据的是NewMetricValue()函数</span></span><br><span class="line">        GaugeValue(<span class="string">"load.5min"</span>, load.Avg5min),</span><br><span class="line">        GaugeValue(<span class="string">"load.15min"</span>, load.Avg15min),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> GaugeValue(metric <span class="typename">string</span>, val <span class="keyword">interface</span>&#123;&#125;, tags ...<span class="typename">string</span>) *model.MetricValue &#123;</span><br><span class="line">    <span class="keyword">return</span> NewMetricValue(metric, val, <span class="string">"GAUGE"</span>, tags...)	<span class="comment">// 调用NewMetricValue()构建*model.MetricValue数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> NewMetricValue(metric <span class="typename">string</span>, val <span class="keyword">interface</span>&#123;&#125;, dataType <span class="typename">string</span>, tags ...<span class="typename">string</span>) *model.MetricValue &#123;</span><br><span class="line">    <span class="comment">// 根据传入参数构建model.MetricValue数据</span></span><br><span class="line">    mv := model.MetricValue&#123;</span><br><span class="line">        Metric: metric,	<span class="comment">// 监控项名称，load.1min/load.5min/load.15min</span></span><br><span class="line">        Value:  val,	<span class="comment">// 监控项值</span></span><br><span class="line">        Type:   dataType,	<span class="comment">// 数据类型，Gauge/Counter，Open-Falcon Agent只用到这2种DST</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    size := <span class="built_in">len</span>(tags)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> size &gt; <span class="number">0</span> &#123;</span><br><span class="line">        mv.Tags = strings.Join(tags, <span class="string">","</span>)	<span class="comment">// tag有值则加入</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;mv</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终<code>LoadAvgMetrics()</code>函数返回的数据样例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&lt;Endpoint:, Metric:load<span class="number">.1</span>min, Type:GAUGE, Tags:, Step:<span class="number">0</span>, Time:<span class="number">0</span>, Value:<span class="number">0.32</span>&gt; &lt;Endpoint:, Metric:load<span class="number">.5</span>min, Type:GAUGE, Tags:, Step:<span class="number">0</span>, Time:<span class="number">0</span>, Value:<span class="number">0.26</span>&gt; &lt;Endpoint:, Metric:load<span class="number">.15</span>min, Type:GAUGE, Tags:, Step:<span class="number">0</span>, Time:<span class="number">0</span>, Value:<span class="number">0.28</span>&gt;]</span><br></pre></td></tr></table></figure>
<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a><strong>定时任务</strong></h3><h4 id="cron-InitDataHistory"><a href="#cron-InitDataHistory" class="headerlink" title="cron.InitDataHistory()"></a><strong>cron.InitDataHistory()</strong></h4><p><code>cron.InitDataHistory()</code>作用是周期性更新CPU和Disk状态信息，保留上次采集及此次更新的数据，总共会保留2份数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> InitDataHistory() &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        funcs.UpdateCpuStat()	<span class="comment">// 更新CPU状态</span></span><br><span class="line">        funcs.UpdateDiskStats()	<span class="comment">// 更新磁盘状态</span></span><br><span class="line">        time.Sleep(g.COLLECT_INTERVAL)	<span class="comment">// 默认1秒</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cron-ReportAgentStatus"><a href="#cron-ReportAgentStatus" class="headerlink" title="cron.ReportAgentStatus()"></a><strong>cron.ReportAgentStatus()</strong></h4><p><code>cron.ReportAgentStatus()</code>作用是每隔<code>Heartbeat.Interval(配置文件中设定)</code>秒通过RPC方式向HBS上报agent信息，上报数据为<code>model.AgentReportRequest</code></p>
<p>上报逻辑为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cron.ReportAgentStatus() ---&gt; go reportAgentStatus() ---&gt; g.HbsClient.Call() ---&gt; serverConn() &amp; rcpClient.Call()</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// open-falcon/falcon-plus/common/model/agent.go</span></span><br><span class="line"><span class="keyword">type</span> AgentReportRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    Hostname      <span class="typename">string</span></span><br><span class="line">    IP            <span class="typename">string</span></span><br><span class="line">    AgentVersion  <span class="typename">string</span></span><br><span class="line">    PluginVersion <span class="typename">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cron/reporter.go</span></span><br><span class="line">    <span class="comment">// 上报信息</span></span><br><span class="line">    req := model.AgentReportRequest&#123;</span><br><span class="line">        Hostname:      hostname,</span><br><span class="line">        IP:            g.IP(),</span><br><span class="line">        AgentVersion:  g.VERSION,</span><br><span class="line">        PluginVersion: g.GetCurrPluginVersion(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RPC请求返回值</span></span><br><span class="line">    <span class="keyword">var</span> resp model.SimpleRpcResponse</span><br><span class="line">    <span class="comment">// RPC方式请求上报agent信息</span></span><br><span class="line">    <span class="comment">// g.HbsClient 为之前g.InitRpcClient()中初始化变量，var HbsClient *SingleConnRpcClient</span></span><br><span class="line">    <span class="comment">// Call()为结构体SingleConnRpcClient方法</span></span><br><span class="line">    <span class="comment">// func (this *SingleConnRpcClient) Call(method string, args interface&#123;&#125;, reply interface&#123;&#125;) error &#123;...&#125;</span></span><br><span class="line">    err = g.HbsClient.Call(<span class="string">"Agent.ReportStatus"</span>, req, &amp;resp)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> || resp.Code != <span class="number">0</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"call Agent.ReportStatus fail:"</span>, err, <span class="string">"Request:"</span>, req, <span class="string">"Response:"</span>, resp)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="cron-SyncMinePlugins"><a href="#cron-SyncMinePlugins" class="headerlink" title="cron.SyncMinePlugins()"></a><strong>cron.SyncMinePlugins()</strong></h4><p>每隔<code>Heartbeat.Interval</code>秒以RPC方式向HBS请求并同步plugin信息，执行删除无用plugin，添加新plugin等同步操作。所有plugin信息都存储在packae级变量<code>Plugins</code>(<code>map[string]*Plugin</code>)中</p>
<p>请求体为<code>model.AgentHeartbeatRequest</code>结构体，响应体为<code>model.AgentPluginsResponse</code>结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// open-falcon/falcon-plus/common/model/agent.go</span></span><br><span class="line"><span class="comment">// 请求体数据结构</span></span><br><span class="line"><span class="keyword">type</span> AgentHeartbeatRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    Hostname <span class="typename">string</span>	<span class="comment">// agent主机名</span></span><br><span class="line">    Checksum <span class="typename">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应体数据结构</span></span><br><span class="line"><span class="keyword">type</span> AgentPluginsResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">    Plugins   []<span class="typename">string</span></span><br><span class="line">    Timestamp <span class="typename">int64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个Plugin数据结构</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">struct</span> &#123;</span><br><span class="line">    FilePath <span class="typename">string</span></span><br><span class="line">    MTime    <span class="typename">int64</span></span><br><span class="line">    Cycle    <span class="typename">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cron-SyncBuiltinMetrics"><a href="#cron-SyncBuiltinMetrics" class="headerlink" title="cron.SyncBuiltinMetrics()"></a><strong>cron.SyncBuiltinMetrics()</strong></h4><p>每隔<code>Heartbeat.Interval</code>秒以RPC方式<code>g.HbsClient.Call(&quot;Agent.BuiltinMetrics&quot;, req, &amp;resp)</code>周期性从HBS同步监控端口、URL、进程及du路径信息到agent</p>
<h4 id="cron-SyncTrustableIps"><a href="#cron-SyncTrustableIps" class="headerlink" title="cron.SyncTrustableIps()"></a><strong>cron.SyncTrustableIps()</strong></h4><p>每隔<code>Heartbeat.Interval</code>秒以RPC方式<code>g.HbsClient.Call(&quot;Agent.TrustableIps&quot;, model.NullRpcRequest{}, &amp;ips)</code>周期性从HBS同步信任IP列表到agent</p>
<h4 id="cron-Collect"><a href="#cron-Collect" class="headerlink" title="cron.Collect()"></a><strong>cron.Collect()</strong></h4><p>每隔<code>Transfer.Interval</code>秒间隔执行由<code>funcs.BuildMappers()</code>构建<code>Mappers</code>变量中的所有采集函数<code>Fs</code>，先获得监控项目的值，并为每个监控项数据(<code>MetricValue</code>)加上<code>Step</code>、<code>Endpoint</code>(<code>hostname</code>)和<code>Timestamp</code>(<code>time.Now().Unix()</code>)。最后调用<code>g.SendToTransfer()</code>将所有监控数据上传到Transfer</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> Collect() &#123;</span><br><span class="line">	...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> funcs.Mappers &#123;</span><br><span class="line">        <span class="keyword">go</span> collect(<span class="typename">int64</span>(v.Interval), v.Fs)		<span class="comment">// 创建一个goroutine执行指标采集函数(`funcs.BuildMappers()`)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> collect(sec <span class="typename">int64</span>, fns []<span class="keyword">func</span>() []*model.MetricValue) &#123;</span><br><span class="line">    t := time.NewTicker(time.Second * time.Duration(sec))	<span class="comment">// 每隔sec秒(v.Interval)执行采集函数并上报transfer</span></span><br><span class="line">    <span class="keyword">defer</span> t.Stop()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        &lt;-t.C</span><br><span class="line"></span><br><span class="line">        hostname, err := g.Hostname()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mvs := []*model.MetricValue&#123;&#125;	<span class="comment">// 最终存储metric指标的slice</span></span><br><span class="line">        ignoreMetrics := g.Config().IgnoreMetrics</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, fn := <span class="keyword">range</span> fns &#123;	<span class="comment">// 迭代所有采集函数，汇总所有指标到mvs</span></span><br><span class="line">            items := fn()	<span class="comment">// 执行指标采集函数，获得指标</span></span><br><span class="line">            <span class="keyword">if</span> items == <span class="constant">nil</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(items) == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> _, mv := <span class="keyword">range</span> items &#123;	<span class="comment">//检测指标，若没被忽略，则汇总到mvs中</span></span><br><span class="line">                <span class="keyword">if</span> b, ok := ignoreMetrics[mv.Metric]; ok &amp;&amp; b &#123;</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mvs = <span class="built_in">append</span>(mvs, mv)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        now := time.Now().Unix()</span><br><span class="line">        <span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="built_in">len</span>(mvs); j++ &#123;		<span class="comment">// 为每个metric设置Step、Endpoint和Timestamp</span></span><br><span class="line">            mvs[j].Step = sec</span><br><span class="line">            mvs[j].Endpoint = hostname</span><br><span class="line">            mvs[j].Timestamp = now</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        g.SendToTransfer(mvs)	<span class="comment">// 将所有指标上报到Transfer</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="API-amp-Dashboard"><a href="#API-amp-Dashboard" class="headerlink" title="API &amp; Dashboard"></a><strong>API &amp; Dashboard</strong></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> http.Start()</span><br></pre></td></tr></table></figure>
<p>监听端口、启动API服务和Dashboard服务</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http/http.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载路由函数</span></span><br><span class="line"><span class="keyword">func</span> init() &#123;</span><br><span class="line">    configAdminRoutes()</span><br><span class="line">    configCpuRoutes()</span><br><span class="line">    configDfRoutes()</span><br><span class="line">    configHealthRoutes()</span><br><span class="line">    configIoStatRoutes()</span><br><span class="line">    configKernelRoutes()</span><br><span class="line">    configMemoryRoutes()</span><br><span class="line">    configPageRoutes()</span><br><span class="line">    configPluginRoutes()</span><br><span class="line">    configPushRoutes()</span><br><span class="line">    configRunRoutes()</span><br><span class="line">    configSystemRoutes()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> Start() &#123;</span><br><span class="line">    <span class="keyword">if</span> !g.Config().Http.Enabled &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addr := g.Config().Http.Listen</span><br><span class="line">    <span class="keyword">if</span> addr == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    s := &amp;http.Server&#123;	<span class="comment">// 设置监听端口</span></span><br><span class="line">        Addr:           addr,</span><br><span class="line">        MaxHeaderBytes: <span class="number">1</span> &lt;&lt; <span class="number">30</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">"listening"</span>, addr)</span><br><span class="line">    log.Fatalln(s.ListenAndServe())		<span class="comment">// 启动http服务</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/Go/">Go</a>

					</div>

				

			</article>

			<div class="content-nav">

				
					<a href="/2019/06/28/golang-rpc/" title="Golang RPC">&larr; Prev</a>
				

				
					<a href="/2019/05/23/Open-Falcon/" title="Open-Falcon源码阅读-概述">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
