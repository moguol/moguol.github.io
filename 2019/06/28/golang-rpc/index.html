<!DOCTYPE html>
<html lang="zh-Hant-TW">

	

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title> 墨 痕 </title>
	<meta property="og:title" content=" Golang RPC | Hexo " />
	<meta name="twitter:title" content=" Golang RPC | Hexo ">

	<meta property="og:type" content="article">
	<meta name="twitter:card" content="summary">

	<meta name="description" content=" Golang RPC | Hexo ">
	<meta property="og:description" content=" Golang RPC | Hexo " />
	<meta name="twitter:description" content=" Golang RPC | Hexo " />

	<link rel="icon" type="image/x-icon" href="http://yoursite.com/asset/img/favicon.png">

	<link rel="image_src" href="http://yoursite.com/asset/img/logo.png" >
	<meta property="og:image" content="http://yoursite.com/asset/img/logo.png" />

	
	<link href="http://yoursite.com/atom.xml" title="Hexo" type="application/atom+xml" rel="alternative">
	

	<link rel="canonical" href="/2019/06/28/golang-rpc/index.html">

	<link rel="stylesheet" href="/asset/css/main.css">

</head>


<body>

	
	<header class="site-header">

		
		<nav class="nav-page">

			<div class="row">

				<ul>

					

					<li><a href="/">Home</a></li>

					

					<li><a href="/archives">Sitemap</a></li>

					

					<li><a href="/atom.xml">Rss</a></li>

					

				</ul>

			</div>

		</nav>


		<div class="site-header-main">

			<div class="row">

				<h1><a href="/">墨 痕</a></h1>
				<h6><a href="/">fatesai#gmail.com</a></h6>

				

			</div>

		</div>

		


		<nav class="nav-cat">

			<div class="row">

				<ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPS/">OPS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TCP-IP/">TCP/IP</a></li></ul>

			</div>

		</nav>




	</header>


	<div id="content" class="site-content">

		
		<div class="row content-post">
			<article itemscope itemtype="http://schema.org/Article">

				

				

				<p class="content-meta">
					<span class="meta-date" itemprop="datePublished" content="2019-06-28">2019-06-28</span>

					
					  <span class="meta-cat">
						<a class="category-link" href="/categories/Golang/">Golang</a>
					  </span>
					
				</p>

				

					<h2 class="content-title">
						<a href="/2019/06/28/golang-rpc/" itemprop="url"><span itemprop="name">Golang RPC</span></a>
					</h2>

				


				<div class="content" itemprop="articleBody">
                    <!-- Table of Contents -->
                    
                    <div id="toc" class="toc-article">
                        <strong class="toc-title">目录</strong>
                        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#jsonrpc"><span class="toc-number">1.</span> <span class="toc-text">jsonrpc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#目录结构"><span class="toc-number">1.1.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求响应参数结构体"><span class="toc-number">1.2.</span> <span class="toc-text">请求响应参数结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC-Server端"><span class="toc-number">1.3.</span> <span class="toc-text">RPC Server端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Server端RPC方法"><span class="toc-number">1.3.1.</span> <span class="toc-text">Server端RPC方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建RPC-Server服务"><span class="toc-number">1.3.2.</span> <span class="toc-text">创建RPC Server服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC-Client端"><span class="toc-number">1.4.</span> <span class="toc-text">RPC Client端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#建立连接-amp-远程调用"><span class="toc-number">1.4.1.</span> <span class="toc-text">建立连接 & 远程调用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jsonrpc-调用"><span class="toc-number">1.5.</span> <span class="toc-text">jsonrpc 调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC"><span class="toc-number">2.</span> <span class="toc-text">gRPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.1.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Install-Go"><span class="toc-number">2.1.1.</span> <span class="toc-text">Install Go</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Install-Protocol-Buffers-v3"><span class="toc-number">2.1.2.</span> <span class="toc-text">Install Protocol Buffers v3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Install-protoc"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">Install protoc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Install-proctoc-gen-go"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">Install proctoc-gen-go</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Install-gRPC"><span class="toc-number">2.1.3.</span> <span class="toc-text">Install gRPC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#目录结构-1"><span class="toc-number">2.2.</span> <span class="toc-text">目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义protobuf文件"><span class="toc-number">2.3.</span> <span class="toc-text">定义protobuf文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端"><span class="toc-number">2.4.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端"><span class="toc-number">2.5.</span> <span class="toc-text">客户端</span></a></li></ol></li></ol>
                    </div>
                    

					<p><strong>RPC</strong>(Remote Procedure Call)，远程调用。RPC消息传输可通过TCP、HTTP和UDP等。<br>Golang中实现RPC有多种方式：</p>
<ul>
<li><strong><code>net/rpc</code></strong>: 官方RPC库，支持TCP和HTTP方式传输，使用<code>gob</code>编解码(导致无法跨语言调用)</li>
<li><strong><code>net/rpc/jsonrpc</code></strong>: 官方RPC库，仅支持TCP传输，使用<code>json</code>编解码(可跨语言调用)</li>
<li><strong><code>gRPC</code></strong>: Google开源RPC库，基于HTTP/2传输，使用<code>ProtoBuf</code>编解码</li>
</ul>
<p>当然除上面3种外还是许多RPC库，目前有所接触的是<code>net/rpc/jsonrpc</code>、<code>gRPC</code>，主要记录这2种，后续若有接触其他实现方式会持续更新。</p>
<h2 id="jsonrpc"><a href="#jsonrpc" class="headerlink" title="jsonrpc"></a><strong>jsonrpc</strong></h2><p>使用<code>net/rpc/jsonrpc</code>库，想要方法能被远程访问，需要满足以下条件：<br>可输出在Golang中即首字母大写</p>
<ol>
<li>方法的类型可输出 (the method’s type is exported) <code>*T</code></li>
<li>方法可输出 （the method is exported）<code>MethodName</code></li>
<li>方法必须有两个参数，且必须是输出类型或者是内建类型 (the method has two arguments, both exported or builtin types)  <code>T1</code> <code>*T2</code></li>
<li>方法的第二个参数是指针类型 (the method’s second argument is a pointer)   <code>*T2</code></li>
<li>方法返回类型为 error (the method has return type error)  <code>error</code></li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (t *T) MethodName(argType T1, replyType *T2) error</span><br></pre></td></tr></table></figure>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a><strong>目录结构</strong></h3><p>演示实例目录结构<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── client  // client rpc封装调用方法</span><br><span class="line">│   └── rpc.go</span><br><span class="line">├── common  // 公共结构体</span><br><span class="line">│   └── rpc.go</span><br><span class="line">├── jsonrpcClient.go</span><br><span class="line">├── jsonrpcServer.go</span><br><span class="line">└── server  // server rpc封装方法</span><br><span class="line">    ├── agent.go</span><br><span class="line">    └── rpc.go</span><br></pre></td></tr></table></figure></p>
<h3 id="请求响应参数结构体"><a href="#请求响应参数结构体" class="headerlink" title="请求响应参数结构体"></a><strong>请求响应参数结构体</strong></h3><p>定义请求参数、响应参数的结构体，client和server都需要使用<br><code>common/rpc.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common</span><br><span class="line"></span><br><span class="line"><span class="comment">// RPC请求参数</span></span><br><span class="line"><span class="keyword">type</span> AgentReportRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    Hostname <span class="typename">string</span> <span class="string">`json:"hostname"`</span></span><br><span class="line">    IP       <span class="typename">string</span> <span class="string">`json:"ip"`</span></span><br><span class="line">    Version  <span class="typename">string</span> <span class="string">`json:"version"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RPC响应参数</span></span><br><span class="line"><span class="comment">// code == 0 -&gt; success</span></span><br><span class="line"><span class="comment">// code == 1 -&gt; fail</span></span><br><span class="line"><span class="keyword">type</span> RpcResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">    Code <span class="typename">int</span>    <span class="string">`json:"code"`</span></span><br><span class="line">    Msg  <span class="typename">string</span> <span class="string">`json:"msg"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RPC-Server端"><a href="#RPC-Server端" class="headerlink" title="RPC Server端"></a><strong>RPC Server端</strong></h3><h4 id="Server端RPC方法"><a href="#Server端RPC方法" class="headerlink" title="Server端RPC方法"></a><strong>Server端RPC方法</strong></h4><p>Server端的RPC方法都需要符合之前提到的5个条件方可别远程调用，方法接收的请求参数和响应参数为之前预先定义好的<br><code>server/agent.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/mogl/jsonrpc/common"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Agent <span class="typename">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法需要满足之前提到的5个条件</span></span><br><span class="line"><span class="comment">// 从client传入的args中 获取请求参数，进行逻辑处理，并构造reply结构返回</span></span><br><span class="line"><span class="keyword">func</span> (ag *Agent) ReportStatus(args *common.AgentReportRequest, reply *common.RpcResponse) error &#123;</span><br><span class="line">    <span class="keyword">if</span> args.Hostname == <span class="string">""</span> &#123;</span><br><span class="line">        reply.Code = <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.Printf(<span class="string">"rpc server receive, hostname:%s, ip:%s, version:%s"</span>, args.Hostname, args.IP, args.Version)</span><br><span class="line">    reply.Code = <span class="number">0</span></span><br><span class="line">    reply.Msg = <span class="string">"call rpc server successfully."</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="constant">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建RPC-Server服务"><a href="#创建RPC-Server服务" class="headerlink" title="创建RPC Server服务"></a><strong>创建RPC Server服务</strong></h4><p>监听TCP端口、注册服务<br><code>server/rpc.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">    <span class="string">"net/rpc/jsonrpc"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建rpc server服务</span></span><br><span class="line"><span class="keyword">func</span> Start() &#123;</span><br><span class="line">    addr := <span class="string">":2333"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建server</span></span><br><span class="line">    server := rpc.NewServer()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册处理器</span></span><br><span class="line">    server.Register(<span class="built_in">new</span>(Agent)) <span class="comment">// server/agent.go</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听TCP端口</span></span><br><span class="line">    l, e := net.Listen(<span class="string">"tcp"</span>, addr)</span><br><span class="line">    <span class="keyword">if</span> e != <span class="constant">nil</span> &#123;</span><br><span class="line">        log.Fatalln(<span class="string">"listen error:"</span>, e)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.Println(<span class="string">"listerning"</span>, addr)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待请求、每个client请求新建goroutine处理</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        conn, err := l.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">            log.Fatalln(<span class="string">"listener accept fail:"</span>, err)</span><br><span class="line">            time.Sleep(time.Duration(<span class="number">100</span>) * time.Millisecond)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 绑定rpc的编码器</span></span><br><span class="line">        <span class="comment">// 新建jsonrpc编码器，并将该编码器绑定给http处理器</span></span><br><span class="line">        <span class="keyword">go</span> server.ServeCodec(jsonrpc.NewServerCodec(conn))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RPC-Client端"><a href="#RPC-Client端" class="headerlink" title="RPC Client端"></a><strong>RPC Client端</strong></h3><h4 id="建立连接-amp-远程调用"><a href="#建立连接-amp-远程调用" class="headerlink" title="建立连接 &amp; 远程调用"></a><strong>建立连接 &amp; 远程调用</strong></h4><p>在进行远程调用前，client需要先和server建立连接。同步方式使用<code>Call()</code>函数调用，异步方式使用<code>Go()</code>函数调用(异步调用需要使用channel取回返回数据，<code>Done</code>)<br><code>client/rpc.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"net/rpc"</span></span><br><span class="line">    <span class="string">"net/rpc/jsonrpc"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义client连接用的结构体</span></span><br><span class="line"><span class="keyword">type</span> ConnRpcClient <span class="keyword">struct</span> &#123;</span><br><span class="line">    sync.RWMutex</span><br><span class="line">    rpcClient *rpc.Client</span><br><span class="line">    RpcServer <span class="typename">string</span></span><br><span class="line">    Timeout   time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client和server建立连接</span></span><br><span class="line"><span class="keyword">func</span> (c *ConnRpcClient) rpcServerConn() error &#123;</span><br><span class="line">    <span class="keyword">if</span> c.rpcClient != <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重试次数</span></span><br><span class="line">    retry := <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> c.rpcClient != <span class="constant">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="constant">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TCP连接</span></span><br><span class="line">        conn, err := net.DialTimeout(<span class="string">"tcp"</span>, c.RpcServer, c.Timeout)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">            log.Printf(<span class="string">"dial %s fail: %v"</span>, c.RpcServer, err)</span><br><span class="line">            <span class="comment">// 最多尝试建立连接3次</span></span><br><span class="line">            <span class="keyword">if</span> retry &gt; <span class="number">3</span> &#123;</span><br><span class="line">                log.Printf(<span class="string">"dial %s fail(retry %d times): %v"</span>, c.RpcServer, retry, err)</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">            time.Sleep(time.Second &lt;&lt; <span class="typename">uint</span>(retry)) <span class="comment">// 指数退避重试</span></span><br><span class="line">            retry++</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c.rpcClient = jsonrpc.NewClient(conn) <span class="comment">// 基于TCP连接建立rpcClient实例</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// client调用server方法</span></span><br><span class="line"><span class="keyword">func</span> (c *ConnRpcClient) Call(method <span class="typename">string</span>, args <span class="keyword">interface</span>&#123;&#125;, reply <span class="keyword">interface</span>&#123;&#125;) error &#123;</span><br><span class="line">    <span class="comment">// 一个client实例如果要串行调用，同步阻塞，则加锁</span></span><br><span class="line">    <span class="comment">//c.Lock()</span></span><br><span class="line">    <span class="comment">//defer c.Unlock()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// client和server建立连接</span></span><br><span class="line">    err := c.rpcServerConn()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">"connect rpc server %s fail: %v"</span>, c.RpcServer, err)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 远程调用超时</span></span><br><span class="line">    timeout := time.Duration(<span class="number">15</span>) * time.Second</span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> error, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client远程调用方法</span></span><br><span class="line">    <span class="keyword">go</span> <span class="keyword">func</span>() &#123;</span><br><span class="line">        <span class="comment">// 同步方式调用</span></span><br><span class="line">        err := c.rpcClient.Call(method, args, reply)</span><br><span class="line">        done &lt;- err</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用超时机制</span></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(timeout):</span><br><span class="line">        log.Printf(<span class="string">"rpc call timeout: %s -&gt; %s"</span>, c.rpcClient, c.RpcServer)</span><br><span class="line">        c.rpcClient.Close()</span><br><span class="line">        <span class="keyword">return</span> fmt.Errorf(<span class="string">"rpc call timeout: %s -&gt; %s"</span>, c.rpcClient, c.RpcServer)</span><br><span class="line">    <span class="keyword">case</span> err := &lt;-done:</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">            c.rpcClient.Close()</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="constant">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jsonrpc-调用"><a href="#jsonrpc-调用" class="headerlink" title="jsonrpc 调用"></a><strong>jsonrpc 调用</strong></h3><p><code>jsonrpcServer.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/mogl/jsonrpc/server"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="keyword">go</span> server.Start()   <span class="comment">// 创建jsonrpc server服务</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>jsonrpcClient.go</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"github.com/mogl/jsonrpc/client"</span></span><br><span class="line">    <span class="string">"github.com/mogl/jsonrpc/common"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="comment">// 请求参数</span></span><br><span class="line">    req := &amp;common.AgentReportRequest&#123;</span><br><span class="line">        Hostname: <span class="string">"sai"</span>,</span><br><span class="line">        IP:       <span class="string">"localhost"</span>,</span><br><span class="line">        Version:  <span class="string">"1.0"</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应参数</span></span><br><span class="line">    resp := &amp;common.RpcResponse&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// client实例</span></span><br><span class="line">    rpcClient := client.ConnRpcClient&#123;</span><br><span class="line">        RpcServer: <span class="string">":2333"</span>,</span><br><span class="line">        Timeout:   time.Duration(<span class="number">10</span>) * time.Second,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Duration(<span class="number">3</span> * time.Second))</span><br><span class="line">    rpcClient.Call(<span class="string">"Agent.ReportStatus"</span>, req, resp)     <span class="comment">// jsonrpc 调用</span></span><br><span class="line"></span><br><span class="line">    log.Println(<span class="string">"response code:"</span>, resp.Code)</span><br><span class="line">    log.Println(<span class="string">"response msg:"</span>, resp.Msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a><strong>gRPC</strong></h2><p>  gRPC 默认使用 <em>protocol buffers</em>，这是 Google 开源的一套成熟的结构数据序列化机制。用 <em>proto files</em> 创建 gRPC 服务，用 protocol buffers 消息类型来定义方法参数和返回类型。你可以在 <a href="http://grpc.mydoc.io/https%EF%BC%9A//developers.google.com/protocol-buffers/docs/overview" target="_blank" rel="external">Protocol Buffers 文档</a>找到更多关于 Protocol Buffers 的资料。<br>  在使用gRPC前需要进行一些比较麻烦的安装</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><h4 id="Install-Go"><a href="#Install-Go" class="headerlink" title="Install Go"></a><strong>Install Go</strong></h4><p>Go version &gt;= 1.6</p>
<h4 id="Install-Protocol-Buffers-v3"><a href="#Install-Protocol-Buffers-v3" class="headerlink" title="Install Protocol Buffers v3"></a><strong>Install Protocol Buffers v3</strong></h4><h5 id="Install-protoc"><a href="#Install-protoc" class="headerlink" title="Install protoc"></a><strong>Install protoc</strong></h5><p><a href="https://github.com/google/protobuf/releases" target="_blank" rel="external">protoc-[version]-[platform].zip</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip protoc-<span class="number">3.7</span>.<span class="number">1</span>-linux-x86_64.zip <span class="operator">-d</span> /usr/<span class="built_in">local</span>/protoc/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'PATH=/usr/local/protoc/bin:$PATH'</span> &gt;&gt; /etc/profile &amp;&amp; <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<h5 id="Install-proctoc-gen-go"><a href="#Install-proctoc-gen-go" class="headerlink" title="Install proctoc-gen-go"></a><strong>Install proctoc-gen-go</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>
<h4 id="Install-gRPC"><a href="#Install-gRPC" class="headerlink" title="Install gRPC"></a><strong>Install gRPC</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fail</span></span><br><span class="line">go get -u google.golang.org/grpc</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/grpc/grpc-go.git <span class="variable">$GOPATH</span>/src/google.golang.org/grpc</span><br><span class="line"><span class="comment">#git clone https://github.com/golang/net.git $GOPATH/src/golang.org/x/net</span></span><br><span class="line"><span class="comment">#git clone https://github.com/golang/text.git $GOPATH/src/golang.org/x/text</span></span><br><span class="line"><span class="comment">#git clone https://github.com/golang/sys.git $GOPATH/src/golang.org/x/sys</span></span><br><span class="line"><span class="comment">#go get -u github.com/golang/protobuf/&#123;proto,protoc-gen-go&#125;</span></span><br><span class="line"><span class="comment">#git clone https://github.com/google/go-genproto.git $GOPATH/src/google.golang.org/genproto</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/</span><br><span class="line">go install google.golang.org/grpc</span><br></pre></td></tr></table></figure>
<h3 id="目录结构-1"><a href="#目录结构-1" class="headerlink" title="目录结构"></a><strong>目录结构</strong></h3><p>演示实例目录结构<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── helloworld</span><br><span class="line">    ├── client</span><br><span class="line">    │   └── main.go</span><br><span class="line">    ├── protos</span><br><span class="line">    │   ├── helloworld.pb.go</span><br><span class="line">    │   └── helloworld.proto</span><br><span class="line">    └── server</span><br><span class="line">        └── main.go</span><br></pre></td></tr></table></figure></p>
<h3 id="定义protobuf文件"><a href="#定义protobuf文件" class="headerlink" title="定义protobuf文件"></a><strong>定义protobuf文件</strong></h3><p>gRPC能定义4种类型服务方法</p>
<ul>
<li><p><strong>单项 RPC</strong>: 客户端发送一个请求给服务端，从服务端获取一个应答，就像一次普通的函数调用</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">serviceName</span> </span>&#123;</span><br><span class="line"> 	<span class="function"><span class="keyword">rpc</span> SayHello(HelloRequest) <span class="keyword">returns</span> (HelloResponse)&#123;&#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>服务端流式 RPC</strong>: 客户端发送一个请求给服务端，可获取一个数据流用来读取一系列消息。客户端从返回的数据流里一直读取直到没有更多消息为止。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">serviceName</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> LotsOfReplies(HelloRequest) <span class="keyword">returns</span> (stream HelloResponse)&#123;&#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>客户端流式 RPC</strong>: 客户端用提供的一个数据流写入并发送一系列消息给服务端。一旦客户端完成消息写入，就等待服务端读取这些消息并返回应答。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">serviceName</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> LotsOfGreetings(stream HelloRequest) <span class="keyword">returns</span> (HelloResponse) &#123;&#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>双向流式 RPC</strong>: 两边都可以分别通过一个读写数据流来发送一系列消息。这两个数据流操作是相互独立的，所以客户端和服务端能按其希望的任意顺序读写。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">serviceName</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> BidiHello(stream HelloRequest) <span class="keyword">returns</span> (stream HelloResponse)&#123;&#125;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>protobuf3的消息类型定义规则，详细protobuf3语法参见: <a href="https://colobu.com/2017/03/16/Protobuf3-language-guide/" target="_blank" rel="external">Protobuf3 语法指南</a><br><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> &lt;<span class="title">MessageName</span>&gt; </span>&#123;</span><br><span class="line">    &lt;FieldType&gt; &lt;FieldName&gt; = &lt;UniqueNumber&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>protobuf 文件编写</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协议版本</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> helloworld;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义服务及方法</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义SayHello方法, 接收HelloRequest参数, 返回HelloReply</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 定义传入参数</span><br><span class="line">message HelloRequest &#123;</span><br><span class="line">    string name = 1</span>;    <span class="comment">// 1 是每个字段的唯一标识符，新增一个字段则递增</span></span><br><span class="line">    <span class="comment">// int32 age = 2;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义返回参数</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloReply</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将protobuf文件编译成Go文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pwd: helloworld</span></span><br><span class="line">protoc -I protos protos/helloworld.proto --go_out=plugins=grpc:./protos/</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwd helloworld/protos</span></span><br><span class="line"><span class="comment">#protoc --go_out=plugins=grpc:. helloworld.proto</span></span><br></pre></td></tr></table></figure>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a><strong>服务端</strong></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"net"</span></span><br><span class="line"></span><br><span class="line">        pb <span class="string">"github.com/mogl/gRPC/helloworld/protos"</span></span><br><span class="line">        <span class="string">"golang.org/x/net/context"</span></span><br><span class="line">        <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">        <span class="comment">//"google.golang.org/grpc/reflection"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">        address = <span class="string">":50051"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义server结构体, 用于实现SayHello方法</span></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现SayHello方法</span></span><br><span class="line"><span class="keyword">func</span> (s *server) SayHello(ctx context.Context, req *pb.HelloRequest) (*pb.HelloReply, error) &#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;pb.HelloReply&#123;Msg: <span class="string">"Hello "</span> + req.Name&#125;, <span class="constant">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">        <span class="comment">// 监听TCP</span></span><br><span class="line">        listener, err := net.Listen(<span class="string">"tcp"</span>, address)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"listen %v failed."</span>, address)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// new rpc server</span></span><br><span class="line">        s := grpc.NewServer()</span><br><span class="line">        <span class="comment">// RegisterGreeterServer(), proto文件定义Greeter服务, protoc自动生成</span></span><br><span class="line">        pb.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Serve接收来自listener的连接，为每个连接创建ServerTransport和service goroutine处理连接请求</span></span><br><span class="line">        <span class="keyword">if</span> err := s.Serve(listener); err != <span class="constant">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"Failed to server: %v"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a><strong>客户端</strong></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">        pb <span class="string">"github.com/mogl/gRPC/helloworld/protos"</span></span><br><span class="line">        <span class="string">"golang.org/x/net/context"</span></span><br><span class="line">        <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">        address     = <span class="string">"localhost:50051"</span></span><br><span class="line">        defaultName = <span class="string">"World"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">        <span class="comment">// 与server建立连接</span></span><br><span class="line">        conn, err := grpc.Dial(address, grpc.WithInsecure())</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"can't connect to the server: %v"</span>, address)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// new client</span></span><br><span class="line">        client := pb.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">        name := defaultName</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</span><br><span class="line">                name = os.Args[<span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 连接server调用SayHello()函数</span></span><br><span class="line">        resp, err := client.SayHello(context.Background(), &amp;pb.HelloRequest&#123;Name: name&#125;)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"client call SayHello() failed: %v"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.Printf(<span class="string">"server response: %v"</span>, resp.Msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>

				

					<div class="content-tag">

						 <a class="tag-link" href="/tags/Go/">Go</a>

					</div>

				

			</article>

			<div class="content-nav">

				

				
					<a href="/2019/06/05/Open-Falcon-agent/" title="Open-Falcon源码阅读-Agent">Next &rarr;</a>
				

			</div>

		</div>


	</div>

	<div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>

	<!-- <div class="row">
	<p class="theme">Powered: <a href="http://hexo.io/"  target="_blank">Hexo</a>, Theme: <a href="https://github.com/samwhelp/hexo-theme-nadya" target="_blank">Nadya</a> remastered from <a href="https://github.com/nadymain/hexo-theme-nadymain" target="_blank">NadyMain</a></p>
</div>
 -->

</body>
</html>
